<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpsEdge&trade; | Industrial Operations Intelligence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    
    <style>
        :root {
            --sidebar-width: 260px;
            --primary: #0f172a;
            --secondary: #334155;
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --bg-light: #f8fafc;
            --card-border: #e2e8f0;
            --text-primary: #1e293b;
            --gradient-accent: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-primary);
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Modern Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: #0f172a; /* Solid dark slate, no gradient */
            color: #94a3b8;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1rem;
            border-right: 1px solid #1e293b;
            z-index: 10;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 0.5rem;
            letter-spacing: -0.02em;
        }

        .brand i { 
            color: var(--accent);
            font-size: 1.4rem;
        }

        .nav-section {
            margin-bottom: 1rem;
        }

        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            margin-bottom: 0.75rem;
            font-weight: 700;
            padding-left: 0.75rem;
        }

        .nav-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            color: #94a3b8;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            color: white;
            background: rgba(255,255,255,0.05);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
            font-weight: 600;
        }

        .nav-item .badge {
            margin-left: auto;
            background: rgba(255,255,255,0.15);
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Context Switcher - Clean & Minimal */
        .context-switcher {
            background: #1e293b;
            padding: 4px; /* Pill shape container */
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            border: 1px solid #334155;
        }

        .btn-context {
            flex: 1;
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-context:hover { color: white; }

        .btn-context.active {
            background: #334155;
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .site-info {
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid #1e293b;
        }

        .site-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #cbd5e1;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 2rem 2rem 2rem;
            background: var(--bg-light);
            scroll-behavior: smooth;
            /* Soft ambient background */
             background-image: 
                radial-gradient(at 100% 0%, rgba(37,99,235,0.03) 0px, transparent 50%),
                radial-gradient(at 0% 0%, rgba(16,185,129,0.03) 0px, transparent 50%);
        }

        /* Feature Matrix Proposal Styles */
        .feature-matrix {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .feature-matrix thead th {
            background-color: #2563eb; /* Royal Blue Header */
            color: white;
            font-weight: 600;
            text-align: left;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .feature-matrix tbody tr {
            transition: background-color 0.2s;
        }

        .feature-matrix tbody tr:hover {
            background-color: #f8fafc;
        }

        .feature-matrix td {
            padding: 1.5rem;
            border-bottom: 1px solid var(--card-border);
            vertical-align: top;
            color: #334155;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .feature-matrix tbody tr:last-child td {
            border-bottom: none;
        }

        .matrix-tier {
            font-weight: 700;
            color: #1e293b;
            font-size: 1rem;
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .matrix-sub {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .matrix-resource {
            color: #2563eb; /* Blue text */
            font-weight: 700;
            font-size: 0.95rem;
            text-align: center;
            display: block;
        }

        .matrix-resource-sub {
             display: block;
             text-align: center;
             font-size: 0.75rem;
             color: #64748b;
             font-weight: 500;
        }

        /* Unlock Details Box */
        .unlock-box {
            border: 1px dashed #cbd5e1;
            background: #f8fafc;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .unlock-input-group {
            display: flex;
            gap: 10px;
            max-width: 400px;
            width: 100%;
        }

        .unlock-input {
             flex: 1;
             border: 1px solid #cbd5e1;
             border-radius: 6px;
             padding: 8px 12px;
             outline: none;
        }
        
        .btn-unlock {
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 600;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid var(--card-border);
        }

        .page-header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .action-bar {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .time-display {
            font-size: 0.9rem;
            color: #64748b;
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }

        .card-custom {
            background: white;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid #e5e9f2;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.02);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            margin-bottom: 0;
            overflow: hidden;
        }

        .card-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
            background-size: 200% 100%;
            border-radius: 20px 20px 0 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .card-custom:hover {
            transform: translateY(-6px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 20px 25px -5px rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.2);
        }

        .card-custom:hover::before {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.01em;
        }

        .card-title i {
            color: var(--accent);
            font-size: 1.25rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 14px;
            padding: 1.25rem 1.5rem;
            border: 1px solid #e5e9f2;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.04), 0 4px 8px -2px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent) 0%, rgba(59, 130, 246, 0.3) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 4px 12px 0 rgba(59, 130, 246, 0.1), 0 8px 16px -4px rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            margin: 0.75rem 0;
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 0.5rem;
        }

        .kpi-trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kpi-trend.positive { color: var(--success); }
        .kpi-trend.negative { color: var(--danger); }
        .kpi-trend.neutral { color: var(--warning); }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .alert-card {
            background: white;
            border-left: 5px solid;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.25rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .alert-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 0;
            transition: width 0.3s ease;
            opacity: 0.05;
        }

        .alert-card:hover {
            transform: translateX(8px);
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.08);
        }

        .alert-critical { 
            border-left-color: var(--danger);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.02) 0%, white 100%);
        }
        .alert-critical::after { background: var(--danger); }
        .alert-critical:hover::after { width: 100%; }

        .alert-warning { 
            border-left-color: var(--warning);
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.02) 0%, white 100%);
        }
        .alert-warning::after { background: var(--warning); }
        .alert-warning:hover::after { width: 100%; }

        .alert-info { 
            border-left-color: var(--info);
            background: linear-gradient(90deg, rgba(14, 165, 233, 0.02) 0%, white 100%);
        }
        .alert-info::after { background: var(--info); }
        .alert-info:hover::after { width: 100%; }

        .alert-success { 
            border-left-color: var(--success);
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.02) 0%, white 100%);
        }
        .alert-success::after { background: var(--success); }
        .alert-success:hover::after { width: 100%; }

        .alert-severity {
            display: inline-flex;
            align-items: center;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.2s ease;
            height: 24px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .alert-severity::before {
            content: '';
            display: inline-block;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .alert-severity:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
        }

        .severity-critical { 
            background: #fee2e2; 
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .severity-critical::before { background: #dc2626; }

        .severity-high { 
            background: #ffedd5; 
            color: #9a3412;
            border: 1px solid #fed7aa;
        }
        .severity-high::before { background: #f59e0b; }

        .severity-medium { 
            background: #dbeafe; 
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .severity-medium::before { background: #3b82f6; }

        .severity-low { 
            background: #d1fae5; 
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .severity-low::before { background: #10b981; }

        /* Utility classes */
        .bg-soft-primary {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }

        .gantt-container {
            margin-top: 2rem;
        }

        .gantt-timeline {
            display: flex;
            gap: 1px;
            background: #e2e8f0;
            height: 40px;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .gantt-day {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            font-size: 0.8rem;
            font-weight: 600;
            color: #64748b;
        }

        .gantt-task {
            display: flex;
            align-items: center;
            margin: 1rem 0;
        }

        .task-label {
            width: 200px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .task-bar {
            flex: 1;
            height: 36px;
            background: #f1f5f9;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .task-progress {
            position: absolute;
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            transition: width 1s ease-in-out;
        }

        .algomind-panel {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .algomind-panel.open {
            opacity: 1;
            visibility: visible;
        }

        .algomind-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: modalIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .algomind-header {
            padding: 2rem;
            border-bottom: 1px solid var(--card-border);
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            border-radius: 16px 16px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .algomind-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .algomind-icon {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4), 0 4px 8px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }

        .algomind-icon:hover {
            transform: scale(1.05) rotate(-5deg);
            box-shadow: 0 12px 28px rgba(59, 130, 246, 0.5);
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.25rem;
            padding: 1.5rem;
        }

        .question-section {
            background: white;
            border-radius: 14px;
            padding: 1.5rem;
            border: 1px solid #e5e9f2;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 8px -2px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .question-section:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08), 0 2px 6px rgba(0, 0, 0, 0.04);
            border-color: rgba(59, 130, 246, 0.2);
        }

        .section-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3), 0 2px 4px rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }

        .question-section:hover .section-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        

        .question-item {
            padding: 1rem 1.25rem;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e9f2;
            font-size: 0.875rem;
            line-height: 1.6;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .question-item:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: var(--accent);
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .question-item:last-child {
            margin-bottom: 0;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 0.5rem;
        }

        .agent-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        .chat-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8fafc;
        }

        .msg {
            margin-bottom: 1rem;
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 0.9rem;
            line-height: 1.5;
            max-width: 85%;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInBackwards {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg.bot {
            background: white;
            border: 1px solid var(--card-border);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .msg.user {
            background: var(--gradient-accent);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .chat-input-area {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--card-border);
            background: white;
            border-radius: 0 0 16px 16px;
        }

        .powered-by {
            text-align: center;
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .powered-by strong {
            color: var(--accent);
            font-weight: 600;
        }

        .agent-toggle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 35px;
            background: var(--gradient-primary);
            color: #2563eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.3);
            z-index: 1001;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid #2563eb;
        }

        .agent-toggle-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 15px 40px rgba(15, 23, 42, 0.4);
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            background: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--card-border);
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--card-border);
            font-size: 0.9rem;
        }

        .view-section {
            animation: fadeIn 0.5s ease;
        }

        /* proposal page */
        .proposal-tier {
            background: white;
            border-radius: 20px;
            border: 1px solid #e5e9f2;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 8px 16px -4px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
            margin-bottom: 1.5rem;
        }

        .proposal-tier::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .proposal-tier:hover {
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 20px 32px -8px rgba(59, 130, 246, 0.15);
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .proposal-tier:hover::before {
            opacity: 1;
        }
        .tier-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .feature-list {
            list-style: none;
            padding-left: 0;
        }
        .feature-list li {
            padding: 10px 0;
            border-bottom: 1px dashed var(--card-border);
            display: flex;
            gap: 10px;
        }
        .feature-list li i {
            color: var(--success);
            width: 20px;
        }
        .resource-estimate {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
            font-weight: 700;
        }

        /* AI Workflow Styles */
        .workflow-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .workflow-step {
            opacity: 1;
            transition: all 0.5s ease;
            transform: translateY(0);
            filter: grayscale(70%) opacity(0.6);
            pointer-events: none;
        }

        .workflow-step.active {
            opacity: 1;
            transform: translateY(0);
            filter: none;
            pointer-events: auto;
            animation: stepActivate 0.5s ease;
        }

        @keyframes stepActivate {
            0% { transform: scale(0.98); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }

        .workflow-step.completed {
            opacity: 1;
            filter: grayscale(0%) opacity(0.9);
            pointer-events: auto;
        }

        .anomaly-alert {
            background: white;
            border: 1px solid #e5e9f2;
            border-radius: 20px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.02);
            margin-bottom: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .workflow-step.active .anomaly-alert {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12), 0 4px 12px rgba(59, 130, 246, 0.08);
        }

        .anomaly-alert:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12), 0 4px 12px rgba(59, 130, 246, 0.08);
        }

        .anomaly-alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
            background-size: 200% 100%;
            border-radius: 20px 20px 0 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .workflow-step.active .anomaly-alert::before,
        .anomaly-alert:hover::before {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        .multi-agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.25rem;
            margin: 1.25rem 0;
        }

        .agent-panel {
            background: white;
            border: 1px solid #e5e9f2;
            border-radius: 20px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.02);
            overflow: hidden;
        }

        .agent-panel.active {
            opacity: 1;
            transform: translateY(-6px);
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 20px 25px -5px rgba(59, 130, 246, 0.08);
        }

        .agent-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
            background-size: 200% 100%;
            border-radius: 20px 20px 0 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .agent-panel.active::before {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .agent-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .agent-panel.active .agent-icon {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        

        .agent-icon.pattern {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .agent-icon.causal {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .agent-icon.domain {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        }

        .agent-icon.simulation {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .agent-icon .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .agent-panel.active .agent-icon .spinner {
            display: block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .agent-content {
            min-height: 120px;
        }

        .agent-finding {
            font-size: 0.9rem;
            color: #334155;
            line-height: 1.7;
        }

        .agent-chart {
            margin-top: 0.75rem;
            height: 100px;
            background: #f8fafc;
            border-radius: 8px;
            display: flex;
            align-items: flex-end;
            padding: 0.5rem;
            gap: 4px;
        }

        .agent-chart-bar {
            flex: 1;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 4px 4px 0 0;
            transition: all 0.5s ease;
            opacity: 0;
        }

        .agent-panel.active .agent-chart-bar {
            opacity: 1;
        }

        .fault-tree-diagram {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .simulation-slider {
            margin: 1rem 0;
        }

        .simulation-slider label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .simulation-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .simulation-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .simulation-slider input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .root-cause-highlight {
            background: white;
            border: 1px solid #e5e9f2;
            border-radius: 20px;
            padding: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.02);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .root-cause-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
            background-size: 200% 100%;
            border-radius: 20px 20px 0 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .workflow-step.active .root-cause-highlight::before {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        .workflow-step.active .root-cause-highlight {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12), 0 4px 12px rgba(59, 130, 246, 0.08);
            transform: translateY(-4px);
        }

        .insights-card {
            background: white;
            border: 1px solid #e5e9f2;
            border-radius: 20px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.02);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .insights-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
            background-size: 200% 100%;
            border-radius: 20px 20px 0 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .workflow-step.active .insights-card::before {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        .workflow-step.active .insights-card {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12), 0 4px 12px rgba(59, 130, 246, 0.08);
            transform: translateY(-4px);
        }

        .insight-item {
            display: flex;
            gap: 1rem;
            padding: 1.25rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .insight-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .insight-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3), 0 1px 3px rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }

        .insight-item:hover .insight-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .impact-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.25rem;
            margin: 1.25rem 0;
        }

        .impact-kpi {
            background: white;
            border: 1px solid #e5e9f2;
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.02);
            position: relative;
            overflow: hidden;
        }

        .impact-kpi::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
            background-size: 200% 100%;
            border-radius: 20px 20px 0 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .impact-kpi:hover {
            transform: translateY(-6px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 20px 25px -5px rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .impact-kpi:hover::before {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        .impact-kpi.improved {
            animation: improveFlash 1.2s ease;
            border-color: rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2), 0 4px 12px rgba(16, 185, 129, 0.15);
        }

        @keyframes improveFlash {
            0% { transform: scale(1); }
            25% { transform: scale(1.05); box-shadow: 0 12px 32px rgba(16, 185, 129, 0.35), 0 6px 16px rgba(16, 185, 129, 0.25); }
            50% { transform: scale(1.08); box-shadow: 0 16px 40px rgba(16, 185, 129, 0.45), 0 8px 20px rgba(16, 185, 129, 0.30); }
            75% { transform: scale(1.05); box-shadow: 0 12px 32px rgba(16, 185, 129, 0.35), 0 6px 16px rgba(16, 185, 129, 0.25); }
            100% { transform: scale(1); box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2), 0 4px 12px rgba(16, 185, 129, 0.15); }
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .kpi-change {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .kpi-change.positive {
            color: #10b981;
        }

        .kpi-change.negative {
            color: #ef4444;
        }

        .knowledge-capture {
            background: white;
            border: 1px solid #e5e9f2;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.02);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .knowledge-capture::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
            background-size: 200% 100%;
            border-radius: 20px 20px 0 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .workflow-step.active .knowledge-capture::before {
            opacity: 1;
            animation: shimmer 2s ease-in-out infinite;
        }

        .workflow-step.active .knowledge-capture {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12), 0 4px 12px rgba(59, 130, 246, 0.08);
            transform: translateY(-4px);
        }

        .knowledge-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .knowledge-actions .btn {
            font-weight: 600;
            padding: 0.65rem 1.25rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .knowledge-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .workflow-progress {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 2rem 0 1.5rem 0;
            padding: 0 1rem;
        }

        .progress-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #cbd5e1;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid white;
            box-shadow: 0 0 0 2px #cbd5e1;
        }

        .progress-dot.active {
            background: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 0 12px rgba(59, 130, 246, 0.4);
        }

        .progress-dot.completed {
            background: var(--success);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
        }

        .progress-line {
            flex: 1;
            height: 3px;
            background: #e2e8f0;
            transition: all 0.4s ease;
            margin: 0 0.5rem;
        }

        .progress-line.completed {
            background: linear-gradient(90deg, var(--success), #34d399);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed rgba(203, 213, 225, 0.6);
            border-radius: 14px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.12);
        }

        .upload-area:hover::before {
            width: 300px;
            height: 300px;
        }

        /* Anomaly Feed */
        .anomaly-item {
            border: 1px solid #e5e9f2;
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 0.875rem;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 2px 6px -1px rgba(0, 0, 0, 0.02);
            position: relative;
            overflow: hidden;
        }

        .anomaly-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 0;
            transition: width 0.3s ease;
        }

        .anomaly-item:hover {
            transform: translateY(-4px) translateX(4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.06);
            border-color: var(--accent);
        }

        .anomaly-item.critical {
            border-left: 5px solid #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.03) 0%, white 100%);
        }
        .anomaly-item.critical::after {
            background: rgba(239, 68, 68, 0.05);
        }
        .anomaly-item.critical:hover::after {
            width: 100%;
        }

        .anomaly-item.high {
            border-left: 5px solid #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.03) 0%, white 100%);
        }
        .anomaly-item.high::after {
            background: rgba(245, 158, 11, 0.05);
        }
        .anomaly-item.high:hover::after {
            width: 100%;
        }

        .anomaly-item.medium {
            border-left: 5px solid #3b82f6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.03) 0%, white 100%);
        }
        .anomaly-item.medium::after {
            background: rgba(59, 130, 246, 0.05);
        }
        .anomaly-item.medium:hover::after {
            width: 100%;
        }

        .anomaly-badge {
            font-size: 0.7rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .anomaly-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .no-anomalies {
            text-align: center;
            padding: 3rem 1rem;
            color: #94a3b8;
        }

        .no-anomalies i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Interactive cursor styles */
        .cursor-pointer {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cursor-pointer:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Live data indicator */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--success);
        }

        .live-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Planning tab styles */
        .planning-tab-content {
            animation: fadeIn 0.3s ease;
        }
        
        .planning-tab-content.d-none {
            display: none !important;
        }
        
        .planning-tab-content .card-custom.mb-3 {
            height: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .algomind-modal {
                width: 95%;
                max-height: 95vh;
            }
            .section-grid {
                grid-template-columns: 1fr;
            }
            .multi-agent-grid {
                grid-template-columns: 1fr;
            }
            .impact-kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
                padding: 1rem;
            }
            .brand span, .nav-section-title, .nav-item span, .context-switcher span {
                display: none;
            }
            .main-content {
                padding: 1rem;
            }
            .card-custom {
                padding: 1.25rem;
                margin-bottom: 1rem;
            }
            .kpi-card {
                padding: 1rem 1.25rem;
            }
            .alert-card {
                padding: 0.875rem 1rem;
            }
            .agent-panel {
                padding: 1.25rem;
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- Sidebar with enhanced context switcher -->
    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-layer-group"></i>
            <span>OpsEdge&trade;</span>
        </div>

        <!-- Improved context switcher: dual buttons -->
        <!-- Compact Context Switcher -->
        <div class="context-switcher">
            <button id="ctxNitrogen" class="btn-context active" onclick="switchContext('nitrogen')">
                <i class="fas fa-industry"></i> <span>Nitrogen</span>
            </button>
            <button id="ctxPotash" class="btn-context" onclick="switchContext('potash')">
                <i class="fas fa-hard-hat"></i> <span>Potash</span>
            </button>
            <span id="contextBadge" style="display:none">Nitrogen</span>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">OPERATIONS INTELLIGENCE</div>
            <div class="nav-item active" onclick="navigate('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span>Predictive Maintenance</span>
                <span class="badge">Live</span>
            </div>
            <div class="nav-item" onclick="navigate('causal')">
                <i class="fas fa-project-diagram"></i>
                <span>Root Cause AI</span>
                <span class="badge" id="causalAlertBadge">3 Alerts</span>
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">PLANNING & COMPLIANCE</div>
            <div class="nav-item" onclick="navigate('planning')">
                <i class="fas fa-chart-line"></i>
                <span>Planning & Optimization</span>
                <span class="badge" id="planningBadge">Q4 2026</span>
            </div>
            <div class="nav-item" onclick="navigate('carbon')">
                <i class="fas fa-leaf"></i>
                <span>Carbon & Sustainability</span>
            </div>
            <div class="nav-item" onclick="navigate('safety')">
                <i class="fas fa-shield-alt"></i>
                <span>Safety & Compliance</span>
                <span class="badge" id="safetyBadge">100%</span>
            </div>
        </div>

        <!-- STRATEGIC -->
        <div class="nav-section">
            <div class="nav-section-title">STRATEGIC</div>
            <div class="nav-item" onclick="navigate('proposal')">
                <i class="fas fa-handshake"></i>
                <span>Partnership Proposal</span>
            </div>
        </div>

        <!-- SYSTEM CONFIGURATION -->
        <div class="nav-section">
            <div class="nav-section-title">SYSTEM</div>
            <div class="nav-item" onclick="navigate('settings')">
                <i class="fas fa-cog"></i>
                <span>Configuration</span>
            </div>
        </div>

        <div class="site-info">
            <div class="site-status">
                <div class="status-indicator"></div>
                <span>All Systems Operational</span>
            </div>
            <div style="font-size: 0.8rem; color: #94a3b8;">
                Last updated: <span id="lastUpdated">Just now</span>
            </div>
            <div style="font-size: 0.75rem; color: #64748b; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #1e293b;">
                Powered by <strong>AlgoMind</strong><br>
                &copy; 2026 Algo-Rythmn.ai
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContainer">
        <div class="header">
            <div class="page-header">
                <h1 id="pageTitle">Nitrogen Production Operations</h1>
            </div>
            <div class="action-bar">
                <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshDashboardData()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div class="time-display">
                    <i class="fas fa-clock me-2"></i>
                    <span id="currentTime">Loading...</span>
                </div>
            </div>
        </div>

        <!-- DASHBOARD VIEW (enriched) -->
        <div id="view-dashboard" class="view-section">
            <div class="row g-4 mb-4">
                <div class="col-xl-3 col-lg-6">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-industry"></i>
                                <span id="kpi1Title">Plant Availability</span>
                            </div>
                            <div class="kpi-trend positive" id="kpi1Trend">
                                <i class="fas fa-arrow-up"></i> 2.3%
                            </div>
                        </div>
                        <div class="kpi-value" id="kpi1Value">98.7%</div>
                        <div class="kpi-label" id="kpi1Label">Last 30 Days | Target: 97.5%</div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-leaf"></i>
                                <span id="kpi2Title">Carbon Efficiency</span>
                            </div>
                            <div class="kpi-trend negative" id="kpi2Trend">
                                <i class="fas fa-arrow-down"></i> 0.5%
                            </div>
                        </div>
                        <div class="kpi-value" id="kpi2Value">92.4%</div>
                        <div class="kpi-label" id="kpi2Label">Capture Rate | Target: 94.0%</div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-shield-alt"></i>
                                <span id="kpi3Title">Safety Performance</span>
                            </div>
                            <div class="kpi-trend positive" id="kpi3Trend">
                                <i class="fas fa-check-circle"></i> Safe
                            </div>
                        </div>
                        <div class="kpi-value" id="kpi3Value">0</div>
                        <div class="kpi-label" id="kpi3Label">Incidents YTD | 156 Days Safe</div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-wrench"></i>
                                <span id="kpi4Title">Maintenance</span>
                            </div>
                            <div class="kpi-trend warning" id="kpi4Trend">
                                <i class="fas fa-exclamation-triangle"></i> Critical
                            </div>
                        </div>
                        <div class="kpi-value" id="kpi4Value">3</div>
                        <div class="kpi-label" id="kpi4Label">Critical Alerts | 42 Open Work Orders</div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-12">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-line"></i>
                                <span>Production vs Efficiency Trends</span>
                            </div>
                            <div class="card-actions">
                                <select class="form-select form-select-sm" style="width: 140px;" id="prodTrendRange" onchange="updateProductionChart()">
                                    <option value="7">Last 7 days</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="90">Last quarter</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="productionChart" height="220"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row g-4 mb-4">
                <div class="col-lg-12">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-cogs"></i>
                                <span>Equipment Performance</span>
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Equipment</th>
                                        <th>Status</th>
                                        <th>Critical Param</th>
                                        <th>Efficiency</th>
                                        <th>Health</th>
                                    </tr>
                                </thead>
                                <tbody id="equipmentTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-bell"></i>
                                <span>Active Alerts</span>
                                <span class="badge bg-danger ms-2" id="alertCount">3</span>
                            </div>
                        </div>
                        <div id="alertList"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                <span>Cost Distribution</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="costChart" height="200"></canvas>
                        </div>
                        <div class="kpi-grid mt-3">
                            <div class="kpi-card">
                                <div class="kpi-label" id="costEnergyLabel">Energy Cost</div>
                                <div class="kpi-value" id="costEnergyValue">$1.2M</div>
                                <div class="kpi-trend negative" id="costEnergyTrend">+8%</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label" id="costMaintLabel">Maintenance</div>
                                <div class="kpi-value" id="costMaintValue">$450K</div>
                                <div class="kpi-trend positive" id="costMaintTrend">-12%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row g-4 mb-4" id="optimizationSection">
                <div class="col-12">
                    <div class="card-custom">
                        <div class="card-header border-0 pb-0 d-flex justify-content-between align-items-center">
                            <div class="card-title">
                                <i class="fas fa-sliders-h me-2"></i>
                                <span id="optTitle">Process Optimization</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="applyOptimization()">
                                <i class="fas fa-play me-1"></i>Simulate
                            </button>
                        </div>
                        <div class="card-body pt-4">
                            <div class="row g-4">
                                <div class="col-lg-4" id="optControls"></div>
                                <div class="col-lg-8">
                                    <h6 class="fw-bold mb-3"><i class="fas fa-chart-area me-2 text-primary"></i>Simulated Outcome</h6>
                                    <div class="chart-container" style="height: 350px;">
                                        <canvas id="optimizationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-4 rounded-3 d-none transition-all" id="simResults" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.2);">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h5 class="mb-1 text-success fw-bold"><i class="fas fa-check-circle me-2"></i>Optimization Successful</h5>
                                        <p class="mb-0 text-muted small">Parameters adjusted within safe operating limits. Efficiency projected to increase by 2.4%.</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="small text-uppercase text-muted fw-bold">Est. Monthly Savings</div>
                                        <div class="display-6 fw-bold text-success" id="simSavings">$0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROOT CAUSE AI VIEW (AI Workflow) -->
        <div id="view-causal" class="view-section d-none">
            <!-- Anomaly Detection Dashboard -->
            <div class="row g-4 mb-4" id="anomaly-dashboard">
                <div class="col-lg-8">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-bell"></i>
                                <span>Live Anomaly Detection</span>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="agent-dot"></div>
                                <span class="small text-muted">AI Monitoring Active</span>
                            </div>
                        </div>
                        <div id="anomaly-feed" class="p-3">
                            <!-- Anomaly alerts will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-upload"></i>
                                <span>Upload Event Logs</span>
                            </div>
                        </div>
                        <div class="p-3">
                            <p class="text-muted small mb-3">Upload local event logs or sensor data for AI analysis</p>
                            <div class="upload-area" onclick="document.getElementById('logFileInput').click()">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                <div class="fw-bold text-muted">Click to upload</div>
                                <div class="small text-muted">PDF, DOC, CSV, JSON, or TXT files</div>
                                <input type="file" id="logFileInput" accept=".pdf,.doc,.csv,.json,.txt,.log" style="display:none" onchange="handleLogUpload(this)">
                            </div>
                            <button class="btn btn-primary w-100 mt-3" onclick="analyzeUploadedLogs()" id="analyzeLogsBtn" disabled>
                                <i class="fas fa-brain me-1"></i>Analyze Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical RCA Cases -->
            <div class="card-custom mb-4" id="historical-rca">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-history"></i>
                        <span>Historical RCA Cases</span>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadMoreHistoricalCases()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Case ID</th>
                                <th>Date</th>
                                <th>Issue Type</th>
                                <th>Root Cause</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historical-cases">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI Workflow (Hidden until triggered) -->
            <div class="workflow-container" id="workflow-container" style="display: none;">
                <div class="card-actions">
                    <button class="btn btn-sm btn-primary" onclick="backToAnomalyDashboard()">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </button>
                </div>


                <!-- STEP 1: Anomaly Detection -->
                <div class="workflow-step" id="workflow-step-0">
                    <div class="anomaly-alert">
                        <div class="d-flex justify-content-between align-items-start position-relative">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: var(--accent);"></i>
                                    <h5 class="mb-0 fw-bold" style="color: #1e3a8a;">Anomaly Detected</h5>
                                </div>
                                <div class="mb-2" style="color: #64748b;">
                                    <strong>Alert ID:</strong> ANO-2026-0245 | <strong>Detected:</strong> <span id="anomalyTime">2 hours ago</span>
                                </div>
                                <div style="color: #64748b;">
                                    <strong>Description:</strong> <span id="anomalyDesc">Unexpected pressure drop in Ammonia Synthesis Loop - 12% below normal operating range</span>
                                </div>
                            </div>
                            <div class="d-flex flex-column gap-2">
                                <span class="alert-severity severity-high">High Severity</span>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewHistoricalAnomalies()">
                                    <i class="fas fa-history me-1"></i>History
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Multi-Agent AI Analysis -->
                <div class="workflow-step" id="workflow-step-1">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-brain"></i>
                                <span>Multi-Agent AI Analysis</span>
                            </div>
                            <div class="badge bg-primary" id="agentStatus">Analyzing...</div>
                        </div>
                        <div class="multi-agent-grid">
                            <!-- Pattern Detection Agent -->
                            <div class="agent-panel" id="agent-pattern">
                                <div class="agent-header">
                                    <div class="agent-icon pattern">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">Pattern Detection</div>
                                        <div class="small text-muted">Time-series analysis</div>
                                    </div>
                                </div>
                                <div class="agent-content">
                                    <div class="agent-finding" id="pattern-finding">
                                        Scanning historical data patterns...
                                    </div>
                                    <div class="agent-chart" id="pattern-chart">
                                        <div class="agent-chart-bar" style="height: 70%;"></div>
                                        <div class="agent-chart-bar" style="height: 85%;"></div>
                                        <div class="agent-chart-bar" style="height: 45%;"></div>
                                        <div class="agent-chart-bar" style="height: 30%;"></div>
                                        <div class="agent-chart-bar" style="height: 55%;"></div>
                                        <div class="agent-chart-bar" style="height: 40%;"></div>
                                        <div class="agent-chart-bar" style="height: 35%;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Causal Reasoning Agent -->
                            <div class="agent-panel" id="agent-causal">
                                <div class="agent-header">
                                    <div class="agent-icon causal">
                                        <i class="fas fa-sitemap"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">Causal Reasoning</div>
                                        <div class="small text-muted">5 Whys & fault trees</div>
                                    </div>
                                </div>
                                <div class="agent-content">
                                    <div class="agent-finding" id="causal-finding">
                                        Building causal relationships...
                                    </div>
                                    <div id="causal-diagram" class="mt-2"></div>
                                </div>
                            </div>

                            <!-- Domain Knowledge Agent -->
                            <div class="agent-panel" id="agent-domain">
                                <div class="agent-header">
                                    <div class="agent-icon domain">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">Domain Knowledge</div>
                                        <div class="small text-muted">Industry benchmarks</div>
                                    </div>
                                </div>
                                <div class="agent-content">
                                    <div class="agent-finding" id="domain-finding">
                                        Consulting knowledge base...
                                    </div>
                                    <div id="domain-benchmarks" class="mt-2"></div>
                                </div>
                            </div>

                            <!-- Simulation Agent -->
                            <div class="agent-panel" id="agent-simulation">
                                <div class="agent-header">
                                    <div class="agent-icon simulation">
                                        <i class="fas fa-flask"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">Simulation</div>
                                        <div class="small text-muted">What-if scenarios</div>
                                    </div>
                                </div>
                                <div class="agent-content">
                                    <div class="agent-finding" id="simulation-finding">
                                        Running simulations...
                                    </div>
                                    <div id="simulation-sliders" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: Root Cause Visualization -->
                <div class="workflow-step" id="workflow-step-2">
                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="card-custom root-cause-highlight">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-bullseye"></i>
                                        <span>Root Cause Identified</span>
                                    </div>
                                </div>
                                <div id="causalGraph" style="height: 450px; background: #ffffff; border-radius: 12px; border: 1px solid #e2e8f0; position: relative;"></div>
                                <div class="mt-3 d-flex justify-content-between">
                                    <div><small class="text-muted">Click nodes for details  Hover for info  Drag to rearrange</small></div>
                                    <div><button class="btn btn-sm btn-danger" onclick="highlightCriticalPath()">
                                        <i class="fas fa-route me-1"></i>Show Critical Path
                                    </button></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card-custom">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-list-ol"></i>
                                        <span>Contributing Factors</span>
                                    </div>
                                    <span class="badge bg-info" id="factorCount">0</span>
                                </div>
                                <div id="factorList" style="max-height: 480px; overflow-y: auto;">
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                        <div>Analyzing factors...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 4: AI Insights & Recommendations -->
                <div class="workflow-step" id="workflow-step-3">
                    <div class="insights-card">
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <i class="fas fa-lightbulb" style="font-size: 1.5rem; color: #1e40af;"></i>
                            <h5 class="mb-0 fw-bold" style="color: #1e3a8a;">AI Insights & Recommendations</h5>
                        </div>
                        <div id="insightsList">
                            <div class="insight-item">
                                <div class="insight-icon"><i class="fas fa-wrench"></i></div>
                                <div>
                                    <div class="fw-bold mb-1">Primary Issue: Catalyst Bed Deactivation</div>
                                    <div class="text-muted small">Detected 23% decline in catalyst activity over 14 days. Likely due to sulfur poisoning from upstream contamination.</div>
                                </div>
                            </div>
                            <div class="insight-item">
                                <div class="insight-icon"><i class="fas fa-thermometer-half"></i></div>
                                <div>
                                    <div class="fw-bold mb-1">Secondary Factor: Temperature Control Deviation</div>
                                    <div class="text-muted small">Reactor temperature oscillating 8C outside optimal range. PID tuning recommended.</div>
                                </div>
                            </div>
                            <div class="insight-item">
                                <div class="insight-icon"><i class="fas fa-check-circle"></i></div>
                                <div>
                                    <div class="fw-bold mb-1">Recommended Actions</div>
                                    <div class="text-muted small">
                                        1. Schedule catalyst regeneration within 48 hours<br>
                                        2. Inspect upstream purification system<br>
                                        3. Retune reactor temperature controller<br>
                                        4. Increase monitoring frequency for next 7 days
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 5: Impact Assessment -->
                <div class="workflow-step" id="workflow-step-4">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-line"></i>
                                <span>Predicted Impact with Remediation</span>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="applyRemediation()">
                                <i class="fas fa-check me-1"></i>Apply Recommendations
                            </button>
                        </div>
                        <div class="impact-kpi-grid">
                            <div class="impact-kpi" id="kpi-efficiency">
                                <div class="text-muted small text-uppercase">Production Efficiency</div>
                                <div class="kpi-value text-primary" id="efficiency-value">87.2%</div>
                                <div class="kpi-change positive" id="efficiency-change">
                                    <i class="fas fa-arrow-up"></i> +5.8%
                                </div>
                                <div class="small text-muted mt-1">vs. current 82.4%</div>
                            </div>
                            <div class="impact-kpi" id="kpi-downtime">
                                <div class="text-muted small text-uppercase">Unplanned Downtime</div>
                                <div class="kpi-value text-success" id="downtime-value">2.1 hrs</div>
                                <div class="kpi-change positive" id="downtime-change">
                                    <i class="fas fa-arrow-down"></i> -4.3 hrs/week
                                </div>
                                <div class="small text-muted mt-1">vs. current 6.4 hrs/week</div>
                            </div>
                            <div class="impact-kpi" id="kpi-cost">
                                <div class="text-muted small text-uppercase">Operating Cost</div>
                                <div class="kpi-value text-success" id="cost-value">$187/ton</div>
                                <div class="kpi-change positive" id="cost-change">
                                    <i class="fas fa-arrow-down"></i> -$23/ton
                                </div>
                                <div class="small text-muted mt-1">vs. current $210/ton</div>
                            </div>
                            <div class="impact-kpi" id="kpi-savings">
                                <div class="text-muted small text-uppercase">Est. Monthly Savings</div>
                                <div class="kpi-value text-success" id="savings-value">$420K</div>
                                <div class="kpi-change positive" id="savings-change">
                                    <i class="fas fa-plus"></i> ROI: 340%
                                </div>
                                <div class="small text-muted mt-1">Implementation cost: $124K</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 6: Knowledge Capture -->
                <div class="workflow-step" id="workflow-step-5">
                    <div class="knowledge-capture">
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <i class="fas fa-database" style="font-size: 1.5rem; color: var(--accent);"></i>
                            <h5 class="mb-0 fw-bold" style="color: #1e3a8a;">Knowledge Capture & Documentation</h5>
                        </div>
                        <div style="color: #64748b;">
                            <p class="mb-2">This RCA case has been automatically documented and added to the knowledge base for future reference and continuous learning.</p>
                            <div class="border-top pt-2 mt-2" style="border-color: var(--card-border) !important;">
                                <strong>Document ID:</strong> RCA-2026-0245<br>
                                <strong>Tags:</strong> 
                                <span class="badge bg-soft-primary text-primary border me-1">Pressure Drop</span>
                                <span class="badge bg-soft-primary text-primary border me-1">Catalyst Deactivation</span>
                                <span class="badge bg-soft-primary text-primary border me-1">Ammonia Synthesis</span>
                                <span class="badge bg-soft-primary text-primary border">Temperature Control</span>
                            </div>
                        </div>
                        <div class="knowledge-actions">
                            <button class="btn btn-primary" onclick="downloadRCAReport()">
                                <i class="fas fa-download me-1"></i>Download Report
                            </button>
                            <button class="btn btn-outline-primary" onclick="shareRCA()">
                                <i class="fas fa-share me-1"></i>Share with Team
                            </button>
                            <button class="btn btn-outline-primary" onclick="addToRunbook()">
                                <i class="fas fa-book me-1"></i>Add to Runbook
                            </button>
                            <button class="btn btn-outline-primary" onclick="scheduleFollowup()">
                                <i class="fas fa-calendar-check me-1"></i>Schedule Follow-up
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PLANNING & OPTIMIZATION VIEW (Combined Cost + Turnaround) -->
        <div id="view-planning" class="view-section d-none">
            
            <!-- COST ANALYSIS -->
            <div id="planning-cost-section">
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="card-custom h-100">
                            <div class="card-header">
                                <div class="card-title">OpEx Distribution</div>
                                <select class="form-select form-select-sm" style="width: auto;" onchange="updateCostPeriod(this.value)">
                                    <option value="week">This Week</option>
                                    <option value="month" selected>This Month</option>
                                    <option value="quarter">This Quarter</option>
                                </select>
                            </div>
                            <div style="height: 300px; position: relative;">
                                <canvas id="costDistributionChart"></canvas>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span><strong>Total OpEx:</strong></span>
                                    <span class="h5 mb-0" id="costTotal">$1.2M</span>
                                </div>
                                <div class="text-muted small">Month to Date | Budget: $1.5M</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-custom h-100">
                            <div class="card-header">
                                <div class="card-title">Savings realized by OpsEdge&trade;</div>
                                <span class="badge bg-success">+$185k MTD</span>
                            </div>
                            <div class="kpi-grid">
                                <div class="kpi-card cursor-pointer" onclick="showCostDetail('energy')">
                                    <div class="kpi-label">Energy Avoidance</div>
                                    <div class="kpi-value text-success" id="savingsEnergy">$45k</div>
                                    <div class="kpi-trend positive"><i class="fas fa-arrow-up"></i> +12%</div>
                                </div>
                                <div class="kpi-card cursor-pointer" onclick="showCostDetail('downtime')">
                                    <div class="kpi-label">Downtime Prevention</div>
                                    <div class="kpi-value text-success" id="savingsDowntime">$120k</div>
                                    <div class="kpi-trend positive"><i class="fas fa-arrow-up"></i> +8%</div>
                                </div>
                                <div class="kpi-card cursor-pointer" onclick="showCostDetail('material')">
                                    <div class="kpi-label">Material Efficiency</div>
                                    <div class="kpi-value text-primary" id="savingsMaterial">$12k</div>
                                    <div class="kpi-trend positive"><i class="fas fa-arrow-up"></i> +5%</div>
                                </div>
                                <div class="kpi-card cursor-pointer" onclick="showCostDetail('labor')">
                                    <div class="kpi-label">Labor Optimization</div>
                                    <div class="kpi-value text-info" id="savingsLabor">$8k</div>
                                    <div class="kpi-trend positive"><i class="fas fa-arrow-up"></i> +3%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card-custom">
                            <div class="card-header">
                                <div class="card-title"><i class="fas fa-chart-line me-2"></i>Cost Trend Analysis</div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary active" onclick="updateCostTrend(7)">7D</button>
                                    <button class="btn btn-outline-primary" onclick="updateCostTrend(30)">30D</button>
                                    <button class="btn btn-outline-primary" onclick="updateCostTrend(90)">90D</button>
                                </div>
                            </div>
                            <div style="height: 250px; position: relative;">
                                <canvas id="costTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TURNAROUND PLANNING -->
            <div id="planning-turnaround-section">
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        
                        <div class="card-custom">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Turnaround Schedule & Resources</span>
                                </div>
                                <span class="badge bg-soft-primary" id="activeScenarioBadge">Baseline</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 20px;">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary active" onclick="setTurnaroundScenario('baseline')">Baseline</button>
                                        <button type="button" class="btn btn-outline-primary" onclick="setTurnaroundScenario('aggressive')">Aggressive</button>
                                        <button type="button" class="btn btn-outline-primary" onclick="setTurnaroundScenario('cost')">Cost Optimized</button>
                                    </div>
                                </div>
                                <button class="btn btn-success" onclick="applyTurnaroundScenario()">
                                    <i class="fas fa-check-circle me-2"></i>Apply Scenario
                                </button>
                            </div>

                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="text-center p-3 bg-light rounded border">
                                            <div class="text-muted small">Projected Downtime</div>
                                            <div class="h2 fw-bold mb-0 text-primary" id="taDuration">18 Days</div>
                                            <div class="small text-muted" id="taBaselineComp">Baseline: 22 Days</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-3 bg-light rounded border">
                                            <div class="text-muted small">Resource Utilization</div>
                                            <div class="h2 fw-bold mb-0" id="taUtilization">78%</div>
                                            <div class="small text-muted" id="taUtilTarget">Target: 85%</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-3 bg-light rounded border">
                                            <div class="text-muted small">Cost Impact</div>
                                            <div class="h2 fw-bold mb-0 text-danger" id="taCost">+$2.4M</div>
                                            <div class="small text-muted" id="taBudget">Budget: $15M</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-3 bg-light rounded border">
                                            <div class="text-muted small">Risk Level</div>
                                            <div class="h2 fw-bold mb-0 text-warning" id="taRisk">Medium</div>
                                            <div class="small text-muted" id="taRiskItems">3 High Risk Items</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0">Critical Path Analysis</h6>
                                    <div class="small text-muted"><i class="fas fa-exclamation-circle text-danger me-1"></i><span id="criticalTaskCount">3</span> Critical Path Tasks</div>
                                </div>
                                <div class="gantt-container">
                                    <div class="gantt-timeline" id="ganttTimeline"></div>
                                    <div id="ganttTasks"></div>
                                </div>
                                <div class="mt-4">
                                    <h6 class="fw-bold mb-3">Resource Allocation Heatmap</h6>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="chart-container">
                                                <canvas id="resourceChart" height="180"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div id="resourceRecommendations" class="p-3 bg-warning bg-opacity-10 rounded border border-warning">
                                                <h6 class="text-warning fw-bold"><i class="fas fa-lightbulb me-2"></i>AI Recommendations</h6>
                                                <ul class="small mb-0 ps-3" id="recList"></ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAFETY & COMPLIANCE VIEW (enriched) -->
        <div id="view-safety" class="view-section d-none">
            <!-- Top KPI Row -->
            <div class="row g-3 mb-3">
                <div class="col-xl-3 col-lg-3 col-md-6">
                    <div class="kpi-card cursor-pointer" onclick="showSafetyKpiDetail('incident-free')">
                        <div class="kpi-value text-success" id="safeDays">156</div>
                        <div class="kpi-label">Days Without LTI</div>
                        <div class="kpi-trend positive">
                            <i class="fas fa-arrow-up"></i> Best in 3 years
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-6">
                    <div class="kpi-card cursor-pointer" onclick="showSafetyKpiDetail('trir')">
                        <div class="kpi-value" id="trir">0.42</div>
                        <div class="kpi-label">TRIR (Total Recordable)</div>
                        <div class="kpi-trend positive">
                            <i class="fas fa-arrow-down"></i> -18% vs target
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-6">
                    <div class="kpi-card cursor-pointer" onclick="showSafetyKpiDetail('dart')">
                        <div class="kpi-value" id="dart">0.21</div>
                        <div class="kpi-label">DART Rate</div>
                        <div class="kpi-trend positive">
                            <i class="fas fa-check-circle"></i> Industry leading
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-6">
                    <div class="kpi-card cursor-pointer" onclick="showSafetyKpiDetail('near-miss')">
                        <div class="kpi-value text-warning" id="nearMissCount">12</div>
                        <div class="kpi-label">Near Misses (30d)</div>
                        <div class="kpi-trend neutral">
                            <i class="fas fa-info-circle"></i> 92% reported
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart + AI Risk Row -->
            <div class="row g-3 mb-3">
                <div class="col-lg-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-shield-alt"></i>
                                <span>Safety Performance Trends</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="updateSafetyChart(30)">30D</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="updateSafetyChart(90)">90D</button>
                                <button class="btn btn-sm btn-primary" onclick="updateSafetyChart(365)">1Y</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="safetyTrendsChart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-brain"></i>
                                <span>AI Risk Prediction</span>
                            </div>
                            <span class="badge bg-soft-primary">94% Confidence</span>
                        </div>
                        <div class="card-body p-3">
                            <div class="alert alert-warning mb-2 py-2" id="safetyRiskMsg">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="fas fa-user-clock"></i>
                                    <div>
                                        <div class="fw-bold small">High Fatigue Risk</div>
                                        <div class="small">Shift B - 4 consecutive 12hr shifts. Recommendation: Additional break @ 2PM.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-danger mb-2 py-2">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="fas fa-wind"></i>
                                    <div>
                                        <div class="fw-bold small">High Wind Advisory</div>
                                        <div class="small">Gusts >45km/h predicted. Suspend all crane activity in Section 4.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mb-2 py-2">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="fas fa-video"></i>
                                    <div>
                                        <div class="fw-bold small">CV PPE Detection</div>
                                        <div class="small">3 instances of missing hard-hats detected in Loading Zone B this morning.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-primary mb-2 py-2">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="fas fa-tools"></i>
                                    <div>
                                        <div class="fw-bold small">Asset Integrity Risk</div>
                                        <div class="small">Vibration sensors on C-101 showing abnormal patterns. Risk of casing seal failure.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-success mb-0 py-2">
                                <div class="d-flex align-items-start gap-2">
                                    <i class="fas fa-check-circle"></i>
                                    <div>
                                        <div class="fw-bold small">Continuous Improvement</div>
                                        <div class="small">Safety reporting participation up 22% vs last month.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leading/Lagging Indicators Row -->
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card-custom">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-line"></i>
                                <span>Leading & Lagging Indicators</span>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2 small"><i class="fas fa-forward me-2"></i>Leading Indicators</h6>
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded cursor-pointer" onclick="showIndicatorDetail('inspections')">
                                    <div>
                                        <div class="fw-bold small">Safety Inspections</div>
                                        <div class="small text-muted">This month</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0 text-success">142</div>
                                        <div class="small text-muted">Target: 120</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded cursor-pointer" onclick="showIndicatorDetail('observations')">
                                    <div>
                                        <div class="fw-bold small">Behavioral Observations</div>
                                        <div class="small text-muted">Safe acts</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0 text-success">387</div>
                                        <div class="small text-muted">+22% vs last</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded cursor-pointer" onclick="showIndicatorDetail('training')">
                                    <div>
                                        <div class="fw-bold small">Training Completion</div>
                                        <div class="small text-muted">Certifications</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0 text-success">98.5%</div>
                                        <div class="small text-muted">623/632</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded cursor-pointer" onclick="showIndicatorDetail('hazards')">
                                    <div>
                                        <div class="fw-bold small">Hazard Assessments</div>
                                        <div class="small text-muted">On time</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0 text-success">96%</div>
                                        <div class="small text-muted">45/47</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2 small"><i class="fas fa-history me-2"></i>Lagging Indicators</h6>
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded cursor-pointer" onclick="showIndicatorDetail('lti')">
                                    <div>
                                        <div class="fw-bold small">Lost Time Injuries</div>
                                        <div class="small text-muted">Last 12 months</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0 text-success">0</div>
                                        <div class="small text-muted">Zero harm</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded cursor-pointer" onclick="showIndicatorDetail('recordable')">
                                    <div>
                                        <div class="fw-bold small">Recordable Incidents</div>
                                        <div class="small text-muted">OSHA</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0 text-warning">2</div>
                                        <div class="small text-muted">vs 3 last yr</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded cursor-pointer" onclick="showIndicatorDetail('first-aid')">
                                    <div>
                                        <div class="fw-bold small">First Aid Cases</div>
                                        <div class="small text-muted">Minor incidents</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0">7</div>
                                        <div class="small text-muted">-3 vs last</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded cursor-pointer" onclick="showIndicatorDetail('severity')">
                                    <div>
                                        <div class="fw-bold small">Severity Rate</div>
                                        <div class="small text-muted">Days away/restricted</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 mb-0 text-success">0.35</div>
                                        <div class="small text-muted">Below target</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Observations + Compliance Row -->
            <div class="row g-3 mb-3">
                <div class="col-xl-8 col-lg-7">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Active Safety Observations</span>
                                <span class="badge bg-warning ms-2" id="openObsCount">6</span>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="logNewObservation()">
                                <i class="fas fa-plus me-1"></i>Log Observation
                            </button>
                        </div>
                        <div style="max-height: 420px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Observation</th>
                                        <th>Location</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Assigned</th>
                                        <th>Days</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="safetyObservations"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4 col-lg-5">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-check-circle"></i>
                                <span>Compliance Status</span>
                            </div>
                        </div>
                        <div id="complianceList" class="p-3"></div>
                    </div>
                </div>
            </div>

            <!-- Permits + Training + CV Row -->
            <div class="row g-3 mb-3">
                <div class="col-xl-6 col-lg-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-file-signature"></i>
                                <span>Active Permits-to-Work</span>
                                <span class="live-indicator ms-2">LIVE</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="issueNewPermit()">
                                <i class="fas fa-plus me-1"></i>Issue Permit
                            </button>
                        </div>
                        <div id="permitsList">
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom cursor-pointer" onclick="showPermitDetail('PTW-2026-0234')">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="bg-danger text-white p-1 rounded">
                                        <i class="fas fa-fire"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold small">Hot Work - Reformer Welding</div>
                                        <div class="small text-muted">Zone 3A</div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">Active</span>
                                    <div class="small text-muted">Exp: 6PM</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom cursor-pointer" onclick="showPermitDetail('PTW-2026-0235')">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="bg-warning text-white p-1 rounded">
                                        <i class="fas fa-hard-hat"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold small">Confined Space - Tank Inspection</div>
                                        <div class="small text-muted">Tank #2</div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">Active</span>
                                    <div class="small text-muted">Exp: 4:30PM</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-2 cursor-pointer" onclick="showPermitDetail('PTW-2026-0233')">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="bg-primary text-white p-1 rounded">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold small">Electrical Isolation - C-101</div>
                                        <div class="small text-muted">Bay 1</div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-info">Pending</span>
                                    <div class="small text-muted">8:00 AM</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-3 col-md-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-graduation-cap"></i>
                                <span>Training</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTrainingMatrix()">
                                <i class="fas fa-table"></i>
                            </button>
                        </div>
                        <div id="trainingStatus">
                            <div class="mb-2 cursor-pointer" onclick="showTrainingDetail('h2s')">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small">H2S Awareness</span>
                                    <span class="small text-success">100%</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="mb-2 cursor-pointer" onclick="showTrainingDetail('confined-space')">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small">Confined Space</span>
                                    <span class="small text-success">98%</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: 98%"></div>
                                </div>
                            </div>
                            <div class="mb-2 cursor-pointer" onclick="showTrainingDetail('forklift')">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small">Forklift Ops</span>
                                    <span class="small text-warning">92%</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-warning" style="width: 92%"></div>
                                </div>
                            </div>
                            <div class="mb-2 cursor-pointer" onclick="showTrainingDetail('lockout')">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small">LOTO</span>
                                    <span class="small text-success">97%</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: 97%"></div>
                                </div>
                            </div>
                            <div class="cursor-pointer" onclick="showTrainingDetail('emergency')">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small">Emergency Response</span>
                                    <span class="small text-success">100%</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-lg-3 col-md-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-video"></i>
                                <span>CV Monitoring</span>
                                <span class="live-indicator ms-2">LIVE</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="openCVDashboard()">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        </div>
                        <div id="cvAlerts" class="d-flex flex-column gap-2"></div>
                        <div class="mt-2 text-center">
                            <div class="row g-2 text-center small">
                                <div class="col-6">
                                    <div class="text-muted">Cameras</div>
                                    <div class="fw-bold text-success">42/42</div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted">Alerts</div>
                                    <div class="fw-bold">18</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency + Industrial Hygiene Row -->
            <div class="row g-3 mb-3">
                <div class="col-xl-6 col-lg-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-ambulance"></i>
                                <span>Emergency Readiness</span>
                            </div>
                        </div>
                        <div class="p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2 cursor-pointer small" onclick="showEmergencyDetail('ert')">
                                <div>
                                    <i class="fas fa-user-shield text-success me-2"></i>
                                    <span>ERT On-Site</span>
                                </div>
                                <span class="badge bg-success">7</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2 cursor-pointer small" onclick="showEmergencyDetail('equipment')">
                                <div>
                                    <i class="fas fa-medkit text-success me-2"></i>
                                    <span>Equipment</span>
                                </div>
                                <span class="badge bg-success">100%</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2 cursor-pointer small" onclick="showEmergencyDetail('muster')">
                                <div>
                                    <i class="fas fa-map-marker-alt text-success me-2"></i>
                                    <span>Muster Points</span>
                                </div>
                                <span class="badge bg-success">4/4</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center cursor-pointer small" onclick="showEmergencyDetail('drill')">
                                <div>
                                    <i class="fas fa-bell text-info me-2"></i>
                                    <span>Last Drill</span>
                                </div>
                                <span class="badge bg-info">12d ago</span>
                            </div>
                        </div>
                        <div class="border-top p-2 bg-light">
                            <button class="btn btn-danger btn-sm w-100" onclick="initiateEmergencyDrill()">
                                <i class="fas fa-exclamation-triangle me-1"></i>Emergency Drill
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-xl-6 col-lg-6">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-lungs"></i>
                                <span>Industrial Hygiene</span>
                            </div>
                        </div>
                        <div class="p-2">
                            <div class="mb-2 cursor-pointer" onclick="showHygieneDetail('noise')">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small"><i class="fas fa-volume-up me-1"></i>Noise</span>
                                    <span class="small text-success">Within Limits</span>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-success" style="width: 72%"></div>
                                </div>
                            </div>
                            <div class="mb-2 cursor-pointer" onclick="showHygieneDetail('air')">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small"><i class="fas fa-wind me-1"></i>Air Quality</span>
                                    <span class="small text-success">Safe</span>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-success" style="width: 8%"></div>
                                </div>
                            </div>
                            <div class="cursor-pointer" onclick="showHygieneDetail('gas')">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small"><i class="fas fa-gas-pump me-1"></i>Gas Detection</span>
                                    <span class="small text-success">No Alarms</span>
                                </div>
                                <div class="small text-muted">32 sensors</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARBON & SUSTAINABILITY VIEW (enriched) -->
        <div id="view-carbon" class="view-section d-none">
            <div class="row g-4 mb-3">
                <div class="col-lg-12">
                    <div class="card-custom">
                        <div class="row align-items-center">
                            <div class="col-md-3 border-end">
                                <div class="text-center">
                                    <div class="text-muted small text-uppercase">Net Carbon Intensity</div>
                                    <div class="display-6 fw-bold text-success" id="carbonIntensity">0.54</div>
                                    <div class="small text-muted">kg CO2e / tonne</div>
                                </div>
                            </div>
                            <div class="col-md-3 border-end">
                                <div class="text-center">
                                    <div class="text-muted small text-uppercase">Total Captured</div>
                                    <div class="display-6 fw-bold text-primary" id="totalCaptured">8,240</div>
                                    <div class="small text-muted">Tonnes YTD</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="px-4">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-bold">2030 Reduction Goal</span>
                                        <span class="text-success fw-bold" id="goalStatus">On Track</span>
                                    </div>
                                    <div class="progress" style="height: 12px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 42%" id="goalProgress">42% Achieved</div>
                                    </div>
                                    <div class="small text-muted mt-2">Target: 30% reduction from 2018 baseline</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-lg-8">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-area"></i>
                                <span>Emissions & Capture Trends</span>
                            </div>
                            <div class="btn-group btn-group-sm" id="carbonRangeGroup">
                                <button class="btn btn-outline-secondary active" onclick="updateCarbonChart(7)">7 Days</button>
                                <button class="btn btn-outline-secondary" onclick="updateCarbonChart(30)">30 Days</button>
                                <button class="btn btn-outline-secondary" onclick="updateCarbonChart(90)">YTD</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="emissionsChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-recycle"></i>
                                <span>Capture Unit Status</span>
                            </div>
                        </div>
                        <div id="captureUnitStatus" class="d-flex flex-column gap-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="row g-4">
                <!-- Emissions Breakdown -->
                <div class="col-lg-4">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                <span>Emissions Source Breakdown</span>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="emissionsSourceChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Stationary Combustion</span>
                                <span class="fw-bold">64%</span>
                            </div>
                            <div class="progress mb-2" style="height: 4px;">
                                <div class="progress-bar bg-primary" style="width: 64%"></div>
                            </div>
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Purchased Energy</span>
                                <span class="fw-bold">22%</span>
                            </div>
                            <div class="progress mb-2" style="height: 4px;">
                                <div class="progress-bar bg-info" style="width: 22%"></div>
                            </div>
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Process Emissions</span>
                                <span class="fw-bold">14%</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar bg-warning" style="width: 14%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Environmental KPI Grid -->
                <div class="col-lg-8">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-leaf"></i>
                                <span>Environmental Performance Matrix</span>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="p-3 border rounded-3 bg-light">
                                    <div class="text-muted small mb-1">Water Recycling Rate</div>
                                    <div class="h3 fw-bold mb-0">94.2%</div>
                                    <div class="text-success small"><i class="fas fa-arrow-up"></i> 1.5% vs Last Mo</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 border rounded-3 bg-light">
                                    <div class="text-muted small mb-1">Waste Diversion</div>
                                    <div class="h3 fw-bold mb-0">88.7%</div>
                                    <div class="text-success small"><i class="fas fa-arrow-up"></i> 3.2% vs Target</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 border rounded-3 bg-light">
                                    <div class="text-muted small mb-1">Methane Leak Rate</div>
                                    <div class="h3 fw-bold mb-0">0.02%</div>
                                    <div class="text-success small"><i class="fas fa-check-circle"></i> Below Threshold</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 border rounded-3 bg-light">
                                    <div class="card-title small mb-3 text-muted fw-bold">Energy Intensity Trend</div>
                                    <div style="height: 100px;">
                                        <canvas id="energyIntensityChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 border rounded-3 bg-light">
                                    <div class="card-title small mb-3 text-muted fw-bold">Compliance Score</div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="h2 fw-bold mb-0 text-primary">99.8%</div>
                                        <div class="flex-grow-1">
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-primary" role="progressbar" style="width: 99.8%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="small text-muted mt-2">102 days since last deviation check</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: PROPOSAL MATRIX (Restored & Enhanced) -->
        <div id="view-proposal" class="view-section d-none">
             <div class="d-flex align-items-center mb-4">
                 <div>
                    <h2 class="fw-bold text-dark mb-1">Partnership Roadmap</h2>
                    <p class="text-muted mb-0">Implementation tiers, feature deliverables, and resource allocation.</p>
                 </div>
                 <div class="ms-auto">
                 <button class="btn btn-outline-success btn-sm me-2" onclick="openRoiModal()"><i class="fas fa-calculator me-2"></i>ROI Calculator</button>
                 <button class="btn btn-outline-primary btn-sm me-2"><i class="fas fa-download me-2"></i>Download PDF</button>
                 <button class="btn btn-primary btn-sm"><i class="fas fa-envelope me-2"></i>Email Stakeholders</button>
             </div>
             </div>

             <!-- Feature Matrix Table -->
             <div class="table-responsive">
                <table class="feature-matrix">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Tier</th>
                            <th style="width: 35%;">Features / Deliverables</th>
                            <th style="width: 20%;">Target User</th>
                            <th style="width: 15%;">Primary Value</th>
                            <th style="width: 10%; text-align: center;">Est. Resource</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Tier 1 -->
                        <tr>
                            <td>
                                <span class="matrix-tier">Tier 1: Foundation Layer</span>
                                <span class="matrix-sub">Enhanced Operations</span>
                            </td>
                            <td>
                                SCADA/LIMS Integration, <strong>Digital Shift Handovers</strong>, Environmental Compliance Tracking, Production Loss Accounting
                            </td>
                            <td>
                                Site Managers,<br>Control Room Operators
                            </td>
                            <td>
                                <strong>Eliminate paper logs,</strong> ensure regulatory compliance, 90% faster reporting
                            </td>
                            <td>
                                <span class="matrix-resource">2 Months</span>
                                <span class="matrix-resource-sub">(Team-Months)</span>
                            </td>
                        </tr>

                        <!-- Tier 2 -->
                        <tr>
                            <td>
                                <span class="matrix-tier">Tier 2: Asset Health</span>
                                <span class="matrix-sub">AI Predictive Core</span>
                            </td>
                            <td>
                                <strong>Compressor Surge Prediction</strong> (Nitrogen), <strong>Conveyor Belt Health</strong> (Potash), Vibration Analysis, Catalyst RUL
                            </td>
                            <td>
                                Reliability Engineers,<br>Maintenance Planners
                            </td>
                            <td>
                                <strong>Avoid catastrophe:</strong> Prevent critical asset failure & extend useful life
                            </td>
                            <td>
                                <span class="matrix-resource">3 Months</span>
                                <span class="matrix-resource-sub">(Team-Months)</span>
                            </td>
                        </tr>

                        <!-- Tier 3 -->
                        <tr>
                            <td>
                                <span class="matrix-tier">Tier 3: Causal AI</span>
                                <span class="matrix-sub">Process Optimization</span>
                            </td>
                            <td>
                                Root Cause for Quality/Yield Deviations, <strong>Energy vs. Throughput</strong> Trade-offs, Chemical Stability Modeling
                            </td>
                            <td>
                                Process Engineers (ChE),<br>Metallurgists
                            </td>
                            <td>
                                <strong>Stabilize the process:</strong> Reduce variability & raw material waste
                            </td>
                            <td>
                                <span class="matrix-resource">3 Months</span>
                                <span class="matrix-resource-sub">(Team-Months)</span>
                            </td>
                        </tr>

                        <!-- Tier 4 -->
                        <tr>
                            <td>
                                <span class="matrix-tier">Tier 4: Enterprise Scale</span>
                                <span class="matrix-sub">Organization Suite</span>
                            </td>
                            <td>
                                Multi-site Benchmarking (e.g. N-2 vs N-3), Fleet-wide Analytics, Best-Practice Library, Standardized KPI Definitions
                            </td>
                            <td>
                                VP Operations,<br>Corporate Strategy
                            </td>
                            <td>
                                <strong>Identify the "Golden Batch"</strong> & scale it across the network
                            </td>
                            <td>
                                <span class="matrix-resource">4 Months</span>
                                <span class="matrix-resource-sub">(Team-Months)</span>
                            </td>
                        </tr>

                        <!-- Tier 5 -->
                        <tr>
                            <td>
                                <span class="matrix-tier">Tier 5: Workflow Integration</span>
                                <span class="matrix-sub">SAP / CMMS Automation</span>
                            </td>
                            <td>
                                Auto-trigger SAP Work Orders, Parts Inventory Lookups, Safety Permit Digitization, Mobile Field Alerts
                            </td>
                            <td>
                                Maintenance Teams,<br>Field Technicians
                            </td>
                            <td>
                                <strong>Close the loop:</strong> Turn insights into executed work orders instantly
                            </td>
                            <td>
                                <span class="matrix-resource">3 Months</span>
                                <span class="matrix-resource-sub">(Team-Months)</span>
                            </td>
                        </tr>

                        <!-- Tier 6 -->
                        <tr>
                            <td>
                                <span class="matrix-tier">Tier 6: Digital Twin</span>
                                <span class="matrix-sub">Strategic Simulation</span>
                            </td>
                            <td>
                                <strong>Turnaround (STO) Scope Optimization</strong>, Blue Ammonia Carbon Intensity Forecasting, CapEx Scenario Sim
                            </td>
                            <td>
                                Plant Leadership,<br>Sustainability Officers
                            </td>
                            <td>
                                <strong>Maximize uptime</strong> & ensure sustainability targets are met
                            </td>
                            <td>
                                <span class="matrix-resource">4 Months</span>
                                <span class="matrix-resource-sub">(Team-Months)</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
             </div>

             <!-- Partnership Action Section -->
             <div class="mt-5 p-5 text-center bg-light rounded-3 border">
                 <h4 class="fw-bold mb-3">Ready to Deploy?</h4>
                 <p class="text-muted mb-4">Discuss customization, pilot programs, and commercial terms with our solution architects.</p>
                 <button class="btn btn-primary btn-lg px-5 py-3" onclick="window.open('mailto:support@algo-rythmn.ai?subject=Partnership%20Discussion%20Request', '_blank')">
                     <i class="fas fa-calendar-alt me-2"></i>Schedule Partnership Discussion
                 </button>
             </div>
        </div>

        <!-- ========== VIEW: SETTINGS ========== -->
        <div id="view-settings" class="view-section d-none">
            <div class="row">
                <div class="col-md-3">
                    <div class="card-custom h-100 p-0 overflow-hidden">
                        <div class="list-group list-group-flush">
                            <button class="list-group-item list-group-item-action active py-3 border-0">
                                <i class="fas fa-sliders-h me-2"></i> General
                            </button>
                            <button class="list-group-item list-group-item-action py-3 border-0">
                                <i class="fas fa-bell me-2"></i> Notifications
                            </button>
                            <button class="list-group-item list-group-item-action py-3 border-0">
                                <i class="fas fa-network-wired me-2"></i> Integrations
                            </button>
                            <button class="list-group-item list-group-item-action py-3 border-0">
                                <i class="fas fa-users me-2"></i> Users & Roles
                            </button>
                            <button class="list-group-item list-group-item-action py-3 border-0 text-danger">
                                <i class="fas fa-power-off me-2"></i> System Reset
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="card-custom">
                        <div class="card-header border-bottom mb-4">
                            <h5 class="fw-bold mb-0">System Configuration</h5>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">Site Identity</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" value="Nutrien Nitrogen Operations">
                                    <div class="form-text">Display name for reports and dashboards</div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select">
                                        <option>UTC-6 (Central)</option>
                                        <option>UTC-7 (Mountain)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <hr class="text-muted opacity-25 my-4">

                        <div class="mb-4">
                            <label class="form-label fw-bold mb-3">Data Ingestion Frequency</label>
                            <div class="d-flex align-items-center justify-content-between p-3 border rounded mb-2 bg-light">
                                <div>
                                    <div class="fw-bold">Real-time Sensors (SCADA)</div>
                                    <div class="small text-muted">Vibration, Temperature, Flow</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" checked>
                                    <label class="form-check-label ms-2">Enabled (1s)</label>
                                </div>
                            </div>
                            <div class="d-flex align-items-center justify-content-between p-3 border rounded bg-light">
                                <div>
                                    <div class="fw-bold">Lab Analysis (LIMS)</div>
                                    <div class="small text-muted">Quality, Chemical Composition</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" checked>
                                    <label class="form-check-label ms-2">Enabled (15m)</label>
                                </div>
                            </div>
                        </div>

                        <hr class="text-muted opacity-25 my-4">
                        
                        <div class="mb-2">
                             <label class="form-label fw-bold mb-3">AI Model Sensitivity</label>
                             <div class="row">
                                 <div class="col-12">
                                     <label class="small text-muted mb-1">Anomaly Detection Threshold</label>
                                     <input type="range" class="form-range" id="sensitivityRange" min="1" max="100" value="85">
                                     <div class="d-flex justify-content-between small text-muted">
                                         <span>Low Noise</span>
                                         <span>Balanced</span>
                                         <span>High Sensitivity</span>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <div class="text-end mt-4">
                            <button class="btn btn-outline-secondary me-2">Discard Changes</button>
                            <button class="btn btn-primary px-4"><i class="fas fa-save me-2"></i>Save Configuration</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Disclaimer -->
        <footer class="mt-5 p-4 text-center text-muted border-top" style="font-size: 0.8rem; background: rgba(0,0,0,0.02); border-radius: 8px;">
            <div class="container">
                <p class="mb-1"> 2026 OpsEdge Industrial Operations Intelligence - Algo-Rythmn.ai</p>
                <p class="mb-2">
                    <i class="fas fa-balance-scale me-1"></i> <strong>REGULATORY COMPLIANCE:</strong> Designed for alignment with Alberta TIER / Federal Carbon Backstop and Saskatchewan Ministry of Energy and Resources reporting standards.
                </p>
                <p class="mb-0 text-start" style="opacity: 0.8;">
                    <strong>LEGAL DISCLAIMER:</strong> All AI-generated insights, root cause analyses, and optimization recommendations are for decision-support purposes only. 
                    Operational actions must be verified by qualified engineers in accordance with site-specific safety protocols, LOTO procedures, and Canadian regulatory standards. 
                    Predictions are probabilistic; user assumes all liability for implementation. This tool does not supersede provincial health and safety acts (OH&S).
                </p>
            </div>
        </footer>
    </div>
</div>


<!-- ROI Calculator Modal -->
<div class="modal fade" id="roiModal" tabindex="-1" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light border-bottom-0">
                <h5 class="modal-title fw-bold"><i class="fas fa-calculator me-2 text-primary"></i>ROI Estimator</h5>
                <button type="button" class="btn-close" onclick="closeRoiModal()"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-uppercase text-muted">Annual Production (Tonnes)</label>
                        <input type="number" class="form-control form-control-lg" id="roiProduction" value="1200000">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-uppercase text-muted">Current OpEx ($/Tonne)</label>
                        <input type="number" class="form-control form-control-lg" id="roiOpex" value="45.50">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-uppercase text-muted">Unplanned Downtime (Days/Year)</label>
                        <input type="number" class="form-control form-control-lg" id="roiDowntime" value="14">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-uppercase text-muted">Revenue Loss per Day ($)</label>
                        <input type="number" class="form-control form-control-lg" id="roiRevLoss" value="250000">
                    </div>
                </div>
                
                <div class="card bg-light border-0 p-4 mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-6 text-center border-end">
                            <div class="small text-uppercase fw-bold text-muted mb-2">Projected Annual Savings</div>
                            <div class="display-5 fw-bolder text-primary mb-0" id="roiResult">$3.4M</div>
                            <div class="small text-success fw-bold mt-2"><i class="fas fa-arrow-up me-1"></i>High Confidence</div>
                        </div>
                        <div class="col-md-6 ps-md-4">
                            <ul class="list-unstyled mb-0 d-flex flex-col gap-3">
                                <li class="d-flex align-items-center justify-content-between">
                                    <span><i class="fas fa-bolt text-warning me-2"></i>Efficiency Gain (1.5%)</span>
                                    <strong id="roiEffGain" class="text-dark">$819k</strong>
                                </li>
                                <li class="d-flex align-items-center justify-content-between">
                                    <span><i class="fas fa-clock text-danger me-2"></i>Downtime Reduction (30%)</span>
                                    <strong id="roiDowntimeGain" class="text-dark">$1.05M</strong>
                                </li>
                                <li class="d-flex align-items-center justify-content-between">
                                    <span><i class="fas fa-tools text-info me-2"></i>Maint. Optimization</span>
                                    <strong id="roiMaintGain" class="text-dark">$1.5M</strong>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                     <button class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm" onclick="calculateROI()">
                        <i class="fas fa-sync-alt me-2"></i>Recalculate Impact
                     </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AlgoMind Agent Button & Panel -->
<div class="agent-toggle-btn pulse" onclick="toggleAgent()">
    <i class="fas fa-robot"></i>
</div>
<div class="algomind-panel" id="agentPanel" onclick="closeAgentOnBackdrop(event)">
    <div class="algomind-modal" onclick="event.stopPropagation()">
        <div class="algomind-header">
            <div class="algomind-title">
                <div class="algomind-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div>
                    <div class="fw-bold" style="font-size: 1.5rem;">AlgoMind AI Assistant</div>
                    <div class="agent-status">
                        <div class="agent-dot"></div>
                        <span class="small">Specialized Multi-Agent System  Ready to Help</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-sm btn-link text-white" onclick="toggleAgent()" style="font-size: 1.5rem;"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="chat-area" id="chatContainer" style="overflow-y: auto;">
            <div class="section-grid">
                <!-- Section 1: Production Efficiency & Process Optimization -->
                <div class="question-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-industry"></i></div>
                        Production Efficiency & Process Optimization
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('How can we reduce energy consumption in nitrogen generation without compromising purity?')">
                        How can we reduce energy consumption in nitrogen generation without compromising purity?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('What are the bottlenecks in our potash milling process, and how can they be eliminated?')">
                        What are the bottlenecks in our potash milling process, and how can they be eliminated?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Which production line is currently underperforming compared to benchmarks?')">
                        Which production line is currently underperforming compared to benchmarks?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Can the system suggest optimal operating parameters for compressors and reactors?')">
                        Can the system suggest optimal operating parameters for compressors and reactors?
                    </div>
                </div>

                <!-- Section 2: Predictive Maintenance & Equipment Reliability -->
                <div class="question-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-tools"></i></div>
                        Predictive Maintenance & Equipment Reliability
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Which pumps or compressors are most at risk of failure in the next 30 days?')">
                        Which pumps or compressors are most at risk of failure in the next 30 days?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('What maintenance schedule would minimize downtime while reducing costs?')">
                        What maintenance schedule would minimize downtime while reducing costs?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Can you detect anomalies in vibration or temperature data from mining equipment?')">
                        Can you detect anomalies in vibration or temperature data from mining equipment?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('How much cost savings can predictive maintenance deliver compared to reactive repairs?')">
                        How much cost savings can predictive maintenance deliver compared to reactive repairs?
                    </div>
                </div>

                <!-- Section 3: Resource Allocation & Cost Control -->
                <div class="question-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-dollar-sign"></i></div>
                        Resource Allocation & Cost Control
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Where are we overspending on energy or raw materials in nitrogen production?')">
                        Where are we overspending on energy or raw materials in nitrogen production?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('What is the cost per ton of potash produced this week compared to last month?')">
                        What is the cost per ton of potash produced this week compared to last month?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Can you recommend adjustments to shift scheduling to reduce overtime costs?')">
                        Can you recommend adjustments to shift scheduling to reduce overtime costs?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('How do current reagent usage levels compare to industry best practices?')">
                        How do current reagent usage levels compare to industry best practices?
                    </div>
                </div>

                <!-- Section 4: Safety & Compliance -->
                <div class="question-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-shield-alt"></i></div>
                        Safety & Compliance
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Are there any safety alerts from sensors in the mining shafts today?')">
                        Are there any safety alerts from sensors in the mining shafts today?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('What is the compliance status of our nitrogen plant with environmental regulations?')">
                        What is the compliance status of our nitrogen plant with environmental regulations?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Can you flag deviations in ammonia emissions beyond permitted thresholds?')">
                        Can you flag deviations in ammonia emissions beyond permitted thresholds?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Which operational areas pose the highest safety risks right now?')">
                        Which operational areas pose the highest safety risks right now?
                    </div>
                </div>

                <!-- Section 5: Sustainability & Environmental Impact -->
                <div class="question-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-leaf"></i></div>
                        Sustainability & Environmental Impact
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('How can we reduce greenhouse gas emissions in nitrogen production?')">
                        How can we reduce greenhouse gas emissions in nitrogen production?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('What is our current water usage in potash mining compared to last quarter?')">
                        What is our current water usage in potash mining compared to last quarter?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Can you simulate the impact of switching to renewable energy sources?')">
                        Can you simulate the impact of switching to renewable energy sources?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('What sustainability KPIs are trending positively or negatively?')">
                        What sustainability KPIs are trending positively or negatively?
                    </div>
                </div>

                <!-- Section 6: Market & Strategic Insights -->
                <div class="question-section">
                    <div class="section-title">
                        <div class="section-icon"><i class="fas fa-chart-line"></i></div>
                        Market & Strategic Insights
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('What is the current global demand forecast for nitrogen fertilizers?')">
                        What is the current global demand forecast for nitrogen fertilizers?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('How do our potash production costs compare to competitors?')">
                        How do our potash production costs compare to competitors?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Can you model profitability under different commodity price scenarios?')">
                        Can you model profitability under different commodity price scenarios?
                    </div>
                    <div class="question-item" onclick="sendQuickPrompt('Which operational improvements would yield the highest ROI in the next year?')">
                        Which operational improvements would yield the highest ROI in the next year?
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="input-group">
                <input type="text" class="form-control" id="chatInput" placeholder="Ask anything about your operations..." onkeypress="if(event.key === 'Enter') sendMessage()">
                <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<script>
    // ====================
    // GLOBAL STATE
    // ====================
    const state = {
        context: 'nitrogen',
        currentView: 'dashboard',
        agents: { predictive: { active: true, confidence: 92 }, causal: { active: true, confidence: 88 }, safety: { active: true, confidence: 95 }, maintenance: { active: true, confidence: 85 } }
    };

    // ====================
    // ENHANCED DATA CONFIG (same as before, enriched)
    // ====================
    const enhancedDataConfig = {
        nitrogen: {
            title: "Nitrogen Production Unit (N-2)",
            description: "Ammonia/Urea Complex  1,250 TPD Capacity",
            kpis: [
                { id: 'availability', label: 'Reformer Availability', value: '98.7%', trend: '+2.3%', trendType: 'positive', target: '97.5%', details: 'S/C Ratio Optimized' },
                { id: 'carbon', label: 'Gas Efficiency (GJ/T)', value: '32.4', trend: '-1.5', trendType: 'positive', target: '31.0', details: 'Relative to Alberta TIER' },
                { id: 'safety', label: 'Safety (TRIR)', value: '0.42', trend: 'Stable', trendType: 'positive', target: '<0.50', details: 'Zero LTI Streak: 156 Days' },
                { id: 'winterization', label: 'Winterization Status', value: 'Ready', trend: '-22C Ambient', trendType: 'neutral', target: 'Active', details: 'Glycol Loop / Trace Heating' }
            ],
            equipment: [
                { name: 'Primary Reformer (H-101)', status: 'Warning', efficiency: '87%', health: '72%', param: 'Tube Temp Profile' },
                { name: 'SynGas Compressor (C-201)', status: 'Critical', efficiency: '78%', health: '65%', param: 'Vibration (Radial)' },
                { name: 'Urea Reactor (R-305)', status: 'Optimal', efficiency: '94%', health: '92%', param: 'Conversion Rate' },
                { name: 'CO2 Removal Column', status: 'Optimal', efficiency: '91%', health: '88%', param: 'Solvent Quality' },
                { name: 'Ammonia Converter', status: 'Warning', efficiency: '83%', health: '76%', param: 'Bed Temp Delta' }
            ],
            optimization: {
                title: "Ammonia Process Optimization",
                params: [
                    { id: 'sc_ratio', label: 'Steam-to-Carbon Ratio', min: 2.5, max: 3.5, current: 3.0, unit: '' },
                    { id: 'inlet_temp', label: 'Reformer Inlet Temp', min: 480, max: 540, current: 510, unit: 'C' },
                    { id: 'purge_rate', label: 'Loop Purge Rate', min: 1000, max: 5000, current: 2500, unit: 'kg/h' }
                ]
            },
            alerts: [
                { id: 1, title: "Reformer Tube Hot Spot", description: "Tube #42 skin temperature > 920C.", time: "15 min ago", severity: "critical", equipment: "Reformer H-101", action: "Adjust burner pattern" },
                { id: 2, title: "SynGas Compressor Surge", description: "Surge margin 5%.", time: "2 hours ago", severity: "high", equipment: "Compressor C-201", action: "Check recycle valve" },
                { id: 3, title: "Urea Quality Deviation", description: "Biuret 0.85%.", time: "6 hours ago", severity: "medium", equipment: "Prilling Tower", action: "Adjust vacuum" }
            ],
            causalNodes: [
                { id: "Reformer Efficiency Drop", group: 1, description: "Primary reformer performance decline", impact: "High", mitigation: "Optimize S/C ratio" },
                { id: "Catalyst Deactivation", group: 2, description: "Activity loss due to poisoning", impact: "High", mitigation: "Regenerate / replace" },
                { id: "Tube Scaling", group: 2, description: "Internal deposits", impact: "Medium", mitigation: "Chemical cleaning" },
                { id: "Methane Slip", group: 2, description: "Unconverted methane", impact: "Medium", mitigation: "Increase temp" },
                { id: "Steam Ratio low", group: 3, description: "S/C ratio below setpoint", impact: "High", mitigation: "Calibrate flow control" },
                { id: "Feed Gas Sulfur", group: 3, description: "Sulfur breakthrough", impact: "Critical", mitigation: "Guard bed change" }
            ],
            causalLinks: [
                { source: "Catalyst Deactivation", target: "Reformer Efficiency Drop", value: 0.85 },
                { source: "Tube Scaling", target: "Reformer Efficiency Drop", value: 0.72 },
                { source: "Methane Slip", target: "Reformer Efficiency Drop", value: 0.68 },
                { source: "Steam Ratio low", target: "Catalyst Deactivation", value: 0.91 },
                { source: "Feed Gas Sulfur", target: "Catalyst Deactivation", value: 0.88 },
                { source: "Steam Ratio low", target: "Tube Scaling", value: 0.45 }
            ],
            carbon: { intensity: 0.54, captured: 8240, progress: 42, emissions_trend: [120,118,115,112,110,108,105], capture_trend: [15,18,20,22,25,28,30] },
            turnaround: { duration: 21, baseline: 24, utilization: 82, cost: 14.5, budget: 16, risk: "High", criticalItems: 5, tasks: [
                { id: 1, name: "Reformer Catalyst Changeout", duration: 14, progress: 0, critical: true },
                { id: 2, name: "Tube Inspection (Eddy)", duration: 5, progress: 0, critical: true },
                { id: 3, name: "Compressor Rotor Swap", duration: 9, progress: 0, critical: true },
                { id: 4, name: "Urea Stripper Relining", duration: 18, progress: 0, critical: true }
            ]},
            safety: { daysSafe: 156, trir: 0.42, dart: 0.21, fatigueRisk: "High fatigue risk in Shift B (Maintenance) due to overtime." },
            maintenance: {
                workOrders: [
                    { id: "WO-2942", asset: "Compressor B - Vibration", priority: "Critical", status: "In Progress", hours: "4.5h", pclass: "danger" },
                    { id: "WO-2945", asset: "Reformer Tube check", priority: "High", status: "Scheduled", hours: "2.0h", pclass: "warning" },
                    { id: "WO-2951", asset: "Primary Filter Change", priority: "Medium", status: "Pending Parts", hours: "1.5h", pclass: "info" },
                    { id: "WO-2938", asset: "Sensor Calibration", priority: "Low", status: "Open", hours: "0.5h", pclass: "success" }
                ],
                backlog: "420h", backlogDist: [30, 45, 25] 
            },
            cost: { total: "$1.2M", energy: "$45k", downtime: "$120k", material: "$12k", labor: "$8k" },
            predictive: { 
                alerts: [
                    { title: "Predicted Failure: Pump Station 4", desc: "Confidence: 89% | Est. Time to Failure: 14 Days", type: "warning", icon: "exclamation-triangle" },
                    { title: "Optimization Opportunity", desc: "Reduce output by 2% to extend bearing life by 3 months.", type: "info", icon: "info-circle" }
                ],
                chartData: Array.from({length: 30}, () => 85 + Math.random() * 10 - Math.random() * 5)
            }
        },
        potash: {
            title: "Potash Mining Operations (K3)",
            description: "Underground Mining  Processing Mill  5.2M TPY",
            kpis: [
                { id: 'ore_grade', label: 'Ore Grade (K2O)', value: '24.8%', trend: '+0.2%', trendType: 'positive', target: '25.0%', details: 'Saskatchewan Basin Avg' },
                { id: 'carbon', label: 'Mill Recovery Rate', value: '88.2%', trend: '+0.5%', trendType: 'positive', target: '90.0%', details: 'K2O Recovery' },
                { id: 'safety', label: 'Hoisting Utilization', value: '94.5%', trend: '-1.1%', trendType: 'negative', target: '96.0%', details: 'Skip count variance' },
                { id: 'maintenance', label: 'Maint. Backlog', value: '420h', trend: '-20h', trendType: 'positive', target: '300h', details: 'Conveyor Repairs' }
            ],
            equipment: [
                { name: 'Production Hoist (K3)', status: 'Warning', efficiency: '89%', health: '78%', param: 'Rope Tension' },
                { name: 'Underground Conveyor (CV-05)', status: 'Critical', efficiency: '62%', health: '45%', param: 'Belt Thickness/Splice' },
                { name: 'Rod Mill #2', status: 'Optimal', efficiency: '92%', health: '85%', param: 'Vibration' },
                { name: 'Crystallizer Train A', status: 'Optimal', efficiency: '94%', health: '91%', param: 'Temp Profile' },
                { name: 'Compactor', status: 'Warning', efficiency: '81%', health: '70%', param: 'Hydraulic Pressure' }
            ],
            optimization: {
                title: "Mill Process Optimization",
                params: [
                    { id: 'reagent_dos', label: 'Flotation Reagent', min: 10, max: 50, current: 25, unit: 'ppm' },
                    { id: 'crystallizer_temp', label: 'Crystallizer Temp', min: 60, max: 90, current: 82, unit: 'C' },
                    { id: 'dryer_feed', label: 'Dryer Feed Rate', min: 200, max: 400, current: 320, unit: 'TPH' }
                ]
            },
            alerts: [
                { id: 1, title: "Conveyor Splice Failure Risk", description: "CV-05 splice separation", time: "10 mins ago", severity: "critical", equipment: "Conveyor CV-05", action: "Stop & repair" },
                { id: 2, title: "Hoist Rope Anomaly", description: "Magnetic flux leakage >2%", time: "1 hour ago", severity: "high", equipment: "Production Hoist", action: "NDT inspection" },
                { id: 3, title: "Cyclone Efficiency Drop", description: "Underflow deviation", time: "3 hours ago", severity: "medium", equipment: "Cyclone Cluster 4", action: "Check apex valve" }
            ],
            causalNodes: [
                { id: "Low Recovery", group: 1, description: "Mill recovery below plan", impact: "High", mitigation: "Optimize reagents" },
                { id: "Ore Clay Content", group: 2, description: "High clay in feed", impact: "High", mitigation: "Blend control" },
                { id: "Reagent Quality", group: 2, description: "Collector efficiency", impact: "Medium", mitigation: "Supplier QA" },
                { id: "Slimes Circuit", group: 2, description: "Fines removal", impact: "Medium", mitigation: "Screen maintenance" },
                { id: "Desliming Screen", group: 3, description: "Screen blinding", impact: "High", mitigation: "Replace panels" },
                { id: "Brine Temp", group: 3, description: "Crystallization temp", impact: "Medium", mitigation: "Heat exchanger clean" }
            ],
            causalLinks: [
                { source: "Ore Clay Content", target: "Low Recovery", value: 0.9 },
                { source: "Reagent Quality", target: "Low Recovery", value: 0.6 },
                { source: "Slimes Circuit", target: "Low Recovery", value: 0.75 },
                { source: "Desliming Screen", target: "Slimes Circuit", value: 0.85 },
                { source: "Brine Temp", target: "Reagent Quality", value: 0.5 }
            ],
            carbon: { intensity: 0.32, captured: 4150, progress: 35, emissions_trend: [95,92,90,88,85,82,80], capture_trend: [10,12,14,16,18,20,22] },
            turnaround: { duration: 14, baseline: 14, utilization: 95, cost: 8.5, budget: 8.0, risk: "Medium", criticalItems: 2, tasks: [
                { id: 1, name: "Hoist Rope Replacement", duration: 5, progress: 0, critical: true },
                { id: 2, name: "Bin Liner Replacement", duration: 10, progress: 0, critical: false },
                { id: 3, name: "Substation Upgrade", duration: 14, progress: 0, critical: true }
            ]},
            safety: { daysSafe: 89, trir: 0.67, dart: 0.35, fatigueRisk: "High seismic activity near face; increase monitoring." },
            maintenance: {
                workOrders: [
                    { id: "WO-3001", asset: "Conveyor Belt 4 Alignment", priority: "Critical", status: "Scheduled", hours: "2.0h", pclass: "danger" },
                    { id: "WO-3005", asset: "Hoist Rope Lube", priority: "High", status: "In Progress", hours: "4.0h", pclass: "warning" },
                    { id: "WO-3012", asset: "Screen Panel Replacement", priority: "Medium", status: "Pending", hours: "3.5h", pclass: "info" },
                    { id: "WO-3020", asset: "Lighting Check (North)", priority: "Low", status: "Open", hours: "1.0h", pclass: "success" }
                ],
                backlog: "310h", backlogDist: [20, 50, 30] 
            },
            cost: { total: "$0.8M", energy: "$30k", downtime: "$150k", material: "$18k", labor: "$12k" },
            predictive: { 
                alerts: [
                    { title: "Predicted Failure: Conveyor Drive Motor", desc: "Confidence: 94% | Est. Time to Failure: 3 Days", type: "warning", icon: "exclamation-triangle" },
                    { title: "Optimization Opportunity", desc: "Adjust reagent dosing to save 5% chemical cost.", type: "info", icon: "flask" }
                ],
                chartData: Array.from({length: 30}, () => 70 + Math.random() * 20 - Math.random() * 5)
            }
        }
    };

    // Chart instances, etc.
    let chartInstances = {};

    // ==================== UTILITIES ====================
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
        startRealTimeUpdates();
        initializeCharts();
        renderDashboardView();
        initializeAgent();
    });

    function updateDateTime() {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('lastUpdated').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second:'2-digit' });
    }
    function initializeDashboard() { updateDateTime(); setInterval(updateDateTime, 60000); }

    // ==================== CONTEXT SWITCHING ====================
    function switchContext(ctx) {
        state.context = ctx;
        document.getElementById('contextBadge').innerText = ctx === 'nitrogen' ? 'Nitrogen' : 'Potash';
        if (ctx === 'nitrogen') {
            document.getElementById('ctxNitrogen').classList.add('active');
            document.getElementById('ctxPotash').classList.remove('active');
        } else {
            document.getElementById('ctxPotash').classList.add('active');
            document.getElementById('ctxNitrogen').classList.remove('active');
        }
        // re-render current view
        if (state.currentView === 'dashboard') renderDashboardView();
        else if (state.currentView === 'causal') renderCausalView();
        else if (state.currentView === 'planning') renderPlanningView();
        else if (state.currentView === 'safety') renderSafetyView();
        else if (state.currentView === 'carbon') renderCarbonView();
        
        updatePageHeader(state.currentView);
    }

    // ==================== NAVIGATION ====================
    function navigate(viewId) {
        state.currentView = viewId;
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        
        const viewEl = document.getElementById(`view-${viewId}`);
        if(viewEl) viewEl.classList.remove('d-none');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(event && event.currentTarget) event.currentTarget.classList.add('active');
        
        updatePageHeader(viewId);
        
        if (viewId === 'dashboard') renderDashboardView();
        else if (viewId === 'causal') renderCausalView();
        else if (viewId === 'planning') renderPlanningView();
        else if (viewId === 'safety') renderSafetyView();
        else if (viewId === 'carbon') renderCarbonView();
        else if (viewId === 'proposal') { /* static, no heavy render */ }
    }

    function updatePageHeader(viewId) {
        const data = enhancedDataConfig[state.context];
        const titles = {
            dashboard: data.title, 
            causal: 'Root Cause AI Analysis', 
            planning: 'Planning & Optimization', 
            safety: 'Safety & Compliance', 
            carbon: 'Carbon & Sustainability', 
            settings: 'System Configuration',
            proposal: 'Partnership Proposal'
        };
        document.getElementById('pageTitle').textContent = titles[viewId] || 'OpsEdge';
    }

    // ========== PLANNING & OPTIMIZATION VIEW ==========
    let currentPlanningTab = 'cost';
    
    function renderPlanningView() {
        renderCostTab();
        renderTurnaroundTab();
    }
    
    function switchPlanningTab(tab) {
        // Redundant with combined view
    }
    
    function renderCostTab() {
        const d = enhancedDataConfig[state.context].cost;
        if (!d) return;
        
        // Update cost totals
        document.getElementById('costTotal').innerText = `$${d.total || '1.2M'}`;
        document.getElementById('savingsEnergy').innerText = `$${d.savingsEnergy || '45k'}`;
        document.getElementById('savingsDowntime').innerText = `$${d.savingsDowntime || '120k'}`;
        document.getElementById('savingsMaterial').innerText = `$${d.savingsMaterial || '12k'}`;
        document.getElementById('savingsLabor').innerText = `$${d.savingsLabor || '8k'}`;
        
        initializeCostCharts();
    }
    
    function initializeCostCharts() {
        // Cost Distribution Pie Chart
        if (chartInstances.costDist) chartInstances.costDist.destroy();
        const ctx1 = document.getElementById('costDistributionChart')?.getContext('2d');
        if (ctx1) {
            chartInstances.costDist = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Labor', 'Energy', 'Materials', 'Maintenance', 'Other'],
                    datasets: [{
                        data: [380, 290, 240, 180, 110],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Cost Trend Line Chart
        if (chartInstances.costTrend) chartInstances.costTrend.destroy();
        const ctx2 = document.getElementById('costTrendChart')?.getContext('2d');
        if (ctx2) {
            const days = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
            });
            
            chartInstances.costTrend = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [
                        {
                            label: 'Actual Cost',
                            data: [165, 172, 158, 168, 175, 162, 170],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Budget',
                            data: [180, 180, 180, 180, 180, 180, 180],
                            borderColor: '#94a3b8',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) { return '$' + value + 'k'; }
                            }
                        }
                    }
                }
            });
        }
    }
    
    function updateCostPeriod(period) {
        // Re-render with new data
        initializeCostCharts();
    }
    
    function updateCostTrend(days) {
        if (chartInstances.costTrend) {
            let labels = [];
            let data = [];
            for (let i = days; i > 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - (days - i));
                labels.push(d.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
                data.push(150 + Math.random() * 30);
            }
            chartInstances.costTrend.data.labels = labels;
            chartInstances.costTrend.data.datasets[0].data = data;
            chartInstances.costTrend.update();
        }
    }
    
    function showCostDetail(category) {
        // Details shown to user in dashboard cards if needed, removing chatbot response
    }

    // ==================== RENDER DASHBOARD ====================
    function renderDashboardView() {
        const d = enhancedDataConfig[state.context];
        // update KPI texts and titles
        document.getElementById('kpi1Title').innerText = d.kpis[0].label;
        document.getElementById('kpi2Title').innerText = d.kpis[1].label;
        document.getElementById('kpi3Title').innerText = d.kpis[2].label;
        document.getElementById('kpi4Title').innerText = d.kpis[3].label;
        
        document.getElementById('kpi1Value').innerText = d.kpis[0].value;
        document.getElementById('kpi2Value').innerText = d.kpis[1].value;
        document.getElementById('kpi3Value').innerText = d.kpis[2].value;
        document.getElementById('kpi4Value').innerText = d.kpis[3].value;
        document.getElementById('kpi1Trend').innerHTML = `<i class="fas fa-arrow-${d.kpis[0].trendType==='positive'?'up':'down'}"></i> ${d.kpis[0].trend}`;
        document.getElementById('kpi2Trend').innerHTML = `<i class="fas fa-arrow-${d.kpis[1].trendType==='positive'?'up':'down'}"></i> ${d.kpis[1].trend}`;
        document.getElementById('kpi3Trend').innerHTML = `<i class="fas ${d.kpis[2].trendType==='positive'?'fa-check-circle':d.kpis[2].trendType==='warning'?'fa-exclamation-triangle':'fa-arrow-down'}"></i> ${d.kpis[2].trend}`;
        document.getElementById('kpi4Trend').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${d.kpis[3].trend}`;
        document.getElementById('kpi1Label').innerHTML = `Target: ${d.kpis[0].target}`;
        document.getElementById('kpi2Label').innerHTML = `Target: ${d.kpis[1].target}`;
        document.getElementById('kpi3Label').innerHTML = `${d.kpis[2].details}`;
        document.getElementById('kpi4Label').innerHTML = `${d.kpis[3].details}`;
        renderAlerts(d.alerts);
        renderEquipmentTable(d.equipment);
        renderOptimizationPanel(d.optimization);
        initializeDashboardCostChart();
        updateProductionChart();
    }
    
    function refreshDashboardData() {
        // Simulate data refresh with slight variations
        const btn = event.currentTarget;
        const icon = btn.querySelector('i');
        
        // Animate refresh button
        icon.classList.add('fa-spin');
        btn.disabled = true;
        
        setTimeout(() => {
            renderDashboardView();
            updateDateTime();
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }, 1000);
    }

    function renderAlerts(alerts) {
        const container = document.getElementById('alertList');
        container.innerHTML = '';
        alerts.forEach(a => {
            container.innerHTML += `<div class="alert-card alert-${a.severity}">
                <div class="d-flex justify-content-between"><div><div class="fw-bold">${a.title}</div>
                <div class="small text-muted mt-1">${a.description}</div><div class="small mt-2"><i class="fas fa-clock me-1"></i>${a.time}</div></div>
                <span class="alert-severity severity-${a.severity}">${a.severity}</span></div>
                <div class="mt-2"><button class="btn btn-sm btn-outline-primary" onclick="acknowledgeAlert(${a.id})"><i class="fas fa-check me-1"></i>Acknowledge</button>
                <button class="btn btn-sm btn-primary ms-2" onclick="viewAlertDetails(${a.id})"><i class="fas fa-search"></i> Details</button></div></div>`;
        });
        document.getElementById('alertCount').innerText = alerts.length;
    }

    function renderEquipmentTable(eq) {
        let html = '';
        eq.forEach((e, index) => {
            let statusColor = e.status==='Optimal'?'success': e.status==='Warning'?'warning':'danger';
            html += `<tr class="cursor-pointer" onclick="showEquipmentDetails('${e.name}', '${e.status}', '${e.param}', '${e.efficiency}', '${e.health}')" style="transition: background 0.2s;">
            <td><div class="fw-bold">${e.name}</div><div class="small text-muted">${e.status}</div></td>
            <td><span class="badge bg-${statusColor}">${e.status}</span></td>
            <td><div class="small fw-bold">${e.param}</div></td>
            <td><div class="progress" style="height:6px;"><div class="progress-bar bg-${parseInt(e.efficiency)>85?'success':'warning'}" style="width:${e.efficiency}"></div></div><div class="small text-center">${e.efficiency}</div></td>
            <td><div class="progress" style="height:6px;"><div class="progress-bar bg-${parseInt(e.health)>75?'success':'danger'}" style="width:${e.health}"></div></div><div class="small text-center">${e.health}</div></td></tr>`;
        });
        document.getElementById('equipmentTable').innerHTML = html;
    }
    
    function initializeDashboardCostChart() {
        // Dashboard Cost Distribution Pie Chart
        if (chartInstances.dashCost) chartInstances.dashCost.destroy();
        const ctx = document.getElementById('costChart')?.getContext('2d');
        if (ctx) {
            chartInstances.dashCost = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Energy', 'Labor', 'Materials', 'Maintenance', 'Other'],
                    datasets: [{
                        data: [35, 28, 18, 12, 7],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
    
    function showEquipmentDetails(name, status, param, efficiency, health) {
        // Equipment details can be shown in a modal if needed, removing automatic chatbot response
    }

    function renderOptimizationPanel(opt) {
        if (!opt) return;
        document.getElementById('optTitle').innerText = opt.title;
        let html = '';
        opt.params.forEach(p => {
            html += `<div class="mb-4 bg-light p-3 rounded border">
                <label class="form-label d-flex justify-content-between fw-bold mb-2">
                    <span class="text-dark">${p.label}</span>
                    <span class="badge bg-primary rounded-pill fw-normal" id="val-${p.id}">${p.current}${p.unit}</span>
                </label>
                <input type="range" class="form-range" min="${p.min}" max="${p.max}" step="0.1" value="${p.current}"
                    oninput="updateOptValue('${p.id}', this.value, '${p.unit}')">
                <div class="d-flex justify-content-between small text-muted mt-1">
                    <span>${p.min}${p.unit}</span>
                    <span>${p.max}${p.unit}</span>
                </div>
            </div>`;
        });
        document.getElementById('optControls').innerHTML = html;
        
        // Initialize Optimization Chart
        initOptimizationChart();
    }

    let optChartInstance;
    function initOptimizationChart() {
        const ctx = document.getElementById('optimizationChart');
        if(!ctx) return;
        if(optChartInstance) optChartInstance.destroy();

        optChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 20}, (_, i) => i + 1),
                datasets: [{
                    label: 'Current Efficiency',
                    data: Array.from({length: 20}, () => 85 + Math.random() * 2), // Baseline slightly noisy
                    borderColor: '#94a3b8',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                }, {
                    label: 'Simulated Efficiency',
                    data: Array.from({length: 20}, () => 85 + Math.random() * 2), // Initial same as baseline
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: { min: 80, max: 100, title: { display: true, text: 'Efficiency %' } },
                    x: { display: false }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });
    }

    function updateOptValue(id, val, unit) { 
        document.getElementById(`val-${id}`).innerHTML = `${parseFloat(val).toFixed(1)}${unit}`; 
        document.getElementById('simResults').classList.add('d-none');
        
        // Update Chart Dynamically
        if(optChartInstance) {
            const factor = (parseFloat(val) / 50) + 0.8; // Random logic for demo
            optChartInstance.data.datasets[1].data = optChartInstance.data.datasets[1].data.map(v => 85 + (Math.random() * 5 * factor));
            optChartInstance.update('none'); // Update without full re-render
        }
    }

    function applyOptimization() {
        const savings = (state.context==='nitrogen'?45000:85000 + Math.floor(Math.random()*20000));
        
        // Animate simulated savings
        const resultsEl = document.getElementById('simResults');
        resultsEl.classList.remove('d-none', 'fade-in');
        void resultsEl.offsetWidth; // trigger reflow
        resultsEl.classList.add('fade-in'); // Add animation class if I define it, or just rely on CSS transition
        
        // Simple counter animation logic
        let current = 0;
        const duration = 1500;
        const startTime = performance.now();
        
        function animate(time) {
            let timeFraction = (time - startTime) / duration;
            if (timeFraction > 1) timeFraction = 1;
            
            const progress = 1 - Math.pow(1 - timeFraction, 3); // easeOutCubic
            const val = Math.floor(progress * savings);
            
            document.getElementById('simSavings').innerHTML = '$' + val.toLocaleString();
            
            if (timeFraction < 1) requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
    }

    // ========== CAUSAL CHART (ENHANCED) ==========
    let causalSim = null; // Initialize to null to avoid reference errors

    // ========== AI WORKFLOW FUNCTIONS ==========
    let workflowTimer = null;
    let currentWorkflowStep = -1;

    function showCompleteRCAReport() {
        // Clear any existing timers
        if (workflowTimer) {
            clearTimeout(workflowTimer);
            workflowTimer = null;
        }
        
        // Mark all progress dots as completed
        for (let i = 0; i <= 5; i++) {
            const dot = document.getElementById(`progress-${i}`);
            if (dot) dot.classList.add('completed');
            
            if (i < 5) {
                const line = document.getElementById(`line-${i}`);
                if (line) line.classList.add('completed');
            }
        }
        
        // Show and complete all workflow steps immediately
        for (let i = 0; i <= 5; i++) {
            const step = document.getElementById(`workflow-step-${i}`);
            if (step) {
                step.classList.add('active', 'completed');
                step.style.opacity = '1';
                step.style.filter = 'none';
            }
        }
        
        // Activate all agent panels immediately
        const agents = ['pattern', 'causal', 'domain', 'simulation'];
        agents.forEach((agent) => {
            const panel = document.getElementById(`agent-${agent}`);
            if (panel) panel.classList.add('active');
            showAgentFindings(agent);
        });
        
        // Update agent status
        document.getElementById('agentStatus').textContent = 'All Agents Complete';
        document.getElementById('agentStatus').classList.remove('bg-primary');
        document.getElementById('agentStatus').classList.add('bg-success');
        
        // Render causal graph and factor analysis immediately
        renderCausalGraph(enhancedDataConfig[state.context].causalNodes, enhancedDataConfig[state.context].causalLinks);
        renderFactorAnalysis(enhancedDataConfig[state.context].causalLinks);
        highlightCriticalPath();
        
        currentWorkflowStep = 5;
    }
    
    function showAgentFindings(agentId) {
        const findings = {
            pattern: '<div><strong>Pattern Identified:</strong> Cyclical pressure drop pattern detected every 72 hours. <span class="badge bg-danger">High Confidence: 89%</span></div><div class="small text-muted mt-2"> Peak deviations occur at 03:00-06:00 shift change<br> Correlates with catalyst activity decline (r=0.89)<br> Similar pattern observed in 3 historical cases<br> Predicted next occurrence: 18 hours</div>',
            causal: '<div class="small"><strong>5 Whys Root Cause Analysis:</strong><br><div class="ps-3 mt-2" style="border-left: 3px solid #3b82f6;"><strong>1.</strong> Why pressure drop?  <em>Reduced reaction rate</em><br><strong>2.</strong> Why reduced rate?  <em>Lower catalyst activity (23% decline)</em><br><strong>3.</strong> Why lower activity?  <em>Surface poisoning detected</em><br><strong>4.</strong> Why poisoning?  <em>Sulfur contamination (0.8 ppm HS)</em><br><strong>5.</strong> Why contamination?  <em class="text-danger">Upstream guard bed saturated</em></div><div class="mt-2 p-2 bg-danger bg-opacity-10 rounded"><i class="fas fa-exclamation-circle text-danger me-1"></i><strong>Root Cause:</strong> Guard bed replacement overdue by 240 operating hours</div></div>',
            domain: '<div class="small"><strong>Industry Standards & Benchmarks:</strong><br><table class="table table-sm table-borderless mt-2"><tr><td><i class="fas fa-check-circle text-success me-1"></i>Normal catalyst life:</td><td><strong>18-24 months</strong></td></tr><tr><td><i class="fas fa-times-circle text-danger me-1"></i>Current performance:</td><td><strong>14 months</strong></td></tr><tr><td><i class="fas fa-arrow-down text-warning me-1"></i>Deviation:</td><td><strong>-22% below benchmark</strong></td></tr></table><div class="mt-2 p-2 bg-info bg-opacity-10 rounded"><strong>Similar Cases Found:</strong> 3 incidents<br><span class="small"> Avg resolution time: 36 hours<br> Success rate with guard bed replacement: 94%</span></div></div>',
            simulation: '<div><strong>What-If Scenario Analysis:</strong></div><div class="simulation-slider mt-2"><label>Catalyst Activity: <span id="sim-catalyst" class="fw-bold">75%</span></label><input type="range" min="50" max="100" value="75" oninput="updateSimulation(\'catalyst\', this.value)" class="form-range"></div><div class="simulation-slider"><label>Reformer Temperature: <span id="sim-temp" class="fw-bold">385C</span></label><input type="range" min="370" max="400" value="385" oninput="updateSimulation(\'temp\', this.value)" class="form-range"></div><div class="mt-3 p-2 rounded" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #3b82f6;"><div class="small text-muted">Predicted Process Efficiency:</div><div class="h4 mb-0 text-primary" id="sim-output">82%</div><div class="small text-muted">Production rate: 1,025 TPD</div></div>'
        };
        
        const findingEl = document.getElementById(`${agentId}-finding`);
        if (findingEl) {
            findingEl.innerHTML = findings[agentId];
        }
    }

    function startAIWorkflow() {
        if (workflowTimer) return; // Already running
        resetAIWorkflow();
        currentWorkflowStep = 0;
        runWorkflowStep(0);
    }

    function runWorkflowStep(step) {
        if (step > 5) {
            workflowTimer = null;
            return;
        }

        // Smooth scroll to current step
        setTimeout(() => {
            const stepEl = document.getElementById(`workflow-step-${step}`);
            if (stepEl) {
                stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 300);

        // Update progress indicators with animation
        document.getElementById(`progress-${step}`).classList.add('active');
        if (step > 0) {
            document.getElementById(`progress-${step-1}`).classList.remove('active');
            document.getElementById(`progress-${step-1}`).classList.add('completed');
            document.getElementById(`line-${step-1}`).classList.add('completed');
        }

        // Activate workflow step with delay for smooth transition
        setTimeout(() => {
            const stepEl = document.getElementById(`workflow-step-${step}`);
            if (stepEl) {
                stepEl.classList.add('active');
                if (step > 0) {
                    const prevStep = document.getElementById(`workflow-step-${step-1}`);
                    if (prevStep) prevStep.classList.add('completed');
                }
            }
        }, 200);

        // Execute step-specific logic
        switch(step) {
            case 0:
                // Anomaly detected
                workflowTimer = setTimeout(() => runWorkflowStep(1), 2500);
                break;
            case 1:
                // Multi-agent analysis
                runMultiAgentAnalysis();
                workflowTimer = setTimeout(() => runWorkflowStep(2), 9000);
                break;
            case 2:
                // Root cause visualization
                setTimeout(() => {
                    renderCausalGraph(enhancedDataConfig[state.context].causalNodes, enhancedDataConfig[state.context].causalLinks);
                    renderFactorAnalysis(enhancedDataConfig[state.context].causalLinks);
                }, 500);
                workflowTimer = setTimeout(() => {
                    highlightCriticalPath();
                    runWorkflowStep(3);
                }, 4000);
                break;
            case 3:
                // AI Insights
                workflowTimer = setTimeout(() => runWorkflowStep(4), 3500);
                break;
            case 4:
                // Impact assessment
                workflowTimer = setTimeout(() => runWorkflowStep(5), 3000);
                break;
            case 5:
                // Knowledge capture
                document.getElementById(`progress-${step}`).classList.remove('active');
                document.getElementById(`progress-${step}`).classList.add('completed');
                workflowTimer = null;
                break;
        }
        currentWorkflowStep = step;
    }

    function runMultiAgentAnalysis() {
        const agents = ['pattern', 'causal', 'domain', 'simulation'];
        
        agents.forEach((agent, index) => {
            setTimeout(() => {
                activateAgent(agent);
                setTimeout(() => deactivateAgent(agent), 1500);
            }, index * 1800);
        });

        setTimeout(() => {
            document.getElementById('agentStatus').textContent = 'Analysis Complete';
            document.getElementById('agentStatus').classList.remove('bg-primary');
            document.getElementById('agentStatus').classList.add('bg-success');
        }, agents.length * 1800);
    }

    function activateAgent(agentId) {
        const panel = document.getElementById(`agent-${agentId}`);
        if (!panel) return;
        
        panel.classList.add('active');
        
        // Show "analyzing" first
        const analyzingTexts = {
            pattern: 'Scanning 90 days of time-series data...',
            causal: 'Building causal inference model...',
            domain: 'Querying knowledge base (12,847 cases)...',
            simulation: 'Running Monte Carlo simulation...'
        };
        
        document.getElementById(`${agentId}-finding`).innerHTML = `<div class="text-muted small"><i class="fas fa-spinner fa-spin me-2"></i>${analyzingTexts[agentId]}</div>`;
        
        // Update findings after delay
        const findings = {
            pattern: '<div><strong>Pattern Identified:</strong> Cyclical pressure drop pattern detected every 72 hours. <span class="badge bg-danger">High Confidence: 89%</span></div><div class="small text-muted mt-2"> Peak deviations occur at 03:00-06:00 shift change<br> Correlates with catalyst activity decline (r=0.89)<br> Similar pattern observed in 3 historical cases<br> Predicted next occurrence: 18 hours</div>',
            causal: '<div class="small"><strong>5 Whys Root Cause Analysis:</strong><br><div class="ps-3 mt-2" style="border-left: 3px solid #3b82f6;"><strong>1.</strong> Why pressure drop?  <em>Reduced reaction rate</em><br><strong>2.</strong> Why reduced rate?  <em>Lower catalyst activity (23% decline)</em><br><strong>3.</strong> Why lower activity?  <em>Surface poisoning detected</em><br><strong>4.</strong> Why poisoning?  <em>Sulfur contamination (0.8 ppm HS)</em><br><strong>5.</strong> Why contamination?  <em class="text-danger">Upstream guard bed saturated</em></div><div class="mt-2 p-2 bg-danger bg-opacity-10 rounded"><i class="fas fa-exclamation-circle text-danger me-1"></i><strong>Root Cause:</strong> Guard bed replacement overdue by 240 operating hours</div></div>',
            domain: '<div class="small"><strong>Industry Standards & Benchmarks:</strong><br><table class="table table-sm table-borderless mt-2"><tr><td><i class="fas fa-check-circle text-success me-1"></i>Normal catalyst life:</td><td><strong>18-24 months</strong></td></tr><tr><td><i class="fas fa-times-circle text-danger me-1"></i>Current performance:</td><td><strong>14 months</strong></td></tr><tr><td><i class="fas fa-arrow-down text-warning me-1"></i>Deviation:</td><td><strong>-22% below benchmark</strong></td></tr></table><div class="mt-2 p-2 bg-info bg-opacity-10 rounded"><strong>Similar Cases Found:</strong> 3 incidents<br><span class="small"> Avg resolution time: 36 hours<br> Success rate with guard bed replacement: 94%</span></div></div>',
            simulation: '<div><strong>What-If Scenario Analysis:</strong></div><div class="simulation-slider mt-2"><label>Catalyst Activity: <span id="sim-catalyst" class="fw-bold">75%</span></label><input type="range" min="50" max="100" value="75" oninput="updateSimulation(\'catalyst\', this.value)" class="form-range"></div><div class="simulation-slider"><label>Reformer Temperature: <span id="sim-temp" class="fw-bold">385C</span></label><input type="range" min="370" max="400" value="385" oninput="updateSimulation(\'temp\', this.value)" class="form-range"></div><div class="mt-3 p-2 rounded" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #3b82f6;"><div class="small text-muted">Predicted Process Efficiency:</div><div class="h4 mb-0 text-primary" id="sim-output">82%</div><div class="small text-muted">Production rate: 1,025 TPD</div></div>'
        };
        
        setTimeout(() => {
            document.getElementById(`${agentId}-finding`).innerHTML = findings[agentId];
        }, 1200);
    }

    function deactivateAgent(agentId) {
        // Keep the content but reduce the glow
        // Don't fully deactivate to show all agents worked
    }

    function updateSimulation(param, value) {
        if (param === 'catalyst') {
            document.getElementById('sim-catalyst').textContent = value + '%';
            const output = Math.round(value * 0.95 + 10);
            document.getElementById('sim-output').textContent = output + '% efficiency';
        } else if (param === 'temp') {
            document.getElementById('sim-temp').textContent = value + 'C';
        }
    }

    function resetAIWorkflow() {
        if (workflowTimer) {
            clearTimeout(workflowTimer);
            workflowTimer = null;
        }
        
        currentWorkflowStep = -1;
        
        // Reset progress indicators
        for (let i = 0; i <= 5; i++) {
            const dot = document.getElementById(`progress-${i}`);
            if (dot) {
                dot.classList.remove('active', 'completed');
            }
            if (i < 5) {
                const line = document.getElementById(`line-${i}`);
                if (line) line.classList.remove('completed');
            }
        }
        
        // Reset workflow steps
        for (let i = 0; i <= 5; i++) {
            const step = document.getElementById(`workflow-step-${i}`);
            if (step) {
                step.classList.remove('active', 'completed');
            }
        }
        
        // Reset agents
        const agents = ['pattern', 'causal', 'domain', 'simulation'];
        agents.forEach(agent => {
            const panel = document.getElementById(`agent-${agent}`);
            if (panel) {
                panel.classList.remove('active');
            }
            const finding = document.getElementById(`${agent}-finding`);
            if (finding) {
                const defaultTexts = {
                    pattern: 'Scanning historical data patterns...',
                    causal: 'Building causal relationships...',
                    domain: 'Consulting knowledge base...',
                    simulation: 'Running simulations...'
                };
                finding.textContent = defaultTexts[agent];
            }
        });
        
        // Reset agent status
        const statusBadge = document.getElementById('agentStatus');
        if (statusBadge) {
            statusBadge.textContent = 'Ready';
            statusBadge.classList.remove('bg-success');
            statusBadge.classList.add('bg-primary');
        }
        
        // Clear causal graph
        const graphContainer = document.getElementById('causalGraph');
        if (graphContainer) graphContainer.innerHTML = '';
        
        // Reset KPIs
        resetImpactKPIs();
        
        // Don't hide workflow if we're in it, just reset state
    }

    function applyRemediation() {
        const kpis = ['efficiency', 'downtime', 'cost', 'savings'];
        kpis.forEach((kpi, index) => {
            setTimeout(() => {
                const kpiEl = document.getElementById(`kpi-${kpi}`);
                if (kpiEl) kpiEl.classList.add('improved');
            }, index * 200);
        });
    }

    function resetImpactKPIs() {
        const kpis = ['efficiency', 'downtime', 'cost', 'savings'];
        kpis.forEach(kpi => {
            const kpiEl = document.getElementById(`kpi-${kpi}`);
            if (kpiEl) kpiEl.classList.remove('improved');
        });
    }

    // Knowledge Capture Functions
    function viewHistoricalAnomalies() {
        // Logic to show historical anomalies, removing chatbot message
    }

    function downloadRCAReport() {
        // Logic to download report, removing chatbot message
    }

    function shareRCA() {
        // Logic to share RCA, removing chatbot message
    }

    function addToRunbook() {
        // Logic to add to runbook, removing chatbot message
    }

    function scheduleFollowup() {
        // Logic to schedule follow-up, removing chatbot message
    }

    // ========== CAUSAL VIEW FUNCTIONS ==========
    function renderCausalView() {
        const d = enhancedDataConfig[state.context];
        
        // Show anomaly dashboard first
        document.getElementById('anomaly-dashboard').style.display = '';
        document.getElementById('historical-rca').style.display = '';
        document.getElementById('workflow-container').style.display = 'none';
        
        // Populate anomaly feed
        loadAnomalyFeed();
        
        // Load historical cases
        loadHistoricalCases();
        
        // Make all workflow steps visible but inactive
        for (let i = 0; i <= 5; i++) {
            const step = document.getElementById(`workflow-step-${i}`);
            if (step) {
                step.classList.remove('active', 'completed');
            }
        }
    }

    // Anomaly Feed Functions
    function loadAnomalyFeed() {
        const feed = document.getElementById('anomaly-feed');
        const anomalies = [
            {
                id: 'ANO-2026-0245',
                severity: 'critical',
                title: 'Unexpected Pressure Drop',
                description: 'Ammonia Synthesis Loop - 12% below normal operating range',
                equipment: 'Synthesis Converter',
                detected: '2 hours ago',
                status: 'Active'
            },
            {
                id: 'ANO-2026-0243',
                severity: 'high',
                title: 'Temperature Oscillation',
                description: 'Reformer outlet temperature varies 8C',
                equipment: 'Primary Reformer H-101',
                detected: '5 hours ago',
                status: 'Active'
            },
        ];
        
        if (anomalies.length === 0) {
            feed.innerHTML = `
                <div class="no-anomalies">
                    <i class="fas fa-check-circle"></i>
                    <div class="fw-bold">No Active Anomalies</div>
                    <div class="small">All systems operating normally</div>
                </div>
            `;
        } else {
            let html = '';
            anomalies.forEach(anomaly => {
                const severityColors = {
                    critical: { bg: '#ef4444', text: 'white' },
                    high: { bg: '#f59e0b', text: 'white' },
                    medium: { bg: '#3b82f6', text: 'white' }
                };
                const color = severityColors[anomaly.severity];
                
                html += `
                    <div class="anomaly-item ${anomaly.severity}" onclick="startAnalysisForAnomaly('${anomaly.id}', '${anomaly.title}', '${anomaly.description}')">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-exclamation-triangle" style="color: ${color.bg};"></i>
                                <strong>${anomaly.title}</strong>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="anomaly-badge" style="background: ${color.bg}; color: ${color.text};">
                                    ${anomaly.severity.toUpperCase()}
                                </span>
                                <span class="badge bg-secondary">${anomaly.status}</span>
                            </div>
                        </div>
                        <div class="text-muted small mb-2">
                            <strong>ID:</strong> ${anomaly.id} | 
                            <strong>Equipment:</strong> ${anomaly.equipment} | 
                            <strong>Detected:</strong> ${anomaly.detected}
                        </div>
                        <div class="mb-2">${anomaly.description}</div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); startAnalysisForAnomaly('${anomaly.id}', '${anomaly.title}', '${anomaly.description}')">
                                <i class="fas fa-file-alt me-1"></i>View RCA Report
                            </button>
                        </div>
                    </div>
                `;
            });
            feed.innerHTML = html;
        }
    }

    function startAnalysisForAnomaly(id, title, description) {
        // Update anomaly details in workflow
        document.getElementById('anomalyTime').textContent = 'Just now';
        document.getElementById('anomalyDesc').textContent = description;
        
        // Hide dashboard, show workflow immediately
        document.getElementById('anomaly-dashboard').style.display = 'none';
        document.getElementById('historical-rca').style.display = 'none';
        document.getElementById('workflow-container').style.display = '';
        
        // Scroll to top of workflow
        document.getElementById('workflow-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Show complete RCA report immediately
        showCompleteRCAReport();
    }
    
    function backToAnomalyDashboard() {
        // Hide workflow, show dashboard
        document.getElementById('workflow-container').style.display = 'none';
        document.getElementById('anomaly-dashboard').style.display = '';
        document.getElementById('historical-rca').style.display = '';
        
        // Scroll to top of dashboard
        document.getElementById('anomaly-dashboard').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function acknowledgeAnomaly(id) {
        addAgentMessage(`Anomaly ${id} acknowledged. Adding to monitoring queue.`);
    }

    // Historical Cases Functions
    function loadHistoricalCases() {
        const tbody = document.getElementById('historical-cases');
        const cases = [
            {
                id: 'RCA-2026-0238',
                date: '2026-02-10',
                issueType: 'Compressor Failure',
                rootCause: 'Bearing degradation',
                status: 'Resolved',
                statusClass: 'success'
            },
            {
                id: 'RCA-2026-0235',
                date: '2026-02-08',
                issueType: 'Quality Deviation',
                rootCause: 'Catalyst poisoning',
                status: 'Implemented',
                statusClass: 'info'
            },
            {
                id: 'RCA-2026-0229',
                date: '2026-02-05',
                issueType: 'Energy Spike',
                rootCause: 'Heat exchanger fouling',
                status: 'Monitoring',
                statusClass: 'warning'
            },
            {
                id: 'RCA-2026-0224',
                date: '2026-02-01',
                issueType: 'Pressure Fluctuation',
                rootCause: 'Control valve malfunction',
                status: 'Resolved',
                statusClass: 'success'
            }
        ];
        
        let html = '';
        cases.forEach(c => {
            html += `
                <tr>
                    <td><strong>${c.id}</strong></td>
                    <td>${c.date}</td>
                    <td>${c.issueType}</td>
                    <td>${c.rootCause}</td>
                    <td><span class="badge bg-${c.statusClass}">${c.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewHistoricalCase('${c.id}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }

    function viewHistoricalCase(caseId) {
        addAgentMessage(`Loading historical RCA case ${caseId}...`);
        // In real implementation, this would load and display the full case
        alert(`Viewing case ${caseId}\n\nThis would show:\n- Full anomaly timeline\n- Multi-agent analysis results\n- Causal graph\n- Implemented solutions\n- Outcome metrics`);
    }

    function loadMoreHistoricalCases() {
        addAgentMessage('Refreshing historical RCA cases from database...');
        setTimeout(() => {
            loadHistoricalCases();
        }, 500);
    }

    // Log Upload Functions
    let uploadedLogFile = null;

    function handleLogUpload(input) {
        if (input.files && input.files[0]) {
            uploadedLogFile = input.files[0];
            const fileName = uploadedLogFile.name;
            const fileSize = (uploadedLogFile.size / 1024).toFixed(2);
            
            document.querySelector('.upload-area').innerHTML = `
                <i class="fas fa-file-alt fa-3x text-success mb-2"></i>
                <div class="fw-bold text-success">${fileName}</div>
                <div class="small text-muted">${fileSize} KB</div>
                <div class="small text-muted mt-2">Click to change file</div>
            `;
            
            document.getElementById('analyzeLogsBtn').disabled = false;
            addAgentMessage(`Log file "${fileName}" uploaded successfully. Ready for analysis.`);
        }
    }

    function analyzeUploadedLogs() {
        if (!uploadedLogFile) return;
        
        addAgentMessage(`Analyzing uploaded log file: ${uploadedLogFile.name}...`);
        
        // Simulate log analysis
        setTimeout(() => {
            // Create a synthetic anomaly from the uploaded logs
            startAnalysisForAnomaly(
                'ANO-LOG-001',
                'Custom Log Analysis',
                `Anomalies detected in ${uploadedLogFile.name}: Multiple error patterns identified`
            );
        }, 1000);
    }

    function cancelWorkflow() {
        if (confirm('Cancel the current RCA workflow?')) {
            resetAIWorkflow();
            
            // Smooth transition back to dashboard
            const workflow = document.getElementById('workflow-container');
            const dashboard = document.getElementById('anomaly-dashboard');
            const historical = document.getElementById('historical-rca');
            
            workflow.style.transition = 'opacity 0.3s ease';
            workflow.style.opacity = '0';
            
            setTimeout(() => {
                workflow.style.display = 'none';
                dashboard.style.display = '';
                historical.style.display = '';
                dashboard.style.opacity = '0';
                historical.style.opacity = '0';
                
                setTimeout(() => {
                    dashboard.style.transition = 'opacity 0.4s ease';
                    historical.style.transition = 'opacity 0.4s ease';
                    dashboard.style.opacity = '1';
                    historical.style.opacity = '1';
                }, 50);
            }, 300);
            
            addAgentMessage(' Workflow cancelled. Returning to anomaly dashboard.');
        }
    }

    
    
    function renderCausalGraph(nodes, links) {
        const container = document.getElementById('causalGraph');
        container.innerHTML = '';
        const w = container.clientWidth, h = container.clientHeight;
        
        // Define gradients
        const svg = d3.select("#causalGraph")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .style("border-radius", "12px")
            .call(d3.zoom().on("zoom", (event) => g.attr("transform", event.transform)));

        // Background grid pattern
        const defs = svg.append("defs");
        const pattern = defs.append("pattern")
            .attr("id", "grid")
            .attr("width", 20)
            .attr("height", 20)
            .attr("patternUnits", "userSpaceOnUse");
        pattern.append("circle")
            .attr("cx", 2)
            .attr("cy", 2)
            .attr("r", 1)
            .attr("fill", "#e2e8f0");
        svg.append("rect")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("fill", "url(#grid)");

        const g = svg.append("g");

        const color = d3.scaleOrdinal()
            .domain([1, 2, 3])
            .range(["#de350b", "#ff9900", "#0052cc"]); // Jira-like colors for clarity

        const sim = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(150))
            .force("charge", d3.forceManyBody().strength(-800))
            .force("center", d3.forceCenter(w / 2, h / 2))
            .force("collide", d3.forceCollide(50));

        // Links with arrowheads
        defs.append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 25)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#94a3b8");

        const link = g.append("g")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("stroke", "#94a3b8")
            .attr("stroke-width", d => Math.max(1, d.value * 4))
            .attr("stroke-opacity", 0.6)
            .attr("marker-end", "url(#arrowhead)");

        const node = g.append("g")
            .selectAll("g")
            .data(nodes)
            .enter().append("g")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        // Node Glow Effect for critical nodes
        node.append("circle")
            .attr("r", d => d.group === 1 ? 35 : d.group === 2 ? 28 : 22)
            .attr("fill", "white")
            .attr("stroke", d => color(d.group))
            .attr("stroke-width", 2)
            .style("filter", "drop-shadow(0px 3px 6px rgba(0,0,0,0.1))")
            .on("mouseover", function(event, d) {
                d3.select(this).attr("stroke-width", 4);
                showTooltip(event, d);
            })
            .on("mouseout", function() {
                d3.select(this).attr("stroke-width", 2);
                hideTooltip();
            })
            .on("click", (event, d) => showNodeDetails(d));

        // Node Icon (using FontAwesome unicode if possible, or just first letter)
        node.append("text")
            .text(d => d.group === 1 ? "!" : d.group === 2 ? "?" : "")
            .attr("text-anchor", "middle")
            .attr("dy", 6)
            .attr("font-family", "Arial")
            .attr("font-weight", "bold")
            .attr("font-size", "18px")
            .attr("fill", d => color(d.group))
            .style("pointer-events", "none");

        // Label below node
        const label = node.append("text")
            .text(d => d.id)
            .attr("text-anchor", "middle")
            .attr("dy", d => (d.group === 1 ? 50 : 45))
            .attr("font-size", "10px")
            .attr("font-weight", "600")
            .attr("fill", "#334155")
            .style("pointer-events", "none")
            .style("text-shadow", "0 1px 2px white");

        sim.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        causalSim = sim;
        
        function dragstarted(event, d) {
            if (!event.active) sim.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) sim.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    // Tooltip logic
    const tooltip = d3.select("body").append("div")
        .attr("class", "d3-tooltip")
        .style("position", "absolute")
        .style("visibility", "hidden")
        .style("background", "rgba(15, 23, 42, 0.9)")
        .style("color", "white")
        .style("padding", "8px 12px")
        .style("border-radius", "6px")
        .style("font-size", "12px")
        .style("pointer-events", "none")
        .style("z-index", "1050");

    function showTooltip(event, d) {
        tooltip.html(`<strong>${d.id}</strong><br/>Impact: ${d.impact}<br/>${d.description}`)
            .style("visibility", "visible")
            .style("top", (event.pageY - 10) + "px")
            .style("left", (event.pageX + 10) + "px");
    }

    function hideTooltip() {
        tooltip.style("visibility", "hidden");
    }

    function showNodeDetails(d) {
        // Node detail logic, removing chatbot response
    }

    function highlightCriticalPath() {
        if (!causalSim) return;
        
        // Find critical nodes (simple logic: group 1 & 2)
        const criticalNodes = enhancedDataConfig[state.context].causalNodes.filter(n => n.group <= 2).map(n => n.id);
        
        d3.selectAll("circle")
            .transition()
            .duration(500)
            .attr("stroke", d => criticalNodes.includes(d.id) ? "#ef4444" : "#cbd5e1")
            .attr("stroke-width", d => criticalNodes.includes(d.id) ? 4 : 1)
            .attr("fill", d => criticalNodes.includes(d.id) ? "#fee2e2" : "white");
            
        d3.selectAll("line")
             .transition()
             .duration(500)
             .attr("stroke", d => (criticalNodes.includes(d.source.id) && criticalNodes.includes(d.target.id)) ? "#ef4444" : "#cbd5e1")
             .attr("stroke-width", d => (criticalNodes.includes(d.source.id) && criticalNodes.includes(d.target.id)) ? 4 : 1);
    }
    
    function resetCausalGraph() { 
        resetAIWorkflow(); 
    }
    
    function runCausalAnalysis() { 
        startAIWorkflow();
    }

    function renderFactorAnalysis(links) {
        const factorDetails = {
            'Catalyst Deactivation': {
                severity: 'Critical',
                description: 'Primary catalyst bed showing 23% activity decline over 14 days',
                metrics: 'Activity: 77%, Pressure Drop: +15%',
                action: 'Schedule regeneration within 48hrs'
            },
            'Steam Ratio low': {
                severity: 'High',
                description: 'S/C ratio below optimal setpoint causing incomplete conversion',
                metrics: 'Current: 2.8, Target: 3.0-3.2',
                action: 'Adjust BFW flow control valve'
            },
            'Feed Gas Sulfur': {
                severity: 'Critical',
                description: 'Sulfur breakthrough detected in feed gas analysis',
                metrics: 'HS: 0.8 ppm (limit: 0.1 ppm)',
                action: 'Replace upstream guard bed immediately'
            },
            'Tube Scaling': {
                severity: 'Medium',
                description: 'Internal deposits reducing heat transfer efficiency',
                metrics: 'T: +12C vs design',
                action: 'Schedule chemical cleaning during next turnaround'
            },
            'Methane Slip': {
                severity: 'Medium',
                description: 'Unconverted methane in reformer outlet exceeds target',
                metrics: 'CH: 3.2% (target: <2.5%)',
                action: 'Increase reformer outlet temperature by 10C'
            }
        };

        let html = '';
        const sortedLinks = links.sort((a,b)=>b.value-a.value);
        
        sortedLinks.forEach((l, index) => {
            const source = typeof l.source === 'object' ? l.source.id : l.source;
            const target = typeof l.target === 'object' ? l.target.id : l.target;
            const detail = factorDetails[source] || { 
                severity: 'Medium', 
                description: 'Contributing factor to root cause',
                metrics: 'Impact correlation: ' + Math.round(l.value*100) + '%',
                action: 'Monitor and assess'
            };
            
            const severityColors = {
                Critical: 'danger',
                High: 'warning',
                Medium: 'info'
            };
            const colorClass = severityColors[detail.severity] || 'secondary';
            
            html += `
                <div class="border-bottom py-3" style="animation: fadeIn 0.4s ease ${index * 0.1}s backwards;">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <div class="fw-bold d-flex align-items-center gap-2">
                                <span>${source}</span>
                                <i class="fas fa-arrow-right text-muted small"></i>
                                <span class="text-muted small">${target}</span>
                            </div>
                            <div class="small text-muted mt-1">${detail.description}</div>
                        </div>
                        <span class="badge bg-${colorClass} ms-2">${Math.round(l.value*100)}%</span>
                    </div>
                    <div class="small mb-2">
                        <i class="fas fa-chart-bar text-primary me-1"></i>
                        <strong>Metrics:</strong> ${detail.metrics}
                    </div>
                    <div class="small text-success">
                        <i class="fas fa-wrench me-1"></i>
                        <strong>Action:</strong> ${detail.action}
                    </div>
                    <div class="progress mt-2" style="height:6px;">
                        <div class="progress-bar bg-${colorClass}" style="width:${l.value*100}%; transition: width 1s ease;"></div>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('factorList').innerHTML = html;
        
        // Update factor count
        const factorCountEl = document.getElementById('factorCount');
        if (factorCountEl) {
            factorCountEl.textContent = sortedLinks.length;
        }
    }

    function initializeCausalCharts() {
        const ctx = document.getElementById('impactChart')?.getContext('2d');
        if(ctx) chartInstances.impact = new Chart(ctx, { type:'bar', data:{ labels:['Catalyst','Temperature','Feed','Steam','Controls'], datasets:[{ label:'Impact', data:[85,72,68,91,78], backgroundColor:['#ef4444','#f59e0b','#3b82f6','#10b981','#8b5cf6'] }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } } } });
    }

    // ========== TURNAROUND (scenario) ==========
    let currentScenario = 'baseline';
    function setTurnaroundScenario(s) { 
        currentScenario = s; 
        document.querySelectorAll('#planning-turnaround-tab .btn-group .btn').forEach(b=>b.classList.remove('active')); 
        event.currentTarget.classList.add('active'); 
        document.getElementById('activeScenarioBadge').innerText = s.charAt(0).toUpperCase()+s.slice(1);
    }
    
    function applyTurnaroundScenario() {
        const d = enhancedDataConfig[state.context].turnaround;
        if (currentScenario === 'aggressive') { 
            d.duration = Math.max(10, d.baseline-4); 
            d.utilization = 88; 
            d.cost = d.budget * 1.1; 
            d.risk = 'Medium'; 
        }
        else if (currentScenario === 'cost') { 
            d.duration = d.baseline+2; 
            d.utilization = 91; 
            d.cost = d.budget * 0.95; 
            d.risk = 'Low'; 
        }
        else { 
            d.duration = d.baseline; 
            d.utilization = 82; 
            d.cost = d.budget * 1.2; 
            d.risk = 'High'; 
        }
        renderTurnaroundTab();
    }
    
    function renderTurnaroundTab() {
        const d = enhancedDataConfig[state.context].turnaround;
        document.getElementById('taDuration').innerText = d.duration + ' Days';
        document.getElementById('taBaselineComp').innerText = `Baseline: ${d.baseline} Days`;
        document.getElementById('taUtilization').innerText = d.utilization + '%';
        document.getElementById('taCost').innerText = `$${d.cost}M`;
        document.getElementById('taRisk').innerText = d.risk;
        renderGanttChart(d.tasks);
        document.getElementById('recList').innerHTML = '<li>Shift 2 electricians to Node B</li><li>Prestage scaffolding for Reformer</li><li>Approve OT for welders on Day 4</li>';
        initializeTurnaroundCharts();
    }
    
    function renderGanttChart(tasks) {
        const timeline = document.getElementById('ganttTimeline'); 
        if (!timeline) return;
        timeline.innerHTML = '';
        for (let i=1;i<=22;i++) timeline.innerHTML += `<div class="gantt-day">D${i}</div>`;
        const tasksDiv = document.getElementById('ganttTasks'); 
        if (!tasksDiv) return;
        tasksDiv.innerHTML = '';
        tasks.forEach((t, index) => {
            tasksDiv.innerHTML += `<div class="gantt-task cursor-pointer" onclick="showTaskDetails('${t.name}', ${t.duration}, ${t.progress}, ${t.critical})" style="transition: background 0.2s;">
                <div class="task-label">${t.name}</div>
                <div class="task-bar">
                    <div class="task-progress ${t.critical?'bg-danger':'bg-primary'}" style="width:${(t.duration/22*100)}%; left:${t.progress}%;">${t.duration}d</div>
                </div>
            </div>`;
        });
    }
    
    function showTaskDetails(name, duration, progress, critical) {
        // Task details shown in dashboard if needed, removing automatic chatbot response
    }
    
    function initializeTurnaroundCharts() {
        if (chartInstances.resource) chartInstances.resource.destroy();
        const ctx = document.getElementById('resourceChart')?.getContext('2d');
        if (ctx) chartInstances.resource = new Chart(ctx, { 
            type:'bar', 
            data:{ 
                labels:['Mech','Elec','Inst','Scaff','Insul'], 
                datasets:[
                    { label:'Allocated', data:[45,32,28,20,15], backgroundColor:'#3b82f6' }, 
                    { label:'Required', data:[50,35,30,25,20], backgroundColor:'#94a3b8' }
                ] 
            }, 
            options:{ 
                responsive:true, 
                maintainAspectRatio:false,
                onClick: (event, activeElements) => {
                    // Resource details shown in dashboard if needed, removing automatic chatbot response
                }
            } 
        });
    }

    // ========== SAFETY ==========
    function renderSafetyView() {
        const d = enhancedDataConfig[state.context].safety;
        document.getElementById('safeDays').innerText = d.daysSafe;
        document.getElementById('trir').innerText = `TRIR: ${d.trir}`;
        document.getElementById('dart').innerText = `DART: ${d.dart}`;
        document.getElementById('safetyRiskMsg').innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>${d.fatigueRisk}`;
        renderSafetyObservations(); 
        renderComplianceStatus(); 
        renderCVAlerts(); 
        initializeSafetyCharts();
    }
    function renderSafetyObservations() {
        const obs = [
            { id: 101, obs:'Improper PPE', loc:'Unit 4', sev:'High', stat:'Open', user:'J. Miller', days:3 },
            { id: 102, obs:'Unsecured Ladder', loc:'Maintenance', sev:'Medium', stat:'In Progress', user:'S. Chen', days:1 },
            { id: 103, obs:'Slippery Floor', loc:'Loading Dock', sev:'Low', stat:'Resolved', user:'A. Davis', days:0 },
            { id: 104, obs:'Missing Guardrail', loc:'Section B-2', sev:'Critical', stat:'Open', user:'M. Wilson', days:5 },
            { id: 105, obs:'Exposed Wiring', loc:'Reformer 3', sev:'High', stat:'In Progress', user:'L. Garcia', days:2 },
            { id: 106, obs:'Tripping Hazard', loc:'Walkway 4', sev:'Medium', stat:'Open', user:'K. White', days:4 }
        ];
        let html=''; 
        obs.forEach((o)=>{ 
            html+=`<tr class="cursor-pointer" onclick="showObservationDetail('${o.obs}', '${o.loc}', '${o.sev}', '${o.stat}', ${o.days})" style="transition: background 0.2s;">
                <td class="small fw-bold">${o.obs}</td>
                <td class="small">${o.loc}</td>
                <td><span class="badge bg-${o.sev==='High' || o.sev==='Critical'?'danger':o.sev==='Medium'?'warning':'success'}">${o.sev}</span></td>
                <td><span class="badge bg-${o.stat==='Open'?'warning':o.stat==='Resolved'?'success':'info'}">${o.stat}</span></td>
                <td class="small">${o.user}</td>
                <td class="small">${o.days}d</td>
                <td><button class="btn btn-xs btn-outline-primary py-0">Review</button></td>
            </tr>`; 
        });
        document.getElementById('safetyObservations').innerHTML = html;
        document.getElementById('openObsCount').innerText = obs.filter(o => o.stat !== 'Resolved').length;
    }
    
    function showObservationDetail(obs, loc, sev, stat, days) {
        // Observation detail logic, removing chatbot response
    }
    
    function renderComplianceStatus() {
        let items = [
            {n:'PSM Standards', v:100, d:'Process Safety Management'},
            {n:'Env Permits', v:100, d:'Air/Water Quality'},
            {n:'OSHA Recordkeeping', v:95, d:'Daily safety logs'},
            {n:'ERP Readiness', v:80, d:'Emergency Response Plan'},
            {n:'Training Matrix', v:85, d:'Skills certification'},
        ];
        let h=''; 
        items.forEach((i)=>{ 
            h+=`<div class="border-bottom py-2 cursor-pointer" onclick="showComplianceDetail('${i.n}', ${i.v})" style="transition: background 0.2s;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold small">${i.n}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">${i.d}</div>
                    </div>
                    <span class="badge bg-${i.v===100?'success':i.v>=90?'primary':i.v>=80?'warning':'danger'}">${i.v}%</span>
                </div>
                <div class="progress mt-1" style="height:4px;">
                    <div class="progress-bar bg-${i.v===100?'success':i.v>=90?'primary':i.v>=80?'warning':'danger'}" style="width:${i.v}%"></div>
                </div>
            </div>`; 
        });
        document.getElementById('complianceList').innerHTML = h;
    }
    
    function showComplianceDetail(name, value) {
        // Compliance detail logic, removing chatbot response
    }
    
    function renderCVAlerts() {
        let html = `
        <div class="d-flex gap-2 p-2 bg-danger bg-opacity-10 rounded cursor-pointer" onclick="showCVDetail('PPE Violation', 'Zone 4', 'Missing Hard Hat', 'Camera-04')">
            <div><i class="fas fa-hard-hat fa-lg text-danger"></i></div>
            <div class="flex-grow-1">
                <div class="fw-bold small text-danger">PPE Violation</div>
                <div class="small text-muted">Zone 4  2m ago</div>
            </div>
        </div>
        <div class="d-flex gap-2 p-2 bg-warning bg-opacity-10 rounded cursor-pointer" onclick="showCVDetail('Exclusion Zone', 'Zone 2', 'Unauthorized Entry', 'Camera-09')">
            <div><i class="fas fa-exclamation-triangle fa-lg text-warning"></i></div>
            <div class="flex-grow-1">
                <div class="fw-bold small text-warning">Exclusion Zone</div>
                <div class="small text-muted">Zone 2  15m ago</div>
            </div>
        </div>
        <div class="d-flex gap-2 p-2 bg-success bg-opacity-10 rounded cursor-pointer" onclick="showCVDetail('Safe Behavior', 'Zone 6', 'Proper LOTO', 'Camera-12')">
            <div><i class="fas fa-check-circle fa-lg text-success"></i></div>
            <div class="flex-grow-1">
                <div class="fw-bold small text-success">Positive</div>
                <div class="small text-muted">Zone 6  32m ago</div>
            </div>
        </div>`;
        document.getElementById('cvAlerts').innerHTML = html;
    }
    
    function showCVDetail(type) {
        // CV Alert detail logic, removing chatbot response
    }
    
    function initializeSafetyCharts() { 
        if(chartInstances.safetyTrends) {
            chartInstances.safetyTrends.destroy();
        }
        
        const ctx = document.getElementById('safetyTrendsChart')?.getContext('2d'); 
        if(ctx) {
            chartInstances.safetyTrends = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'], 
                    datasets: [
                        { 
                            label: 'Observations', 
                            data: [42, 38, 45, 52, 48, 55, 62], 
                            borderColor: '#3b82f6', 
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            borderWidth: 2
                        },
                        { 
                            label: 'Near Miss', 
                            data: [12, 10, 8, 6, 9, 5, 4], 
                            borderColor: '#f59e0b', 
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            borderWidth: 2
                        },
                        { 
                            label: 'Incidents', 
                            data: [2, 1, 0, 1, 0, 0, 0], 
                            borderColor: '#ef4444', 
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            borderWidth: 2,
                            hidden: false
                        }
                    ] 
                }, 
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6,
                                padding: 20,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            padding: 12,
                            titleFont: { size: 13 },
                            bodyFont: { size: 12 },
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        // Safety chart click logic, removing chatbot response
                    }
                } 
            }); 
        } 
    }

    function updateSafetyChart(days) {
        if (!chartInstances.safetyTrends) return;
        
        // Update button states
        const buttons = document.querySelectorAll('button[onclick^="updateSafetyChart"]');
        buttons.forEach(btn => {
            if (btn.innerText.includes(days === 30 ? '30D' : (days === 90 ? '90D' : '1Y'))) {
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-outline-primary');
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            }
        });

        let labels = [];
        let observations = [];
        let nearMisses = [];
        let incidents = [];

        if (days === 30) {
            labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            observations = [12, 15, 14, 18];
            nearMisses = [3, 2, 1, 0];
            incidents = [0, 0, 0, 0];
        } else if (days === 90) {
            labels = ['May', 'Jun', 'Jul'];
            observations = [48, 55, 62];
            nearMisses = [9, 5, 4];
            incidents = [0, 0, 0];
        } else {
            labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
            observations = [42, 38, 45, 52, 48, 55, 62];
            nearMisses = [12, 10, 8, 6, 9, 5, 4];
            incidents = [2, 1, 0, 1, 0, 0, 0];
        }

        chartInstances.safetyTrends.data.labels = labels;
        chartInstances.safetyTrends.data.datasets[0].data = observations;
        chartInstances.safetyTrends.data.datasets[1].data = nearMisses;
        chartInstances.safetyTrends.data.datasets[2].data = incidents;
        chartInstances.safetyTrends.update('active');
    }

    // ========== CARBON ==========
    function renderCarbonView() {
        const d = enhancedDataConfig[state.context].carbon;
        document.getElementById('carbonIntensity').innerText = d.intensity;
        document.getElementById('totalCaptured').innerText = d.captured;
        document.getElementById('goalProgress').style.width = d.progress+'%';
        document.getElementById('goalProgress').innerText = d.progress+'% Achieved';
        document.getElementById('goalStatus').innerText = d.progress>=35?'On Track':'Behind';
        initializeCarbonCharts();
        let statusHtml = `<div class="p-3 border rounded bg-light cursor-pointer" onclick="showCarbonDetail('Absorber')"><div class="d-flex justify-content-between"><span class="fw-bold">Absorber Efficiency</span><span class="badge bg-success">Normal</span></div><div class="h4 mb-0">98.2%</div><small>Target >98%</small></div>`;
        statusHtml += `<div class="p-3 border rounded bg-light cursor-pointer" onclick="showCarbonDetail('Solvent')"><div class="d-flex justify-content-between"><span class="fw-bold">Solvent Quality</span><span class="badge bg-warning">Degradation</span></div><div class="h4 mb-0">84.5%</div><small>Reclaim cycle</small></div>`;
        statusHtml += `<div class="p-3 border rounded bg-light cursor-pointer" onclick="showCarbonDetail('Compression')"><div class="d-flex justify-content-between"><span class="fw-bold">Compression Energy</span><span class="badge bg-success">Optimal</span></div><div class="h4 mb-0">142 kWh/t</div><small>vs 145 design</small></div>`;
        document.getElementById('captureUnitStatus').innerHTML = statusHtml;
        initializeSustainabilityCharts();
    }
    
    function initializeSustainabilityCharts() {
        // Emissions Source Donut Chart
        const ctxSource = document.getElementById('emissionsSourceChart')?.getContext('2d');
        if (ctxSource) {
            new Chart(ctxSource, {
                type: 'doughnut',
                data: {
                    labels: ['Combustion', 'Purchased Power', 'Process'],
                    datasets: [{
                        data: [64, 22, 14],
                        backgroundColor: ['#1e293b', '#0ea5e9', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Energy Intensity Sparkline
        const ctxEnergy = document.getElementById('energyIntensityChart')?.getContext('2d');
        if (ctxEnergy) {
            new Chart(ctxEnergy, {
                type: 'line',
                data: {
                    labels: [1,2,3,4,5,6,7,8,9,10],
                    datasets: [{
                        data: [12.4, 12.2, 12.5, 12.1, 11.9, 11.8, 11.8, 11.6, 11.5, 11.4],
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }
    }
    
    function showCarbonDetail(unit) {
        // Carbon detail logic, removing chatbot response
    }
    function initializeCarbonCharts() {
        if (chartInstances.emissions) chartInstances.emissions.destroy();
        const ctx = document.getElementById('emissionsChart')?.getContext('2d');
        const d = enhancedDataConfig[state.context].carbon;
        if (ctx) chartInstances.emissions = new Chart(ctx, { 
            type:'bar', 
            data:{ 
                labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], 
                datasets:[
                    { label:'Emissions', data:d.emissions_trend, backgroundColor:'#94a3b8' }, 
                    { label:'Captured', data:d.capture_trend, type:'line', borderColor:'#10b981', fill:false, tension:0.4 }
                ] 
            }, 
            options:{ 
                responsive:true, 
                maintainAspectRatio:false,
                onClick: (event, activeElements) => {
                    // Carbon chart click logic, removing chatbot response
                }
            } 
        });
    }
    function updateCarbonChart(days) { 
        initializeCarbonCharts();
    }

    // ========== AGENT ==========
    function toggleAgent() { document.getElementById('agentPanel').classList.toggle('open'); }
    function closeAgentOnBackdrop(event) { if (event.target.id === 'agentPanel') toggleAgent(); }
    function sendQuickPrompt(p) { document.getElementById('chatInput').value = p; sendMessage(); }
    function sendMessage() {
        let msg = document.getElementById('chatInput').value.trim(); if(!msg) return;
        addUserMessage(msg); document.getElementById('chatInput').value='';
        setTimeout(()=>{ addAgentMessage(generateAIResponse(msg)); }, 800);
    }
    function addUserMessage(m) { 
        document.getElementById('chatContainer').innerHTML += `<div class="msg user"><div class="msg-header"><i class="fas fa-user"></i>You</div><div class="msg-content">${m}</div></div>`; 
        scrollChatToBottom();
    }
    function addAgentMessage(m) { 
        document.getElementById('chatContainer').innerHTML += `<div class="msg bot"><div class="msg-header"><i class="fas fa-robot"></i>OpsEdge</div><div class="msg-content">${m}</div></div>`; 
        scrollChatToBottom();
    }
    
    function scrollChatToBottom() {
        const container = document.getElementById('chatContainer');
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }
    
    function generateAIResponse(m) { return "I've analyzed your request. Based on current data, recommend optimizing steam-to-carbon ratio."; }

    // ========== PRODUCTION CHART ==========
    function updateProductionChart() {
        const range = document.getElementById('prodTrendRange').value;
        const days = parseInt(range);
        
        let labels = [];
        let prodData = [];
        let effData = [];
        
        const now = new Date();
        for (let i = days; i > 0; i--) {
            const d = new Date(now);
            d.setDate(d.getDate() - i);
            labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            
            // Generate some random realistic data
            prodData.push(90 + Math.random() * 10 - 5);
            effData.push(88 + Math.random() * 8 - 4);
        }

        if (chartInstances.production) chartInstances.production.destroy();
        const ctx = document.getElementById('productionChart')?.getContext('2d');
        if (ctx) {
            chartInstances.production = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Production (Tonnes)', 
                        data: prodData, 
                        borderColor: '#2563eb', 
                        backgroundColor: 'rgba(37,99,235,0.1)', 
                        tension: 0.4, 
                        fill: true 
                    }, { 
                        label: 'Efficiency (%)', 
                        data: effData, 
                        borderColor: '#10b981', 
                        tension: 0.4,
                        yAxisID: 'y1'
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Production' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                             title: { display: true, text: 'Efficiency %' },
                             min: 80,
                             max: 100
                        },
                    }
                } 
            });
        }
    }

    // ========== MISCELLANEOUS ==========
    function startRealTimeUpdates() { setInterval(()=>{ if(state.currentView==='dashboard') updateProductionChart(); }, 15000); }
    function exportReport() { alert("Report generated (demo)."); }
    function acknowledgeAlert(id) { let idx = enhancedDataConfig[state.context].alerts.findIndex(a=>a.id===id); if(idx>-1) enhancedDataConfig[state.context].alerts.splice(idx,1); renderAlerts(enhancedDataConfig[state.context].alerts); }
    function viewAlertDetails(id) { /* Detail view logic if needed, removing automatic chatbot response */ }

    // initialize everything
    window.onload = function() {
        initializeDashboard(); startRealTimeUpdates(); initializeCharts(); renderDashboardView(); initializeAgent();
    };
    function initializeCharts() {
        ['availability','carbon','safety','maintenance'].forEach((id,i)=>{
            const canvas = document.getElementById(id+'Chart');
            if(canvas) new Chart(canvas.getContext('2d'), { type:'line', data:{ labels:Array.from({length:10},(_,x)=>x+1), datasets:[{ data:Array.from({length:10},()=>80+Math.random()*20), borderColor:i===0?'#2563eb':i===1?'#10b981':i===2?'#f59e0b':'#ef4444', borderWidth:2, fill:false, tension:0.4 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} } });
        });
    }

    // ========== ROI CALCULATOR ==========
    function openRoiModal() {
        const modal = document.getElementById('roiModal');
        modal.classList.add('show');
        modal.style.display = 'block';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        document.body.classList.add('modal-open');
    }

    function closeRoiModal() {
        const modal = document.getElementById('roiModal');
        modal.classList.remove('show');
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }

    function calculateROI() {
        const prod = parseFloat(document.getElementById('roiProduction').value) || 0;
        const opex = parseFloat(document.getElementById('roiOpex').value) || 0;
        const downtime = parseFloat(document.getElementById('roiDowntime').value) || 0;
        const revLoss = parseFloat(document.getElementById('roiRevLoss').value) || 0;

        // Assumptions
        const effGainPct = 0.015; // 1.5% efficiency gain
        const downtimeRedPct = 0.30; // 30% reduction in downtime
        const maintSaving = 1500000; // Fixed estimate for simplicity

        const effSavings = prod * opex * effGainPct;
        const downtimeSavings = downtime * revLoss * downtimeRedPct;
        const total = effSavings + downtimeSavings + maintSaving;

        // Animate numbers
        animateValue("roiEffGain", effSavings);
        animateValue("roiDowntimeGain", downtimeSavings);
        animateValue("roiMaintGain", maintSaving); // Static for now
        animateValue("roiResult", total, "$", "M");
    }

    function animateValue(id, value, prefix="$", suffix="") {
        const element = document.getElementById(id);
        const start = 0;
        const duration = 1000;
        let startTime = null;

        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            const current = Math.floor(progress * (value - start) + start);
            
            let formatted = current.toLocaleString();
            if (suffix === "M") {
                formatted = (current / 1000000).toFixed(1) + "M";
            } else if (current > 1000) {
                 formatted = (current / 1000).toFixed(0) + "k";
            }
            
            element.innerHTML = prefix + formatted;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        }
        window.requestAnimationFrame(step);
    }
</script>
</body>
</html>