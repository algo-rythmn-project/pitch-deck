<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algo-Rythmn.ai | Pharmacy Compliance Intelligence</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* GEN AI PALETTE */
            --primary: #00695C;
            --primary-light: #E0F2F1;
            --primary-dark: #004D40;
            
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --accent-orange: #F59E0B;
            
            --bg-body: #FAFAFA;
            --bg-surface: #FFFFFF;
            --bg-subtle: #F3F4F6;
            
            --text-main: #111827;
            --text-muted: #6B7280;
            
            --border-subtle: #E5E7EB;
            
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-pill: 100px;
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-float: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
            
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 15px;
        }

        /* === LEFT ICON RAIL === */
        .sidebar {
            width: 80px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            z-index: 50;
            flex-shrink: 0;
        }

        .brand-icon {
            width: 40px; height: 40px;
            color: var(--primary); font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 40px;
        }

        .nav-item {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: #9CA3AF; margin-bottom: 12px;
            cursor: pointer; transition: var(--transition);
            position: relative;
        }
        .nav-item:hover, .nav-item.active {
            background: var(--primary-light); color: var(--primary);
        }
        /* Tooltip */
        .nav-item::after {
            content: attr(data-tooltip);
            position: absolute; left: 60px;
            background: #1F2937; color: white;
            padding: 6px 12px; border-radius: 6px;
            font-size: 0.75rem; font-weight: 600;
            opacity: 0; pointer-events: none; transition: 0.2s;
            white-space: nowrap; z-index: 100;
        }
        .nav-item:hover::after { opacity: 1; }

        /* === MAIN CONTENT === */
        .main-content {
            flex: 1; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }

        .top-bar {
            position: absolute; top: 24px; right: 32px; z-index: 10;
            display: flex; align-items: center; gap: 16px;
        }
        .user-pill {
            display: flex; align-items: center; gap: 8px;
            background: var(--bg-surface); padding: 6px 12px;
            border-radius: var(--radius-pill); border: 1px solid var(--border-subtle);
            font-size: 0.85rem; font-weight: 500; cursor: pointer;
        }

        /* VIEWS */
        .view-section {
            width: 100%; height: 100%; overflow-y: auto;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        .view-section.active { display: block; opacity: 1; }

        /* === HOME VIEW (GEN AI STYLE) === */
        #view-home {
            background: linear-gradient(135deg, #FAFAFA 0%, #E0F2F1 50%, #FAFAFA 100%);
            position: relative;
            overflow: hidden;
        }
        
        #view-home::before {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(0, 105, 92, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            top: -200px;
            right: -100px;
            pointer-events: none;
        }
        
        #view-home::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(0, 105, 92, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            bottom: -150px;
            left: -100px;
            pointer-events: none;
        }
        
        .gen-ai-container {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 100%;
            padding: 60px 40px; max-width: 1200px; margin: 0 auto; width: 100%;
            position: relative; z-index: 1;
        }

        .hero-title {
            font-size: 2.5rem; font-weight: 700; color: var(--text-main);
            margin-bottom: 8px; text-align: center; letter-spacing: -1px;
        }
        .hero-subtitle { color: var(--text-muted); margin-bottom: 40px; text-align: center; }

        .prompt-bar-container {
            width: 720px; max-width: 100%; position: relative; 
            margin-bottom: 40px;
            align-self: center;
        }
        .prompt-input {
            width: 100%; padding: 20px 60px 60px 24px;
            border-radius: var(--radius-xl); border: 1px solid var(--border-subtle);
            background: var(--bg-surface); font-size: 1.1rem;
            box-shadow: var(--shadow-card); transition: var(--transition);
        }
        .prompt-input:focus {
            box-shadow: var(--shadow-float); border-color: var(--primary);
        }
        .prompt-submit {
            position: absolute; right: 12px; top: 18px;
            width: 40px; height: 40px; background: var(--primary); color: white;
            border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Query Function Buttons */
        .query-functions {
            position: absolute;
            bottom: 12px;
            left: 16px;
            display: flex; gap: 8px; align-items: center;
        }
        .function-btn {
            display: flex; align-items: center; gap: 6px;
            background: var(--bg-subtle); border: 1px solid var(--border-subtle);
            padding: 6px 12px; border-radius: var(--radius-pill);
            font-size: 0.8rem; font-weight: 500; color: var(--text-main);
            cursor: pointer; transition: var(--transition);
        }
        .function-btn:hover {
            border-color: var(--primary); background: var(--primary-light);
        }
        .function-btn.active {
            background: var(--primary); color: white; border-color: var(--primary);
        }
        .function-btn i {
            font-size: 0.85rem;
        }
        .function-btn .fa-chevron-down {
            font-size: 0.65rem; margin-left: 2px;
        }
        .add-function-btn {
            width: 28px; height: 28px; border-radius: 50%;
            background: var(--bg-subtle); border: 1px solid var(--border-subtle);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: var(--transition); color: var(--text-muted);
            font-size: 0.75rem;
        }
        .add-function-btn:hover {
            border-color: var(--primary); color: var(--primary); background: var(--primary-light);
        }

        /* Action Chips */
        .action-chips {
            display: flex; gap: 12px; margin-bottom: 48px; flex-wrap: wrap; justify-content: center;
        }
        .chip {
            background: var(--bg-surface); border: 1px solid var(--border-subtle);
            padding: 10px 20px; border-radius: var(--radius-pill);
            font-size: 0.9rem; font-weight: 600; color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: var(--transition);
        }
        .chip:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }

        /* WIDGET GRID (Feed & Watchlist) */
        .widget-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; width: 100%;
        }
        
        .widget-card {
            background: var(--bg-surface); padding: 24px;
            border-radius: var(--radius-lg); border: 1px solid var(--border-subtle);
            transition: var(--transition); display: flex; flex-direction: column;
            height: 100%;
            cursor: pointer; /* Indicates clickability */
            position: relative;
        }
        
        /* Interactive Hover State for Widgets */
        .widget-card:hover { 
            border-color: var(--primary); 
            box-shadow: var(--shadow-float); 
            transform: translateY(-4px);
        }
        .widget-card:hover .widget-title i {
            transform: scale(1.1);
        }
        
        /* Click hint */
        .widget-card::after {
            content: 'Click to view details';
            position: absolute;
            bottom: 12px;
            right: 12px;
            font-size: 0.7rem;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .widget-card:hover::after {
            opacity: 1;
        }

        .widget-title {
            display: flex; align-items: center; gap: 10px; font-weight: 700;
            margin-bottom: 16px; font-size: 1rem;
        }
        .widget-title i { color: var(--primary); transition: 0.2s; }

        /* Feed Specifics */
        .feed-item {
            padding: 12px 0; border-bottom: 1px solid var(--border-subtle);
        }
        .feed-item:last-child { border-bottom: none; }
        .feed-tag {
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
            padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; display: inline-block;
        }
        .tag-law { background: #FEE2E2; color: #991B1B; }
        .tag-guideline { background: #DBEAFE; color: #1E40AF; }
        .tag-best-practice { background: #E0F2F1; color: #00695C; }

        /* === SEARCH / KNOWLEDGE BASE VIEW === */
        .search-results { max-width: 800px; margin: 0 auto; padding-top: 40px; }
        .result-card {
            background: var(--bg-surface); padding: 24px; border-radius: var(--radius-lg);
            margin-bottom: 24px; border: 1px solid var(--border-subtle);
            cursor: pointer; transition: var(--transition);
        }
        .result-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-card);
            transform: translateY(-2px);
        }
        .source-pill {
            background: #F3F4F6; padding: 4px 12px; border-radius: 20px;
            font-size: 0.75rem; color: #4B5563; font-weight: 600; margin-right: 8px;
        }

        /* === MODAL STYLES === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; animation: fadeModal 0.2s ease-out; }
        @keyframes fadeModal { from { opacity: 0; } to { opacity: 1; } }

        .modal-box {
            background: white; width: 700px; max-width: 90%; max-height: 85vh; overflow-y: auto;
            border-radius: var(--radius-xl); box-shadow: var(--shadow-float);
            border: 1px solid var(--border-subtle); padding: 40px; position: relative;
            transform: translateY(0); animation: slideModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideModal { from { transform: translateY(20px); } to { transform: translateY(0); } }

        .modal-close {
            position: absolute; top: 24px; right: 24px; font-size: 1.2rem;
            cursor: pointer; color: #9CA3AF; transition: 0.2s;
        }
        .modal-close:hover { color: var(--text-main); }

        /* TONE SELECTOR */
        .tone-selector { display: flex; gap: 12px; margin-bottom: 24px; }
        .tone-option {
            flex: 1; padding: 12px; border: 2px solid var(--border-subtle);
            border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .tone-option:hover { border-color: var(--primary); }
        .tone-option.selected {
            border-color: var(--primary); background: var(--primary-light); color: var(--primary);
        }

        /* WIZARD STEPS */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        .btn-primary {
            background: var(--primary); color: white; padding: 12px 24px;
            border-radius: var(--radius-pill); border: none; cursor: pointer;
            font-weight: 600; font-size: 0.95rem;
        }
        
        /* Detail Lists for Modals */
        .detail-row {
            display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);
        }
        .detail-label { font-weight: 600; color: var(--text-muted); }
        .detail-value { font-weight: 600; color: var(--text-main); }
        
        .progress-container {
            width: 100%; background: #E5E7EB; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px;
        }
        .progress-fill {
            height: 100%; background: var(--primary); border-radius: 5px;
        }

        /* === STUDIO VIEW (UPDATED) === */
        .studio-container { max-width: 100%; margin: 0; padding: 0; width: 100%; height: 100%; display: flex; }
        .studio-header { margin-bottom: 32px; }
        .studio-header h2 { font-size: 2rem; margin-bottom: 8px; }
        .studio-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        
        /* NotebookLM-style Layout */
        .studio-sidebar-left { width: 320px; background: var(--bg-surface); border-right: 1px solid var(--border-subtle); display: flex; flex-direction: column; height: 100%; }
        .studio-main { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg-body); }
        .studio-sidebar-right { width: 360px; background: var(--bg-surface); border-left: 1px solid var(--border-subtle); display: flex; flex-direction: column; height: 100%; overflow-y: auto; padding: 24px; }
        
        /* Left Sidebar - Resources */
        .resources-header { padding: 24px; border-bottom: 1px solid var(--border-subtle); }
        .resources-header h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; }
        .resources-list { flex: 1; overflow-y: auto; padding: 16px; }
        .resource-item { background: var(--bg-subtle); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: var(--transition); border: 1px solid transparent; }
        .resource-item:hover { border-color: var(--primary); background: var(--primary-light); }
        .resource-item i { color: var(--primary); margin-right: 8px; }
        .upload-zone { margin: 16px; padding: 32px; border: 2px dashed var(--border-subtle); border-radius: 12px; text-align: center; color: var(--text-muted); cursor: pointer; transition: var(--transition); }
        .upload-zone:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        
        .file-drop-zone { border: 2px dashed var(--border-subtle); border-radius: 12px; padding: 48px 24px; text-align: center; transition: var(--transition); cursor: pointer; background: var(--bg-subtle); }
        .file-drop-zone:hover { border-color: var(--primary); background: var(--primary-light); }
        .file-drop-zone.drag-over { border-color: var(--primary); background: var(--primary-light); border-style: solid; }
        
        .resource-tag { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .tag-pdf { background: #FEE2E2; color: #991B1B; }
        .tag-video { background: #DBEAFE; color: #1E40AF; }
        .tag-audio { background: #F3E8FF; color: #6B21A8; }
        .tag-text { background: #E0F2F1; color: #00695C; }
        
        /* Middle - Chat */
        .studio-chat-container { flex: 1; display: flex; flex-direction: column; height: 100%; max-width: 900px; margin: 0 auto; width: 100%; padding: 40px 40px 0 40px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px 0; }
        .chat-message { margin-bottom: 24px; display: flex; flex-direction: column; }
        .chat-message.user { align-items: flex-end; }
        .chat-bubble { background: var(--bg-surface); padding: 16px 20px; border-radius: 16px; max-width: 70%; border: 1px solid var(--border-subtle); }
        .chat-message.user .chat-bubble { background: var(--primary); color: white; border-color: var(--primary); }
        .chat-input-wrapper { padding: 24px; border-top: 1px solid var(--border-subtle); background: var(--bg-surface); }
        
        /* Right Sidebar - Studio Tools */
        .studio-tools-header { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; }
        .studio-tool-item { background: var(--bg-subtle); padding: 16px; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: var(--transition); border: 1px solid transparent; }
        .studio-tool-item:hover { border-color: var(--primary); transform: translateX(-4px); }
        
        .studio-card {
            background: var(--bg-surface); border-radius: var(--radius-lg); padding: 24px;
            cursor: pointer; transition: var(--transition); border: 1px solid var(--border-subtle);
            display: flex; flex-direction: column; height: 180px; position: relative; overflow: hidden;
        }
        .studio-card:hover { border-color: var(--primary); box-shadow: var(--shadow-card); transform: translateY(-2px); }
        .studio-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--primary); opacity: 0; transition: opacity 0.2s;
        }
        .studio-card:hover::before { opacity: 1; }

        .studio-icon {
            width: 40px; height: 40px; background: var(--bg-subtle); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-main); font-size: 1.1rem; margin-bottom: 16px;
        }
        .studio-card h3 { font-size: 1.1rem; margin-bottom: 8px; font-weight: 600; }
        .studio-card p { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }
        
        /* Generation Animation Styles */
        .gen-loader { text-align: center; padding: 40px 0; }
        .gen-spinner { font-size: 3rem; color: var(--primary); margin-bottom: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .gen-steps { text-align: left; max-width: 300px; margin: 0 auto; color: var(--text-muted); font-size: 0.9rem; }
        .gen-step { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; opacity: 0.5; }
        .gen-step.active { opacity: 1; color: var(--text-main); font-weight: 600; }
        .gen-step.done { color: var(--accent-green); opacity: 1; }

        /* Result Preview Styles */
        .preview-box {
            background: var(--bg-subtle); border-radius: var(--radius-md); padding: 24px; margin-top: 24px;
        }
        
        /* Audio Player Mock */
        .audio-player { display: flex; align-items: center; gap: 16px; background: white; padding: 16px; border-radius: 50px; border: 1px solid var(--border-subtle); }
        .play-btn { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; }
        .waveform { flex: 1; height: 24px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path d="M0 10 L5 2 L10 18 L15 5 L20 15 L25 8 L30 12 L35 4 L40 16 L45 6 L50 14 L55 3 L60 17 L65 9 L70 11 L75 1 L80 19 L85 7 L90 13 L95 5 L100 10" stroke="%2394A3B8" fill="none" stroke-width="2"/></svg>'); background-size: cover; opacity: 0.5; }

        /* Quiz Mock */
        .quiz-question { font-weight: 600; font-size: 1.1rem; margin-bottom: 16px; }
        .quiz-option { 
            padding: 12px 16px; border: 1px solid var(--border-subtle); border-radius: 8px; 
            margin-bottom: 8px; cursor: pointer; transition: 0.2s; background: white;
        }
        .quiz-option:hover { background: var(--primary-light); border-color: var(--primary); }
        .quiz-option.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Slide Deck Mock */
        .slide-preview { aspect-ratio: 16/9; background: white; border: 1px solid var(--border-subtle); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--text-muted); margin-bottom: 16px; position: relative; }
        .slide-controls { display: flex; justify-content: center; gap: 16px; }

        /* === NEW DYNAMIC COMPONENTS === */
        
        /* Toast Notifications */
        .toast-container {
            position: fixed; bottom: 24px; right: 24px; z-index: 2000;
            display: flex; flex-direction: column; gap: 12px; pointer-events: none;
        }
        .toast {
            background: #1F2937; color: white; padding: 12px 24px;
            border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 12px;
            animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            min-width: 300px; pointer-events: auto;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Inspector View Metrics */
        .inspector-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 32px; }
        .inspector-grid { display: grid; grid-template-columns: 300px 1fr; gap: 24px; height: calc(100vh - 200px); }
        .profile-panel { background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; }
        .analytics-panel { display: flex; flex-direction: column; gap: 24px; }
        .stat-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .uni-stat { background: white; padding: 20px; border-radius: var(--radius-md); border: 1px solid var(--border-subtle); }
        .chart-container { background: white; padding: 24px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); flex: 1; display: flex; align-items: flex-end; justify-content: space-around; padding-bottom: 0; overflow: hidden; }
        
        /* Simple CSS Bar Chart */
        .bar-group { display: flex; flex-direction: column; align-items: center; gap: 8px; height: 100%; justify-content: flex-end; width: 40px; }
        .bar { width: 100%; background: var(--primary-light); border-radius: 8px 8px 0 0; transition: height 1s ease-out; position: relative; }
        .bar::after { content: attr(data-val); position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; font-weight: 700; color: var(--text-muted); opacity:0; transition:0.2s;}
        .bar:hover { background: var(--primary); }
        .bar:hover::after { opacity: 1; top: -20px; }

        /* Regulation Detail Modal */
        .regulation-summary {
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
            border-left: 4px solid var(--primary);
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .regulation-summary h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        .regulation-summary p {
            color: #0C4A6E;
            line-height: 1.7;
            font-size: 0.95rem;
        }
        .key-points {
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .key-points h4 {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .key-point-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .key-point-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .key-point-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-light);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 0.75rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .key-point-text {
            flex: 1;
            color: var(--text-main);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .source-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .btn-source {
            flex: 1;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }
        .btn-source.primary {
            background: var(--primary);
            color: white;
        }
        .btn-source.primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 105, 92, 0.2);
        }
        .btn-source.secondary {
            background: var(--bg-subtle);
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
        }
        .btn-source.secondary:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
        }
        .metadata-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .metadata-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metadata-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
        }

        /* === INTERACTIVE DEMO STYLES === */
        /* Audio Visualization */
        .waveform-bar {
            flex: 1; background: #9CA3AF; border-radius: 2px; animation: none;
        }
        .audio-player.playing .waveform-bar {
            animation: bounce 0.5s infinite ease-in-out; background: var(--primary);
        }
        @keyframes bounce { 0%, 100% { height: 20%; } 50% { height: 80%; } }

        /* Quiz Feedback */
        .quiz-option.correct { background: #DCFCE7; border-color: #22C55E; color: #15803D; }
        .quiz-option.wrong { background: #FEE2E2; border-color: #EF4444; color: #991B1B; }
        
        /* Slides Transition */
        .slide-content { animation: fadeInSlide 0.3s; }
        @keyframes fadeInSlide { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        /* Settings Toggles */
        .toggle-switch {
            width: 44px; height: 24px; background: #E5E7EB; border-radius: 20px;
            position: relative; cursor: pointer; transition: 0.2s;
        }
        .toggle-switch.active { background: var(--primary); }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px;
            background: white; border-radius: 50%; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after { left: 22px; }

        /* Historical Reports Dropdown */
        .reports-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .reports-dropdown-btn {
            width: 100%;
            padding: 10px 36px 10px 14px;
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            position: relative;
        }
        .reports-dropdown-btn:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        .reports-dropdown-btn::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .user-pill.reports-dropdown-btn::after {
            right: 12px;
            font-size: 0.65rem;
        }
        .reports-dropdown-btn.open::after {
            transform: translateY(-50%) rotate(180deg);
        }
        .reports-dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            box-shadow: var(--shadow-float);
            z-index: 100;
            max-height: 280px;
            overflow-y: auto;
            display: none;
        }
        .reports-dropdown-menu.open {
            display: block;
            animation: dropdownSlide 0.2s ease-out;
        }
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .report-dropdown-item {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: var(--transition);
        }
        .report-dropdown-item:last-child {
            border-bottom: none;
        }
        .report-dropdown-item:hover {
            background: var(--primary-light);
        }
        .report-dropdown-item .report-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 2px;
        }
        .report-dropdown-item .report-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Report Query Modal */
        .query-chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
        }
        .query-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-subtle);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .query-message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s;
        }
        .query-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            border: 1px solid var(--border-subtle);
        }
        .query-message.user {
            display: flex;
            justify-content: flex-end;
        }
        .query-message.user .query-bubble {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .query-input-box {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .query-input-box input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            font-size: 0.95rem;
        }
        .query-input-box button {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        .query-input-box button:hover {
            background: var(--primary-dark);
        }

    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand-icon">
            <i class="fas fa-staff-snake"></i>
        </div>
        
        <div class="nav-item active" onclick="switchView('home', this)" data-tooltip="Home">
            <i class="fas fa-home"></i>
        </div>
        <div class="nav-item" onclick="switchView('search', this)" data-tooltip="Regulatory Search">
            <i class="fas fa-search"></i>
        </div>
        <div class="nav-item" onclick="switchView('monitoring', this)" data-tooltip="Inspection Report Intelligence">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="nav-item" onclick="switchView('inspector', this)" data-tooltip="Pre-Inspection Intelligence">
            <i class="fas fa-user-secret"></i>
        </div>
        <div class="nav-item" onclick="switchView('usecases', this)" data-tooltip="Use Cases">
            <i class="fas fa-lightbulb"></i>
        </div>
        <div class="nav-item" onclick="switchView('partnership', this)" data-tooltip="Partnership Proposal">
            <i class="fas fa-handshake"></i>
        </div>
        <div class="nav-item" onclick="switchView('settings', this)" style="margin-top: auto;" data-tooltip="Settings">
            <i class="fas fa-cog"></i>
        </div>
    </nav>

    <main class="main-content">
        
        <div class="top-bar">
            <div class="user-pill">
                <i class="fas fa-user-circle"></i> Peter Sloan, PharmD
            </div>
        </div>

        <section id="view-home" class="view-section active">
            <div class="gen-ai-container">
                <h1 class="hero-title">Pharmacy Compliance <span style="color:#00695C">Intelligence</span></h1>
                <p class="hero-subtitle">Ask a question, upload a report, or generate a response.</p>

                <div class="prompt-bar-container">
                    <input type="text" class="prompt-input" id="homePromptInput" placeholder="Help you solve any compliance question…" onkeypress="handleHomePrompt(event)">
                    <button class="prompt-submit"><i class="fas fa-arrow-right"></i></button>
                    
                    <div class="query-functions">
                        <div class="function-btn" id="deepThinkBtn" onclick="toggleDeepThinking(this)">
                            <i class="fas fa-brain"></i> Deep Thinking
                        </div>
                        <div class="function-btn" onclick="toggleDropdown(this, 'search')">
                            <i class="fas fa-search"></i> Search <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="function-btn" onclick="toggleDropdown(this, 'tool')">
                            <i class="fas fa-wrench"></i> Tool <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="add-function-btn" onclick="showToast('More functions coming soon!')">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>

                <div class="widget-grid">
                    
                    <div class="widget-card" onclick="switchView('search', document.querySelectorAll('.nav-item')[2])">
                        <div class="widget-title">
                            <i class="fas fa-bell"></i> Regulatory Updates
                        </div>
                        <div class="feed-item">
                            <span class="feed-tag tag-law">Law / Standard - Jan 7, 2026</span>
                            <div style="font-weight: 700; font-size: 0.9rem; color: var(--text-main);">Health Professions Act (Alberta)</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Provincial legislation defining restricted activities</div>
                        </div>
                        <div class="feed-item">
                            <span class="feed-tag tag-law">Law / Standard - Dec 29, 2025</span>
                            <div style="font-weight: 700; font-size: 0.9rem; color: var(--text-main);">Food and Drugs Act (Canada)</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Federal legislation, last amended Mar 27, 2025</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;margin-top:10px;">
                            <span style="color: var(--text-muted); font-size: 0.75rem;">7 updates • Last checked 2h ago</span>
                            <span style="color: var(--primary); font-weight: 700; font-size: 0.85rem;">View All →</span>
                        </div>
                    </div>
                    <div class="widget-card" onclick="switchView('monitoring', document.querySelectorAll('.nav-item')[4])">
                        <div class="widget-title">
                            <i class="fas fa-chart-line"></i> Inspection Report Intelligence
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px; font-weight: 500;">
                            Separate mandatory laws from optional suggestions instantly
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px;">
                                <span style="color: var(--text-main);">Latest: Inspection_Feb05.pdf</span>
                                <span style="font-size: 0.7rem; background: #FEE2E2; color: #991B1B; padding: 3px 8px; border-radius: 4px; font-weight: 700;">4 Findings</span>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">
                                <i class="fas fa-check-circle" style="color: var(--accent-green);"></i> Checked against 47 regulations
                            </div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;">
                                <span style="font-size: 0.7rem; padding: 4px 10px; background: #FEE2E2; color: #991B1B; border-radius: 4px; font-weight: 700;">2 LAWS</span>
                                <span style="font-size: 0.7rem; padding: 4px 10px; background: #FEF3C7; color: #92400E; border-radius: 4px; font-weight: 700;">1 GUIDELINE</span>
                                <span style="font-size: 0.7rem; padding: 4px 10px; background: #DBEAFE; color: #1E40AF; border-radius: 4px; font-weight: 700;">1 BEST PRACTICE</span>
                            </div>
                            <div style="background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%); border-left: 3px solid #F59E0B; padding: 8px 10px; border-radius: 6px; margin-bottom: 12px;">
                                <div style="font-size: 0.75rem; color: #92400E; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-exclamation-circle"></i> 2 critical laws require immediate action
                                </div>
                            </div>
                        </div>
                        <div style="background: #F9FAFB; border-radius: 8px; padding: 12px; margin-top: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">
                                    <i class="fas fa-bolt" style="color: var(--accent-orange);"></i> Analyzed in 2.3s
                                </div>
                                <div style="font-size: 0.75rem; color: var(--primary); font-weight: 700;">View Report →</div>
                            </div>
                        </div>
                    </div>
                    <div class="widget-card" onclick="switchView('inspector', document.querySelectorAll('.nav-item')[3])">
                        <div class="widget-title">
                            <i class="fas fa-user-secret"></i> Pre-Inspection Intelligence
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px; font-weight: 500;">
                            Predict what your inspector will look for based on 45+ past audits
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-subtle);">
                            <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 700; font-size: 0.95rem; border: 2px solid white; box-shadow: 0 2px 8px rgba(0, 105, 92, 0.15);">IG</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 0.9rem; color: var(--text-main);">Inspector G.</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Next Audit: Feb 21</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%); padding: 12px 14px; border-radius: 8px; border-left: 3px solid #EF4444; margin-bottom: 12px;">
                            <div style="font-size: 0.7rem; font-weight: 700; color: #991B1B; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">⚠️ High Risk Area</div>
                            <div style="font-weight: 600; font-size: 0.85rem; color: #7F1D1D; margin-bottom: 2px;">Training Records</div>
                            <div style="font-size: 0.75rem; color: #991B1B;">Flagged in 85% of G.'s inspections</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">
                                <i class="fas fa-chart-line"></i> AI Confidence: 92%
                            </span>
                            <span style="color: var(--primary); font-weight: 700; font-size: 0.85rem;">View Profile →</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-search" class="view-section">
            <div class="gen-ai-container" style="padding-top: 40px;">
                <div class="prompt-bar-container" style="max-width: 800px;">
                    <input type="text" class="prompt-input" id="searchInput" placeholder="Search laws, guidelines, and best practices..." onkeypress="handleSearch(event)">
                    <button class="prompt-submit" onclick="performSearch()"><i class="fas fa-search"></i></button>
                </div>

                <div class="search-results" id="searchResults">
                    <!-- Latest Regulations -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 1.2rem; margin-bottom: 16px; color: var(--text-main);">
                            <i class="fas fa-clock" style="color: var(--primary); margin-right: 8px;"></i>
                            Latest Canadian Pharmacy Regulations
                        </h3>
                    </div>

                    <div class="result-card" onclick="showRegulationDetail('hpa')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h3 style="margin: 0; flex: 1;">Health Professions Act (Alberta)</h3>
                            <span class="feed-tag tag-law" style="margin-left: 12px;">Law / Standard</span>
                        </div>
                        <p style="line-height: 1.6; color: var(--text-main); margin-bottom: 12px;">
                            Office consolidation of provincial legislation defining restricted activities for health professionals. Regulates authorization required for dispensing, compounding, and prescribing within Alberta.
                        </p>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="source-pill"><i class="fas fa-gavel"></i> Govt of Alberta</span>
                            <span class="source-pill"><i class="fas fa-file-alt"></i> HPA</span>
                            <span class="source-pill"><i class="fas fa-calendar"></i> Current as of: Jan 7, 2026</span>
                        </div>
                    </div>

                    <div class="result-card" onclick="showRegulationDetail('fda')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h3 style="margin: 0; flex: 1;">Food and Drugs Act (Canada)</h3>
                            <span class="feed-tag tag-law" style="margin-left: 12px;">Law / Standard</span>
                        </div>
                        <p style="line-height: 1.6; color: var(--text-main); margin-bottom: 12px;">
                            Federal legislation governing drugs, medical devices, and food safety. Last amended March 27, 2025. Defines requirements for drug approval, manufacturing, and distribution across Canada.
                        </p>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="source-pill"><i class="fas fa-gavel"></i> Health Canada</span>
                            <span class="source-pill"><i class="fas fa-file-alt"></i> Federal Act</span>
                            <span class="source-pill"><i class="fas fa-calendar"></i> Current to: Dec 29, 2025</span>
                        </div>
                    </div>

                    <div class="result-card" onclick="showRegulationDetail('spppt')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h3 style="margin: 0; flex: 1;">Standards of Practice for Pharmacists & Pharmacy Technicians</h3>
                            <span class="feed-tag tag-law" style="margin-left: 12px;">Law / Standard</span>
                        </div>
                        <p style="line-height: 1.6; color: var(--text-main); margin-bottom: 12px;">
                            ACP professional practice standards defining obligations including Standard 11 (prescribing rationale documentation) and requirements for clinical decision-making and patient care.
                        </p>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="source-pill"><i class="fas fa-building"></i> ACP</span>
                            <span class="source-pill"><i class="fas fa-file-alt"></i> SPPPT</span>
                            <span class="source-pill"><i class="fas fa-calendar"></i> Effective: Feb 1, 2025</span>
                        </div>
                    </div>

                    <div class="result-card" onclick="showRegulationDetail('nsc-guidance')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h3 style="margin: 0; flex: 1;">Guidance Document for Non-Sterile Compounding</h3>
                            <span class="feed-tag tag-guideline" style="margin-left: 12px;">Guideline</span>
                        </div>
                        <p style="line-height: 1.6; color: var(--text-main); margin-bottom: 12px;">
                            Companion guidance document clarifying requirements for master formulation records and risk assessments for Level A, B, and C compounding. Published March 2018, revised June 2018, clarified January 2022.
                        </p>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="source-pill"><i class="fas fa-building"></i> NAPRA</span>
                            <span class="source-pill"><i class="fas fa-file-alt"></i> Guidance Document</span>
                            <span class="source-pill"><i class="fas fa-calendar"></i> Clarified: Jan 2022</span>
                        </div>
                    </div>

                    <div class="result-card" onclick="showRegulationDetail('nsc-standards')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h3 style="margin: 0; flex: 1;">Model Standards for Non-Sterile Compounding</h3>
                            <span class="feed-tag tag-law" style="margin-left: 12px;">Law / Standard</span>
                        </div>
                        <p style="line-height: 1.6; color: var(--text-main); margin-bottom: 12px;">
                            NAPRA Model Standards defining requirements for Level A, B, and C non-sterile preparations including beyond-use dating, stability data, and quality assurance processes. Published March 2018, clarified January 2022.
                        </p>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="source-pill"><i class="fas fa-building"></i> NAPRA</span>
                            <span class="source-pill"><i class="fas fa-file-alt"></i> Model Standards</span>
                            <span class="source-pill"><i class="fas fa-calendar"></i> Clarified: Jan 2022</span>
                        </div>
                    </div>

                    <div class="result-card" onclick="showRegulationDetail('haz-sterile')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h3 style="margin: 0; flex: 1;">Model Standards for Hazardous Sterile Preparations</h3>
                            <span class="feed-tag tag-law" style="margin-left: 12px;">Law / Standard</span>
                        </div>
                        <p style="line-height: 1.6; color: var(--text-main); margin-bottom: 12px;">
                            Standards for handling cytotoxic drugs requiring dedicated negative pressure rooms and strict transport protocols (NAPRA 6.9). Personnel must have specific hazardous drug training. Published September 2016, revised November 2016.
                        </p>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="source-pill"><i class="fas fa-building"></i> NAPRA</span>
                            <span class="source-pill"><i class="fas fa-file-alt"></i> Hazardous Standards</span>
                            <span class="source-pill"><i class="fas fa-calendar"></i> Revised: Nov 2016</span>
                        </div>
                    </div>

                    <div class="result-card" onclick="showRegulationDetail('nonhaz-sterile')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h3 style="margin: 0; flex: 1;">Model Standards for Non-Hazardous Sterile Preparations</h3>
                            <span class="feed-tag tag-law" style="margin-left: 12px;">Law / Standard</span>
                        </div>
                        <p style="line-height: 1.6; color: var(--text-main); margin-bottom: 12px;">
                            NAPRA mandates documented training for cleaning personnel (Section 5.1.2) and strict environmental monitoring for non-hazardous sterile compounding. Published November 2015, revised November 2016.
                        </p>
                        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="source-pill"><i class="fas fa-building"></i> NAPRA</span>
                            <span class="source-pill"><i class="fas fa-file-alt"></i> Non-Hazardous Sterile</span>
                            <span class="source-pill"><i class="fas fa-calendar"></i> Revised: Nov 2016</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-usecases" class="view-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 40px; width: 100%;">
                <div class="inspector-header" style="margin-bottom: 48px;">
                    <div>
                        <h2 style="font-size: 2.5rem; margin-bottom: 8px;">How It Works</h2>
                        <p style="color: var(--text-muted); font-size: 1.1rem;">See our three core solutions in action</p>
                    </div>
                </div>

                <!-- Use Case 1: Regulatory Search -->
                <div style="background: white; border: 2px solid var(--primary-light); border-radius: var(--radius-lg); padding: 40px; margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">
                            <i class="fas fa-search" style="color: #92400E;"></i>
                        </div>
                        <div>
                            <span style="background: #FEF3C7; color: #92400E; padding: 4px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;">Solution 01 // Knowledge</span>
                            <h3 style="font-size: 1.8rem; margin-top: 8px; font-weight: 700;">Regulatory Search</h3>
                        </div>
                    </div>
                    
                    <p style="font-size: 1.05rem; color: var(--text-muted); line-height: 1.7; margin-bottom: 32px;">Instantly search through thousands of Canadian pharmacy laws, guidelines, and best practices. Find the exact regulation you need in seconds instead of hours of manual research.</p>
                    
                    <div style="background: #F9FAFB; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-lightbulb" style="color: var(--primary);"></i> How It Works
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">1</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Search Query</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">Type your question in natural language</div>
                            </div>
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">2</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">AI Analysis</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">System searches across all regulatory sources</div>
                            </div>
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">3</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Instant Results</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">Get relevant laws with source citations</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 16px; text-transform: uppercase;">Example Search Results</div>
                        
                        <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="font-weight: 600;">Opioid Agonist Therapy - Netcare Verification</div>
                                <span style="background: #FEE2E2; color: #991B1B; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;">LAW</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.6;">Mandatory Netcare check required before dispensing OAT medications effective March 1, 2026.</div>
                            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="font-size: 0.75rem; padding: 4px 10px; background: var(--bg-subtle); border-radius: 6px;"><i class="fas fa-building" style="margin-right: 4px;"></i>Alberta College of Pharmacy</span>
                                <span style="font-size: 0.75rem; padding: 4px 10px; background: var(--bg-subtle); border-radius: 6px;"><i class="fas fa-file-alt" style="margin-right: 4px;"></i>Standard 18.2</span>
                            </div>
                        </div>
                        
                        <div style="padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="font-weight: 600;">Cold Chain Management Requirements</div>
                                <span style="background: #E0F2F1; color: #00695C; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;">BEST PRACTICE</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.6;">Digital temperature logs must be backed up weekly with documented corrective action within 24 hours.</div>
                            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="font-size: 0.75rem; padding: 4px 10px; background: var(--bg-subtle); border-radius: 6px;"><i class="fas fa-building" style="margin-right: 4px;"></i>Health Canada</span>
                                <span style="font-size: 0.75rem; padding: 4px 10px; background: var(--bg-subtle); border-radius: 6px;"><i class="fas fa-file-alt" style="margin-right: 4px;"></i>GUI-0001</span>
                            </div>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%); border: 1px solid #FDE047; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <i class="fas fa-bolt" style="color: #D97706; font-size: 1.5rem;"></i>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px; color: #78350F;">Always Up-to-Date</div>
                                <div style="font-size: 0.95rem; color: #78350F;">Our knowledge base is continuously updated with the latest regulations from NAPRA, provincial colleges, and Health Canada.</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="switchView('search', document.querySelectorAll('.nav-item')[2])" style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-search"></i> Try Regulatory Search
                        </button>
                    </div>
                </div>

                <!-- Use Case 2: Inspection Report Intelligence (Combined) -->
                <div style="background: white; border: 2px solid var(--primary-light); border-radius: var(--radius-lg); padding: 40px; margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">
                            <i class="fas fa-chart-line" style="color: #991B1B;"></i>
                        </div>
                        <div>
                            <span style="background: #FEE2E2; color: #991B1B; padding: 4px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;">Solution 02 // Clarity + Efficiency</span>
                            <h3 style="font-size: 1.8rem; margin-top: 8px; font-weight: 700;">Inspection Report Intelligence</h3>
                        </div>
                    </div>
                    
                    <p style="font-size: 1.05rem; color: var(--text-muted); line-height: 1.7; margin-bottom: 32px;">Upload an inspection report and get instant classification of every finding (Law vs Guideline vs Best Practice), then automatically generate formal response letters with proper citations. Save 2-3 days of work per inspection while eliminating legal risk.</p>
                    
                    <div style="background: #F9FAFB; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-lightbulb" style="color: var(--primary);"></i> How It Works
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">1</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Upload Report</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">Drag & drop your PDF inspection report</div>
                            </div>
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">2</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">AI Classification</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">System checks 47+ regulations in 2.3 seconds</div>
                            </div>
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">3</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Review Findings</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">See priority classifications for each issue</div>
                            </div>
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">4</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Generate Responses</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">AI drafts formal responses with citations</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 16px; text-transform: uppercase;">Example: Classification Results</div>
                        
                        <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Finding #12: Narcotic Log Signature Missing</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">"Logbook on Dec 12 lacks pharmacist initial..."</div>
                            </div>
                            <span style="background: #FEE2E2; color: #991B1B; padding: 6px 14px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; white-space: nowrap;">LAW - CRITICAL</span>
                        </div>
                        
                        <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Finding #14: Dusty Shelving Unit</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">"Dust visible on top shelf of medication storage..."</div>
                            </div>
                            <span style="background: #FEF9E7; color: #D97706; padding: 6px 14px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; white-space: nowrap;">GUIDELINE</span>
                        </div>
                        
                        <div style="padding: 16px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Finding #18: Fridge Placement</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">"Suggest moving fridge away from wall for better airflow..."</div>
                            </div>
                            <span style="background: #E0F2F1; color: #00695C; padding: 6px 14px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; white-space: nowrap;">BEST PRACTICE</span>
                        </div>
                    </div>

                    <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 16px; text-transform: uppercase;">Example: Generated Response</div>
                        
                        <div style="background: #F8FAFC; padding: 24px; border-radius: 8px; font-family: Georgia, serif; font-size: 0.95rem; line-height: 1.8; border-left: 4px solid var(--primary);">
                            <p style="margin-bottom: 16px;"><strong>RE: Finding #18 (Fridge Placement)</strong></p>
                            <p style="margin-bottom: 12px;">We acknowledge the inspector's comment regarding fridge placement near the wall.</p>
                            <p style="margin-bottom: 12px;">However, we note that current Guidelines (Section 4.2) do not mandate specific wall clearance distances provided airflow is maintained. We have verified that airflow is sufficient and respectfully decline to relocate the unit at this time.</p>
                            <p style="margin-bottom: 12px;">Should this become a regulatory requirement in future updates, we will implement changes accordingly.</p>
                            <p style="margin-top: 20px;"><em>Respectfully,</em><br><strong>Peter Sloan, PharmD</strong><br>Pharmacy Manager</p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border: 1px solid #BAE6FD; border-radius: 12px; padding: 20px;">
                            <div style="display: flex; gap: 12px; align-items: start;">
                                <i class="fas fa-shield-check" style="color: #0EA5E9; font-size: 1.3rem;"></i>
                                <div>
                                    <div style="font-weight: 700; margin-bottom: 4px; font-size: 0.95rem;">Eliminates Legal Risk</div>
                                    <div style="font-size: 0.85rem; color: #0C4A6E;">Every response uses defensible language with proper citations</div>
                                </div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border: 1px solid #FDE047; border-radius: 12px; padding: 20px;">
                            <div style="display: flex; gap: 12px; align-items: start;">
                                <i class="fas fa-clock" style="color: #D97706; font-size: 1.3rem;"></i>
                                <div>
                                    <div style="font-weight: 700; margin-bottom: 4px; font-size: 0.95rem;">Save 2-3 Days Per Inspection</div>
                                    <div style="font-size: 0.85rem; color: #78350F;">Automated classification and response drafting</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="switchView('monitoring', document.querySelectorAll('.nav-item')[4])" style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chart-line"></i> Try Inspection Report Intelligence
                        </button>
                    </div>
                </div>

                <!-- Use Case 3: Pre-Inspection Intelligence -->
                <div style="background: white; border: 2px solid var(--primary-light); border-radius: var(--radius-lg); padding: 40px; margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                        <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">
                            <i class="fas fa-user-secret" style="color: #00695C;"></i>
                        </div>
                        <div>
                            <span style="background: #E0F2F1; color: #00695C; padding: 4px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;">Solution 03 // Prediction</span>
                            <h3 style="font-size: 1.8rem; margin-top: 8px; font-weight: 700;">Pre-Inspection Intelligence</h3>
                        </div>
                    </div>
                    
                    <p style="font-size: 1.05rem; color: var(--text-muted); line-height: 1.7; margin-bottom: 32px;">Inspectors are creatures of habit. We predict what a specific inspector will look for before they even arrive, giving you targeted preparation guidance.</p>
                    
                    <div style="background: #F9FAFB; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-lightbulb" style="color: var(--primary);"></i> How It Works
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">1</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Inspector Match</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">System identifies your assigned inspector</div>
                            </div>
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">2</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Pattern Analysis</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">Analyzes their 45+ past inspection reports</div>
                            </div>
                            <div>
                                <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 12px;">3</div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Custom Prep</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">Get tailored checklist for high-risk areas</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 16px; text-transform: uppercase;">Example Inspector Profile</div>
                        
                        <div style="display: flex; gap: 16px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-subtle);">
                            <div style="width: 56px; height: 56px; background: #E0F2F1; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem; font-weight: 700;">JS</div>
                            <div>
                                <div style="font-weight: 700; font-size: 1.1rem;">Inspector J. Smith</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">Lead Inspector • Calgary North Region</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">History: 45 Inspections Analyzed</div>
                            </div>
                        </div>

                        <div style="background: #FFF1F2; padding: 16px; border-radius: 8px; border-left: 4px solid #E11D48; margin-bottom: 12px;">
                            <div style="font-size: 0.8rem; font-weight: 700; color: #BE123C; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-triangle-exclamation"></i> HIGH RISK AREA
                            </div>
                            <div style="font-size: 0.95rem; color: #881337; line-height: 1.5;">Smith cites <strong>Narcotic Reconciliation</strong> in 85% of visits. Verify your counts and ensure dual signatures before inspection day.</div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div style="background: #FEE2E2; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #991B1B;">85%</div>
                                <div style="font-size: 0.8rem; color: #991B1B; font-weight: 600;">Narcotics</div>
                            </div>
                            <div style="background: #FEF3C7; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #92400E;">70%</div>
                                <div style="font-size: 0.8rem; color: #92400E; font-weight: 600;">Temp Logs</div>
                            </div>
                            <div style="background: #DBEAFE; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1E40AF;">45%</div>
                                <div style="font-size: 0.8rem; color: #1E40AF; font-weight: 600;">Sterile Comp.</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border: 1px solid #FDE047; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <i class="fas fa-star" style="color: #D97706; font-size: 1.5rem;"></i>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px; color: #78350F;">Early Warning System</div>
                                <div style="font-size: 0.95rem; color: #78350F;">Get alerts 7-14 days before inspection. The more reports we analyze, the smarter our predictions become.</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-primary" onclick="switchView('inspector', document.querySelectorAll('.nav-item')[3])" style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user-secret"></i> View Pre-Inspection Intelligence
                        </button>
                    </div>
                </div>



            </div>
        </section>

        <section id="view-inspector" class="view-section">
            <div style="max-width: 1400px; margin: 0 auto; padding: 48px; width: 100%;">
                <div class="inspector-header" style="margin-bottom: 40px;">
                    <div>
                        <h2 style="font-size: 2.25rem; margin-bottom: 8px; font-weight: 800; letter-spacing: -0.5px; color: var(--text-main);">Pre-Inspection Intelligence</h2>
                        <p style="color: var(--text-muted); font-size: 1.05rem;">Predictive insights powered by AI for your next audit</p>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button style="display: flex; align-items: center; gap: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 10px 20px; font-weight: 600; border: 1px solid var(--border-subtle); border-radius: var(--radius-pill); font-size: 0.9rem; color: var(--text-main); cursor: default; transition: all 0.2s; white-space: nowrap;">
                            <i class="fas fa-calendar" style="color: var(--primary); font-size: 0.95rem;"></i>
                            <span>Next Audit: Feb 21</span>
                        </button>
                        <div class="reports-dropdown" style="position: relative;">
                            <button style="display: flex; align-items: center; gap: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 10px 20px; font-weight: 600; border: 1px solid var(--border-subtle); border-radius: var(--radius-pill); font-size: 0.9rem; color: var(--text-main); cursor: pointer; transition: all 0.2s; position: relative; padding-right: 20px; white-space: nowrap;" onclick="toggleReportsDropdown()" id="reportsDropdownBtn" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.borderColor='var(--primary)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.06)'; this.style.borderColor='var(--border-subtle)'">
                                <i class="fas fa-folder-open" style="color: var(--primary); font-size: 0.95rem;"></i>
                                <span>Historical Audits</span>
                            </button>
                            <div class="reports-dropdown-menu" id="reportsDropdownMenu" style="top: calc(100% + 8px); min-width: 320px;">
                                <div style="padding: 12px 14px; border-bottom: 2px solid var(--border-subtle); background: var(--bg-subtle);">
                                    <div style="font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Select a Report</div>
                                </div>
                                <div class="report-dropdown-item" onclick="selectReport('Jun 13, 2024 Sterile', 'Conditional Pass', '2024-06-13')">
                                    <div class="report-title">Jun 13, 2024 - Sterile Compounding</div>
                                    <div class="report-meta">Verdict: Conditional Pass • 5 findings</div>
                                </div>
                                <div class="report-dropdown-item" onclick="selectReport('Mar 22, 2024 Routine', 'Pass', '2024-03-22')">
                                    <div class="report-title">Mar 22, 2024 - Routine Operations</div>
                                    <div class="report-meta">Verdict: Pass • 4 findings</div>
                                </div>
                            </div>
                        </div>
                        <button class="btn-primary" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px; font-size: 0.9rem; font-weight: 600; box-shadow: 0 4px 12px rgba(0, 105, 92, 0.25); transition: all 0.2s; white-space: nowrap;" onclick="openModal('inspectorModal')" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 105, 92, 0.35)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 105, 92, 0.25)'">
                            <i class="fas fa-download"></i>
                            <span>Prep Checklist</span>
                        </button>
                    </div>
                </div>

                <!-- Top Alert Banner -->
                <div style="background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%); padding: 24px 28px; border-radius: 16px; border: 2px solid #FECACA; margin-bottom: 36px; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -30px; right: -30px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.4); border-radius: 50%; filter: blur(20px);"></div>
                    <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.4rem; flex-shrink: 0; box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3); position: relative; z-index: 1;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div style="flex: 1; position: relative; z-index: 1;">
                        <div style="font-weight: 800; font-size: 1.1rem; margin-bottom: 6px; color: #991B1B; letter-spacing: -0.3px;">High Priority: Narcotic Reconciliation Gap Detected</div>
                        <div style="color: #7F1D1D; font-size: 0.95rem; line-height: 1.5;">Inspector J. Smith flagged this in 85% of recent audits. Review your narcotic log for Dec 12-18.</div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div style="display: grid; grid-template-columns: 320px 1fr 320px; gap: 24px; margin-bottom: 32px; align-items: stretch;">
                    
                    <!-- Left: Inspector Profile -->
                    <div class="profile-panel" style="box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 24px rgba(0, 0, 0, 0.06)'">
                        
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div style="width: 96px; height: 96px; background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 2rem; font-weight: 800; margin: 0 auto 16px; box-shadow: 0 8px 24px rgba(0, 105, 92, 0.15); border: 3px solid white;">JS</div>
                            <h3 style="margin: 0 0 6px 0; font-size: 1.2rem; font-weight: 800; letter-spacing: -0.3px;">Inspector J. Smith</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0; font-weight: 500;">Lead Inspector • Calgary North</p>
                        </div>

                        <div class="detail-row">
                            <span class="detail-label">Last Audit</span>
                            <span class="detail-value">Jan 15, 2026</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Verdict</span>
                            <span class="detail-value" style="color: #F59E0B;">Conditional Pass</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Total Audits</span>
                            <span class="detail-value">8</span>
                        </div>
                        <div class="detail-row" style="border: none;">
                            <span class="detail-label">Avg. Duration</span>
                            <span class="detail-value">2.5 hours</span>
                        </div>

                        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
                            <h4 style="font-size: 0.9rem; margin-bottom: 12px; color: var(--text-muted); font-weight: 700;">RECENT CITATIONS</h4>
                            <div style="font-size: 0.85rem; margin-bottom: 8px;">• Sterile Training Records (Missing initial assessment)</div>
                            <div style="font-size: 0.85rem; margin-bottom: 8px;">• MFR Documentation (Missing protocol numbers)</div>
                            <div style="font-size: 0.85rem;">• Hazardous Transport Labeling</div>
                        </div>

                        <button class="btn-primary" style="width: 100%; margin-top: 20px; background: white; color: var(--primary); border: 1px solid var(--border-subtle);" onclick="openModal('inspectorModal')">
                            View Full Profile
                        </button>
                    </div>

                    <!-- Middle: Focus Areas Chart -->
                    <div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
                        
                        <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 28px; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06); transition: all 0.3s; flex: 1; display: flex; flex-direction: column;" onmouseover="this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.boxShadow='0 4px 24px rgba(0, 0, 0, 0.06)'">
                            <h3 style="font-size: 1.2rem; margin-bottom: 8px; font-weight: 800; letter-spacing: -0.3px;">Historical Focus Areas</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 24px; font-weight: 500;">Based on 20 recent audits by this inspector</p>
                            
                            <div class="chart-container" style="flex: 1; min-height: 200px; padding: 24px;">
                                <div class="bar-group"><div class="bar" data-val="85%" style="height: 85%; background: var(--primary-dark);"></div><span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Documentation</span></div>
                                <div class="bar-group"><div class="bar" data-val="75%" style="height: 75%; background: var(--primary);"></div><span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Sterile</span></div>
                                <div class="bar-group"><div class="bar" data-val="60%" style="height: 60%; background: #26A69A;"></div><span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Staffing</span></div>
                                <div class="bar-group"><div class="bar" data-val="45%" style="height: 45%; background: #80CBC4;"></div><span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Transport</span></div>
                                <div class="bar-group"><div class="bar" data-val="30%" style="height: 30%; background: #B2DFDB;"></div><span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Clinical</span></div>
                            </div>
                        </div>

                        <!-- Audit History Trend -->
                        <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 28px; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06); transition: all 0.3s; flex: 1; display: flex; flex-direction: column;" onmouseover="this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.boxShadow='0 4px 24px rgba(0, 0, 0, 0.06)'">
                            <h3 style="font-size: 1.2rem; margin-bottom: 8px; font-weight: 800; letter-spacing: -0.3px;">Your Audit Performance Trend</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 24px; font-weight: 500;">Last 4 inspections with Inspector G.</p>
                            
                            <div style="position: relative; display: flex; gap: 16px; align-items: flex-end; height: 200px; padding-top: 20px;">
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; height: 180px; justify-content: flex-end; position: relative; z-index: 2;">
                                    <div style="width: 100%; height: 80%; background: linear-gradient(to top, #B2DFDB, #C7E9E6); border-radius: 8px 8px 0 0; position: relative; border: 1px solid #80CBC4; border-bottom: none;">
                                        <span style="position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 0.85rem; font-weight: 700; color: var(--primary-dark);">80%</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">Jan 2024</span>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; height: 180px; justify-content: flex-end; position: relative; z-index: 2;">
                                    <div style="width: 100%; height: 72%; background: linear-gradient(to top, #80CBC4, #9DD6CF); border-radius: 8px 8px 0 0; position: relative; border: 1px solid #4DB6AC; border-bottom: none;">
                                        <span style="position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 0.85rem; font-weight: 700; color: var(--primary-dark);">72%</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">Jul 2024</span>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; height: 180px; justify-content: flex-end; position: relative; z-index: 2;">
                                    <div style="width: 100%; height: 93%; background: linear-gradient(to top, #4DB6AC, #6EC2B8); border-radius: 8px 8px 0 0; position: relative; border: 1px solid #26A69A; border-bottom: none;">
                                        <span style="position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 0.85rem; font-weight: 700; color: var(--primary-dark);">93%</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">Nov 2025</span>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; height: 180px; justify-content: flex-end; position: relative; z-index: 2;">
                                    <div style="width: 100%; height: 85%; background: linear-gradient(to top, var(--primary), #00897B); border-radius: 8px 8px 0 0; position: relative; border: 1px solid var(--primary-dark); border-bottom: none; box-shadow: 0 2px 8px rgba(0, 105, 92, 0.2);">
                                        <span style="position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 0.85rem; font-weight: 700; color: var(--primary-dark);">85%</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">Jan 2026</span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 8px; color: var(--primary-dark);">
                                <i class="fas fa-arrow-trend-up"></i>
                                <span style="font-weight: 600; font-size: 0.9rem;">+17% improvement over 2 years</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Action Items & Quick Stats -->
                    <div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
                        
                        <!-- Quick Stats -->
                        <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06); transition: all 0.3s;" onmouseover="this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.boxShadow='0 4px 24px rgba(0, 0, 0, 0.06)'">
                            <h4 style="font-size: 1rem; margin-bottom: 20px; font-weight: 800; letter-spacing: -0.3px;">Quick Stats</h4>
                            
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-size: 0.85rem; color: var(--text-muted);">Days Until Audit</span>
                                    <span style="font-weight: 700; font-size: 1.2rem; color: var(--text-main);">6</span>
                                </div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-size: 0.85rem; color: var(--text-muted);">Open Findings</span>
                                    <span style="font-weight: 700; font-size: 1.2rem; color: var(--text-main);">2</span>
                                </div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-size: 0.85rem; color: var(--text-muted);">Readiness Score</span>
                                    <span style="font-weight: 700; font-size: 1.2rem; color: var(--primary);">78%</span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-fill" style="width: 78%;"></div>
                                </div>
                            </div>

                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-size: 0.85rem; color: var(--text-muted);">Documents Ready</span>
                                    <span style="font-weight: 700; font-size: 1.2rem;">12/15</span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-fill" style="width: 80%;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Items -->
                        <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06); transition: all 0.3s;" onmouseover="this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.boxShadow='0 4px 24px rgba(0, 0, 0, 0.06)'">
                            <h4 style="font-size: 1rem; margin-bottom: 20px; font-weight: 800; letter-spacing: -0.3px;">Priority Actions</h4>
                            
                            <div style="padding: 12px; background: var(--bg-subtle); border-left: 3px solid var(--primary-dark); border-radius: 6px; margin-bottom: 12px;">
                                <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; color: var(--text-main);">
                                    <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 6px;"></i>Review Narcotic Logs
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Due: Feb 8 (2 days)</div>
                            </div>

                            <div style="padding: 12px; background: var(--bg-subtle); border-left: 3px solid var(--primary); border-radius: 6px; margin-bottom: 12px;">
                                <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; color: var(--text-main);">
                                    <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 6px;"></i>Upload Temp Records
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Due: Feb 9 (3 days)</div>
                            </div>

                            <div style="padding: 12px; background: var(--bg-subtle); border-left: 3px solid #80CBC4; border-radius: 6px;">
                                <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; color: var(--text-main);">
                                    <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 6px;"></i>Staff Training Records
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Due: Feb 10 (4 days)</div>
                            </div>
                        </div>

                        <!-- Peer Comparison -->
                        <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06); transition: all 0.3s;" onmouseover="this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.boxShadow='0 4px 24px rgba(0, 0, 0, 0.06)'">
                            <h4 style="font-size: 1rem; margin-bottom: 8px; font-weight: 800; letter-spacing: -0.3px;">Peer Comparison</h4>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px; font-weight: 500;">Similar pharmacies in your region</p>
                            
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="font-size: 0.85rem;">Your Score</span>
                                    <span style="font-weight: 700; color: var(--primary);">85%</span>
                                </div>
                                <div class="progress-container" style="background: var(--primary-light);">
                                    <div class="progress-fill" style="width: 85%;"></div>
                                </div>
                            </div>

                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="font-size: 0.85rem;">Peer Average</span>
                                    <span style="font-weight: 700; color: #6B7280;">72%</span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-fill" style="width: 72%; background: #9CA3AF;"></div>
                                </div>
                            </div>

                            <div style="margin-top: 16px; padding: 10px; background: var(--primary-light); border-radius: 6px; text-align: center;">
                                <i class="fas fa-trophy" style="color: var(--primary); margin-right: 6px;"></i>
                                <span style="font-size: 0.85rem; font-weight: 600; color: var(--primary-dark);">Above Average</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Tailored Prep Section -->
                <div style="background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%); border: 2px solid var(--primary); border-radius: 20px; padding: 40px; margin-bottom: 40px; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(0, 105, 92, 0.15);">
                    <!-- Decorative Elements -->
                    <div style="position: absolute; top: -40px; right: -40px; width: 180px; height: 180px; background: rgba(255, 255, 255, 0.3); border-radius: 50%; filter: blur(40px);"></div>
                    <div style="position: absolute; bottom: -60px; left: -60px; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; filter: blur(50px);"></div>
                    
                    <div style="position: relative; z-index: 1;">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 32px;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, #004D40 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.6rem; box-shadow: 0 8px 24px rgba(0, 105, 92, 0.4); border: 3px solid rgba(255, 255, 255, 0.5);">
                                <i class="fas fa-bullseye"></i>
                            </div>
                            <div>
                                <h3 style="font-size: 1.6rem; margin: 0 0 6px 0; color: var(--primary-dark); font-weight: 900; letter-spacing: -0.5px;">Tailored Prep for Inspector J. Smith</h3>
                                <p style="margin: 0; color: #00695C; font-size: 1rem; font-weight: 600;">Custom checklist based on 85% narcotic focus pattern + your history</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                            
                            <!-- Checklist Item 1 -->
                            <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); transition: all 0.3s; border: 2px solid transparent;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.12)'; this.style.borderColor='#FECACA'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0, 0, 0, 0.08)'; this.style.borderColor='transparent'">
                                <div style="display: flex; align-items: start; gap: 14px; margin-bottom: 16px;">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);">
                                        <i class="fas fa-pills" style="color: #EF4444; font-size: 1.1rem;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 800; font-size: 1.05rem; margin-bottom: 6px; color: var(--text-main); letter-spacing: -0.3px;">Narcotic Log Audit</div>
                                        <div style="font-size: 0.75rem; color: #EF4444; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Critical Priority</div>
                                    </div>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-muted); line-height: 1.8;">
                                    <li>Verify all entries Dec 12-18</li>
                                    <li>Check dual signatures present</li>
                                    <li>Confirm daily counts match</li>
                                    <li>Review destruction records</li>
                                </ul>
                                <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-subtle); font-size: 0.75rem; color: var(--text-muted);">
                                    <i class="fas fa-chart-line"></i> Flagged in 85% of Smith's audits
                                </div>
                            </div>

                            <!-- Checklist Item 2 -->
                            <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); transition: all 0.3s; border: 2px solid transparent;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.12)'; this.style.borderColor='#FDE68A'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0, 0, 0, 0.08)'; this.style.borderColor='transparent'">
                                <div style="display: flex; align-items: start; gap: 14px; margin-bottom: 16px;">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);">
                                        <i class="fas fa-temperature-half" style="color: #F59E0B; font-size: 1.1rem;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 800; font-size: 1.05rem; margin-bottom: 6px; color: var(--text-main); letter-spacing: -0.3px;">Cold Chain Verification</div>
                                        <div style="font-size: 0.75rem; color: #F59E0B; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">High Priority</div>
                                    </div>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-muted); line-height: 1.8;">
                                    <li>Ensure 2°C - 8°C compliance</li>
                                    <li>Check AM/PM log completeness</li>
                                    <li>Verify calibration certificates</li>
                                    <li>Document corrective actions</li>
                                </ul>
                                <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-subtle); font-size: 0.75rem; color: var(--text-muted);">
                                    <i class="fas fa-chart-line"></i> Flagged in 70% of Smith's audits
                                </div>
                            </div>

                            <!-- Checklist Item 3 -->
                            <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); transition: all 0.3s; border: 2px solid transparent;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(0, 0, 0, 0.12)'; this.style.borderColor='#BFDBFE'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0, 0, 0, 0.08)'; this.style.borderColor='transparent'">
                                <div style="display: flex; align-items: start; gap: 14px; margin-bottom: 16px;">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);">
                                        <i class="fas fa-flask" style="color: #3B82F6; font-size: 1.1rem;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 800; font-size: 1.05rem; margin-bottom: 6px; color: var(--text-main); letter-spacing: -0.3px;">Sterile Compounding</div>
                                        <div style="font-size: 0.75rem; color: #3B82F6; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Medium Priority</div>
                                    </div>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-muted); line-height: 1.8;">
                                    <li>Review aseptic technique logs</li>
                                    <li>Check staff competency dates</li>
                                    <li>Verify BUD calculations</li>
                                    <li>Inspect cleanroom records</li>
                                </ul>
                                <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-subtle); font-size: 0.75rem; color: var(--text-muted);">
                                    <i class="fas fa-chart-line"></i> Flagged in 45% of Smith's audits
                                </div>
                            </div>

                        </div>

                        <div style="display: flex; gap: 16px; justify-content: center;">
                            <button class="btn-primary" style="padding: 14px 32px; font-size: 1rem; display: flex; align-items: center; gap: 10px; box-shadow: 0 6px 20px rgba(0, 105, 92, 0.3); font-weight: 700; transition: all 0.2s;" onclick="openModal('inspectorModal')" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 28px rgba(0, 105, 92, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(0, 105, 92, 0.3)'">
                                <i class="fas fa-file-download"></i> Download Full Checklist
                            </button>
                        </div>

                        <div style="margin-top: 28px; padding: 20px 24px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-radius: 12px; display: flex; align-items: center; gap: 16px; border: 2px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);">
                            <i class="fas fa-lightbulb" style="color: #F59E0B; font-size: 1.4rem;"></i>
                            <div style="font-size: 0.9rem; color: #00695C; font-weight: 500; line-height: 1.6;">
                                <strong style="font-weight: 800;">Pro Tip:</strong> Based on your last audit's conditional pass, Smith will likely re-verify the narcotic reconciliation process. Prepare evidence of implemented corrective actions.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evidence Repository -->
                <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 20px; padding: 32px; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
                        <div>
                            <h3 style="font-size: 1.3rem; margin-bottom: 6px; font-weight: 800; letter-spacing: -0.3px;">Compliance Evidence Repository</h3>
                            <p style="color: var(--text-muted); font-size: 0.95rem; margin: 0; font-weight: 500;">Documents ready for inspection</p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        
                        <div style="border: 2px solid var(--border-subtle); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04); background: white;" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 12px rgba(0, 0, 0, 0.04)'">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);">
                                <i class="fas fa-file-pdf" style="color: #EF4444; font-size: 1.3rem;"></i>
                            </div>
                            <div style="font-weight: 800; font-size: 0.95rem; margin-bottom: 6px; letter-spacing: -0.2px;">Narcotic Logs</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 500;">Updated Jan 31</div>
                            <div style="margin-top: 8px;">
                                <span style="font-size: 0.7rem; padding: 2px 8px; background: #DCFCE7; color: #166534; border-radius: 4px; font-weight: 600;">VERIFIED</span>
                            </div>
                        </div>

                        <div style="border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; cursor: pointer; transition: 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
                            <div style="width: 40px; height: 40px; background: #DBEAFE; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                                <i class="fas fa-temperature-half" style="color: #3B82F6; font-size: 1.2rem;"></i>
                            </div>
                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">Temp Logs</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Updated Feb 6</div>
                            <div style="margin-top: 8px;">
                                <span style="font-size: 0.7rem; padding: 2px 8px; background: #DCFCE7; color: #166534; border-radius: 4px; font-weight: 600;">VERIFIED</span>
                            </div>
                        </div>

                        <div style="border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; cursor: pointer; transition: 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
                            <div style="width: 40px; height: 40px; background: #E0F2F1; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                                <i class="fas fa-graduation-cap" style="color: var(--primary); font-size: 1.2rem;"></i>
                            </div>
                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">Training Records</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Updated Dec 15</div>
                            <div style="margin-top: 8px;">
                                <span style="font-size: 0.7rem; padding: 2px 8px; background: #FEF3C7; color: #92400E; border-radius: 4px; font-weight: 600;">REVIEW</span>
                            </div>
                        </div>

                        <div style="border: 1px dashed var(--border-subtle); border-radius: 8px; padding: 16px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 120px;" onclick="document.getElementById('evidenceFileInput').click()" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='transparent'">
                            <i class="fas fa-plus-circle" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 8px;"></i>
                            <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted);">Add Document</div>
                            <input type="file" id="evidenceFileInput" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.png,.xlsx,.xls" onchange="handleEvidenceUpload(event)">
                        </div>

                    </div>
                </div>

            </div>
        </section>

        <section id="view-monitoring" class="view-section">
            <div style="max-width: 1400px; margin: 0 auto; padding: 40px; width: 100%;">
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 2rem; margin-bottom: 8px;">Inspection Report Intelligence</h2>
                    <p style="color: var(--text-muted);">Upload reports, track findings, and generate compliant responses</p>
                </div>

                <!-- Upload State - Shows initially -->
                <div id="uploadState" style="display: block;">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <!-- Upload Card -->
                        <div style="background: linear-gradient(135deg, #FFFFFF 0%, #F0F9FF 100%); border: 2px dashed var(--border-subtle); border-radius: var(--radius-xl); padding: 60px 40px; text-align: center; cursor: pointer; transition: var(--transition);" onclick="document.getElementById('reportFileInputInline').click()" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='linear-gradient(135deg, #F0F9FF 0%, #E0F2F1 100%)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='linear-gradient(135deg, #FFFFFF 0%, #F0F9FF 100%)'">
                            <div style="width: 80px; height: 80px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: var(--primary);"></i>
                            </div>
                            <h3 style="font-size: 1.5rem; margin-bottom: 12px; color: var(--text-main);">Upload New Report</h3>
                            <p style="color: var(--text-muted); margin-bottom: 24px; font-size: 1rem;">Drop your pharmacy inspection report here or click to browse</p>
                            <p style="color: var(--text-muted); font-size: 0.9rem;">Supports PDF, DOCX, or scanned images</p>
                            <input type="file" id="reportFileInputInline" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.png" onchange="handleInlineReportUpload(event)">
                        </div>

                        <!-- File Preview after selection -->
                        <div id="uploadedReportPreviewInline" style="margin-top: 32px; display: none;">
                            <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px;">
                                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                                    <i class="fas fa-file-pdf" style="font-size: 3rem; color: #EF4444;"></i>
                                    <div style="flex: 1;">
                                        <div id="uploadedFileNameInline" style="font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;"></div>
                                        <div id="uploadedFileSizeInline" style="font-size: 0.9rem; color: var(--text-muted);"></div>
                                    </div>
                                    <i class="fas fa-times-circle" style="color: var(--text-muted); cursor: pointer; font-size: 1.5rem;" onclick="clearInlineReportUpload()"></i>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">Facility Name (Optional)</label>
                                    <input type="text" id="reportFacilityNameInline" placeholder="e.g., Main Street Pharmacy" style="width: 100%; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 0.95rem;">
                                </div>
                                
                                <div style="margin-bottom: 24px;">
                                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">Inspection Date (Optional)</label>
                                    <input type="date" id="reportInspectionDateInline" style="width: 100%; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 0.95rem;">
                                </div>
                                
                                <button class="btn-primary" style="width: 100%; padding: 16px; font-size: 1rem;" onclick="startInlineReportAnalysis()">
                                    <i class="fas fa-brain"></i> Analyze Report with AI
                                </button>
                            </div>
                        </div>

                        <!-- Recent Reports -->
                        <div style="margin-top: 48px;">
                            <h3 style="font-size: 1.2rem; margin-bottom: 20px; color: var(--text-main);">Recent Reports</h3>
                            <div style="display: grid; gap: 16px;">
                                <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; cursor: pointer; transition: var(--transition);" onclick="loadSampleReport()" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.transform='translateY(0)'">
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <i class="fas fa-file-contract" style="font-size: 2rem; color: var(--primary);"></i>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 700; margin-bottom: 4px;">Inspection_Feb05.pdf</div>
                                            <div style="font-size: 0.85rem; color: var(--text-muted);">Uploaded Feb 5, 2026 • 2 critical issues</div>
                                        </div>
                                        <span style="background: #FEE2E2; color: #991B1B; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">CRITICAL</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Progress State -->
                <div id="analysisState" style="display: none;">
                    <div style="max-width: 700px; margin: 80px auto; text-align: center;">
                        <div class="gen-loader">
                            <div class="gen-spinner"><i class="fas fa-brain"></i></div>
                            <h3 style="margin: 24px 0 32px; font-size: 1.5rem;">Analyzing Inspection Report</h3>
                            <div class="gen-steps">
                                <div class="gen-step" id="inline-step1"><i class="fas fa-circle"></i> Extracting text from document...</div>
                                <div class="gen-step" id="inline-step2"><i class="fas fa-circle"></i> Identifying compliance issues...</div>
                                <div class="gen-step" id="inline-step3"><i class="fas fa-circle"></i> Matching with regulations...</div>
                                <div class="gen-step" id="inline-step4"><i class="fas fa-circle"></i> Generating recommendations...</div>
                                <div class="gen-step" id="inline-step5"><i class="fas fa-circle"></i> Preparing report...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Detail State - Shows after analysis -->
                <div id="reportDetailState" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <button onclick="backToUpload()" style="padding: 10px 20px; background: white; border: 1px solid var(--border-subtle); border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: var(--transition);" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
                            <i class="fas fa-arrow-left"></i> Back to Upload
                        </button>
                    </div>

                <!-- Header Card with File Info -->
                <div style="background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%); border: 2px solid var(--primary); border-radius: var(--radius-lg); padding: 32px; margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 24px;">
                        <div style="width: 64px; height: 64px; background: var(--primary); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.8rem;">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="font-size: 1.5rem; margin-bottom: 4px;">Inspection Report Intelligence</h3>
                            <p style="color: var(--text-muted); font-size: 0.95rem;">Inspection_Feb05.pdf • Uploaded & Processed Feb 5, 2026</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">AI Confidence</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">94%</div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid var(--border-subtle); text-align: center;">
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; font-weight: 600;">TOTAL FINDINGS</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-main);">4</div>
                        </div>
                        <div style="background: #FEE2E2; padding: 16px; border-radius: 12px; border: 1px solid #FECACA; text-align: center;">
                            <div style="font-size: 0.8rem; color: #EF4444; margin-bottom: 4px; font-weight: 600;">LAWS (CRITICAL)</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #EF4444;">2</div>
                        </div>
                        <div style="background: #FEF9E7; padding: 16px; border-radius: 12px; border: 1px solid #FDE68A; text-align: center;">
                            <div style="font-size: 0.8rem; color: #D97706; margin-bottom: 4px; font-weight: 600;">GUIDELINES</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #F59E0B;">1</div>
                        </div>
                        <div style="background: #F0F9FF; padding: 16px; border-radius: 12px; border: 1px solid #BAE6FD; text-align: center;">
                            <div style="font-size: 0.8rem; color: #0369A1; margin-bottom: 4px; font-weight: 600;">BEST PRACTICES</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #0EA5E9;">1</div>
                        </div>
                    </div>

                    <!-- AI Insights -->
                    <div style="background: white; border: 1px solid var(--primary-light); border-radius: 12px; padding: 24px;">
                        <div style="display: flex; gap: 16px;">
                            <div style="flex: 1;">
                                <h4 style="font-size: 1.1rem; margin-bottom: 12px; font-weight: 700;">AI Insights & Recommendations</h4>
                                <ul style="list-style: none; padding: 0; margin: 0; line-height: 1.7; font-size: 0.9rem;">
                                    <li style="margin-bottom: 10px;"><i class="fas fa-gavel" style="color: #EF4444; margin-right: 8px;"></i> <strong>2 Critical Laws Detected:</strong> Narcotic log signatures and temperature monitoring gaps require immediate corrective action.</li>
                                    <li style="margin-bottom: 10px;"><i class="fas fa-book-open" style="color: #F59E0B; margin-right: 8px;"></i> <strong>1 Guideline Flagged:</strong> Pharmacy layout privacy concern should be addressed with cost-effective solutions within 30 days.</li>
                                    <li style="margin-bottom: 10px;"><i class="fas fa-lightbulb" style="color: #0EA5E9; margin-right: 8px;"></i> <strong>1 Best Practice Suggested:</strong> Digital backup system recommendation can enhance operational efficiency but carries zero compliance risk.</li>
                                    <li style="margin-bottom: 10px;"><i class="fas fa-chart-line" style="color: #10B981; margin-right: 8px;"></i> <strong>Priority Breakdown:</strong> Focus on 2 critical law violations first (legal requirement), then address guideline (professional standard), finally consider best practice (optional optimization).</li>
                                    <li><i class="fas fa-clock" style="color: #0EA5E9; margin-right: 8px;"></i> <strong>Estimated Resolution Time:</strong> Critical items: 2-3 days | Guideline: 1-2 weeks | Best practice: Optional implementation timeline.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Details & Actions -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                    <!-- Document Metadata -->
                    <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 1rem; font-weight: 700;">Document Details</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; font-size: 0.9rem;">
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                                <span style="color: var(--text-muted);">File Name</span>
                                <span style="font-weight: 600;">Inspection_Feb05.pdf</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                                <span style="color: var(--text-muted);">Pages Analyzed</span>
                                <span style="font-weight: 600;">15 pages</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                                <span style="color: var(--text-muted);">Upload Date</span>
                                <span style="font-weight: 600;">Feb 5, 2026</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                                <span style="color: var(--text-muted);">Processing Time</span>
                                <span style="font-weight: 600;">2.3 seconds</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                                <span style="color: var(--text-muted);">Regulations Checked</span>
                                <span style="font-weight: 600;">47 standards</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                                <span style="color: var(--text-muted);">Last Updated</span>
                                <span style="font-weight: 600;">2 hours ago</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 1rem; font-weight: 700;">Quick Actions</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button class="btn-primary" style="width: 100%; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-file-alt"></i> View Original Report
                            </button>
                            <button class="btn-primary" style="width: 100%; background: white; color: var(--primary); border: 2px solid var(--primary); padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-download"></i> Download Analysis Report
                            </button>
                            <button class="btn-primary" style="width: 100%; background: var(--accent-green); padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="showAllConfirmedResponses()">
                                <i class="fas fa-clipboard-check"></i> Review All Responses
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Findings List -->
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 1.2rem; margin-bottom: 20px; margin-top: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle" style="color: #EF4444;"></i> Detected Issues
                    </h3>

                    <!-- Issue 1 -->
                    <div style="background: white; border: 1px solid #FECACA; border-left: 4px solid #EF4444; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: var(--shadow-card);" id="issue1-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="display: flex; gap: 16px; flex: 1;">
                                <div style="position: relative; align-self: flex-start;">
                                    <button onclick="toggleIssueStatusMenu('issue1')" style="padding: 8px 16px; background: white; border: 2px solid #D1D5DB; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: #4B5563; display: flex; align-items: center; gap: 6px; transition: 0.2s;" id="issue1-status-btn" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='#D1D5DB'; this.style.background='white'">
                                        <i class="fas fa-circle" style="font-size: 0.6rem;"></i> Set Status
                                    </button>
                                    <div id="issue1-menu" style="display: none; position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-subtle); border-radius: 12px; box-shadow: var(--shadow-float); min-width: 200px; z-index: 1000;">
                                        <div onclick="setIssueStatus('issue1', 'resolved')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#F0FDF4'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-check-circle" style="color: #22C55E; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Mark as Resolved</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue1', 'ignore')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-eye-slash" style="color: #6B7280; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Ignore (N/A)</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue1', 'followup')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#FEF9E7'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-clock" style="color: #F59E0B; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Needs Follow-up</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue1', 'reset')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-undo" style="color: #6B7280; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Reset Status</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <span style="background: #FEE2E2; color: #991B1B; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700;">Law - Critical</span>
                                    <span style="background: #F3F4F6; color: #4B5563; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600;">NAPRA 5.1.2.2</span>
                                </div>
                                <h4 style="font-size: 1.1rem; margin-bottom: 8px; font-weight: 700;">Missing Initial Training - Cleaning Personnel</h4>
                                <p style="color: var(--text-muted); line-height: 1.6; font-style: italic; border-left: 3px solid #D1D5DB; padding-left: 12px; margin-bottom: 12px;">"No record of initial training and assessment program for cleaning and disinfecting personnel (pharmacy technicians). NAPRA 5.1.2.2 and 5.1.2.3 requires established programs."</p>
                                
                                <!-- Rule Explanation -->
                                <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 6px; color: #991B1B;"><i class="fas fa-info-circle"></i> Explanations</div>
                                    <p style="font-size: 0.85rem; line-height: 1.6; color: var(--text-muted); margin-bottom: 8px;">NAPRA standards require documented theoretical and practical training for all personnel involved in sterile compounding cleaning to ensure environmental safety and sterility.</p>
                                    <div style="font-size: 0.8rem; color: #7F1D1D; font-weight: 600;">⚠️ Consequence: Potential contamination risk + Non-compliance with standards</div>
                                </div>

                                <!-- Actionable Guidance -->
                                <div style="background: #F9FAFB; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-main);">🎯 Recommended Action</div>
                                    <div style="display: grid; gap: 8px;">
                                        <div style="display: flex; gap: 8px; align-items: start;">
                                            <span style="background: #EF4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; white-space: nowrap;">FIX</span>
                                            <span style="font-size: 0.85rem; color: var(--text-main);"><strong>Immediate:</strong> Develop training program within 30 days. Immediately implement and complete training for current staff. Upload record to ShareFile.</span>
                                        </div>
                                    </div>
                                </div>

                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: white; border: 1px solid #FECACA; color: #991B1B; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-gavel"></i> NAPRA 5.1</span>
                                        <span style="background: white; border: 1px solid #E5E7EB; color: #6B7280; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-calendar"></i> Jun 13, 2024</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <button class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;" onclick="openDraftResponseModal('Missing Initial Training - Cleaning Personnel', 'No record of initial training and assessment program for cleaning and disinfecting personnel (pharmacy technicians). NAPRA 5.1.2.2 and 5.1.2.3 requires established programs.', 'high', 'issue1')"><i class="fas fa-pen"></i> Draft Response</button>
                        </div>
                        <div id="issue1-status" style="margin-top: 12px; padding: 12px; background: #F0FDF4; border: 1px solid #86EFAC; border-radius: 8px; display: none;">
                            <i class="fas fa-check-circle" style="color: #22C55E;"></i> <strong>Response Drafted</strong>
                        </div>
                    </div>

                    <!-- Issue 2 -->
                    <div style="background: white; border: 1px solid #FECACA; border-left: 4px solid #EF4444; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: var(--shadow-card);" id="issue2-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="display: flex; gap: 16px; flex: 1;">
                                <div style="position: relative; align-self: flex-start;">
                                    <button onclick="toggleIssueStatusMenu('issue2')" style="padding: 8px 16px; background: white; border: 2px solid #D1D5DB; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: #4B5563; display: flex; align-items: center; gap: 6px; transition: 0.2s;" id="issue2-status-btn" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='#D1D5DB'; this.style.background='white'">
                                        <i class="fas fa-circle" style="font-size: 0.6rem;"></i> Set Status
                                    </button>
                                    <div id="issue2-menu" style="display: none; position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-subtle); border-radius: 12px; box-shadow: var(--shadow-float); min-width: 200px; z-index: 1000;">
                                        <div onclick="setIssueStatus('issue2', 'resolved')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#F0FDF4'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-check-circle" style="color: #22C55E; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Mark as Resolved</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue2', 'ignore')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-eye-slash" style="color: #6B7280; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Ignore (N/A)</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue2', 'followup')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#FEF9E7'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-clock" style="color: #F59E0B; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Needs Follow-up</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue2', 'reset')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-undo" style="color: #6B7280; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Reset Status</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <span style="background: #FEE2E2; color: #991B1B; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700;">Law - Operations</span>
                                    <span style="background: #F3F4F6; color: #4B5563; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600;">Staffing</span>
                                </div>
                                    <h4 style="font-size: 1.1rem; margin-bottom: 8px; font-weight: 700;">Unregulated Staff Criminal Record Checks</h4>
                                    <p style="color: var(--text-muted); line-height: 1.6; font-style: italic; border-left: 3px solid #D1D5DB; padding-left: 12px; margin-bottom: 12px;">"Missing plan for criminal record checks for unregulated personnel involved in restricted activities or delivery. Amendments to Pharmacy and Drug Regulation require this."</p>
                                    
                                    <!-- Rule Explanation -->
                                    <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                        <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 6px; color: #991B1B;"><i class="fas fa-info-circle"></i> Explanations</div>
                                        <p style="font-size: 0.85rem; line-height: 1.6; color: var(--text-muted); margin-bottom: 8px;">Regulatory amendments require all unregulated pharmacy staff delivering meds or involved in restricted activities to have current criminal record checks to ensure public safety.</p>
                                        <div style="font-size: 0.8rem; color: #7F1D1D; font-weight: 600;">⚠️ Consequence: Non-compliance with Pharmacy and Drug Regulation</div>
                                    </div>

                                    <!-- Actionable Guidance -->
                                    <div style="background: #F9FAFB; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                        <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-main);">🎯 Recommended Action</div>
                                        <div style="display: grid; gap: 8px;">
                                            <div style="display: flex; gap: 8px; align-items: start;">
                                                <span style="background: #EF4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; white-space: nowrap;">FIX</span>
                                                <span style="font-size: 0.85rem; color: var(--text-main);"><strong>Immediate:</strong> Document the gap, implement backup digital logger, and provide corrective action plan showing dual monitoring procedures with staff training records.</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: white; border: 1px solid #FECACA; color: #991B1B; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-book"></i> Standard 3.4</span>
                                        <span style="background: white; border: 1px solid #E5E7EB; color: #6B7280; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-calendar"></i> Jan 14, 2026</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <button class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;" onclick="openDraftResponseModal('Unregulated Staff Criminal Record Checks', 'Missing plan for criminal record checks for unregulated personnel involved in restricted activities or delivery. Amendments to Pharmacy and Drug Regulation require this.', 'high', 'issue2')"><i class="fas fa-pen"></i> Draft Response</button>
                        </div>
                        <div id="issue2-status" style="margin-top: 12px; padding: 12px; background: #F0FDF4; border: 1px solid #86EFAC; border-radius: 8px; display: none;">
                            <i class="fas fa-check-circle" style="color: #22C55E;"></i> <strong>Response Drafted</strong>
                        </div>
                    </div>

                    <!-- Issue 3 - GUIDELINE -->
                    <div style="background: white; border: 1px solid #FDE68A; border-left: 4px solid #F59E0B; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: var(--shadow-card);" id="issue3-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="display: flex; gap: 16px; flex: 1;">
                                <div style="position: relative; align-self: flex-start;">
                                    <button onclick="toggleIssueStatusMenu('issue3')" style="padding: 8px 16px; background: white; border: 2px solid #D1D5DB; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: #4B5563; display: flex; align-items: center; gap: 6px; transition: 0.2s;" id="issue3-status-btn" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='#D1D5DB'; this.style.background='white'">
                                        <i class="fas fa-circle" style="font-size: 0.6rem;"></i> Set Status
                                    </button>
                                    <div id="issue3-menu" style="display: none; position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-subtle); border-radius: 12px; box-shadow: var(--shadow-float); min-width: 200px; z-index: 1000;">
                                        <div onclick="setIssueStatus('issue3', 'resolved')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#F0FDF4'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-check-circle" style="color: #22C55E; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Mark as Resolved</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue3', 'ignore')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-eye-slash" style="color: #6B7280; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Ignore (N/A)</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue3', 'followup')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#FEF9E7'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-clock" style="color: #F59E0B; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Needs Follow-up</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue3', 'reset')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-undo" style="color: #6B7280; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Reset Status</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <span style="background: #FEF9E7; color: #D97706; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700;">Guideline - Moderate</span>
                                    <span style="background: #F3F4F6; color: #4B5563; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600;">Page 13, Para 1</span>
                                </div>
                                    <h4 style="font-size: 1.1rem; margin-bottom: 8px; font-weight: 700;">Pharmacy Layout Privacy Concern</h4>
                                    <p style="color: var(--text-muted); line-height: 1.6; font-style: italic; border-left: 3px solid #D1D5DB; padding-left: 12px; margin-bottom: 12px;">"Counselling area lacks visual privacy barrier. NAPRA Model Standards 6.3 recommend semi-private consultation space for sensitive health discussions."</p>
                                    
                                    <!-- Rule Explanation -->
                                    <div style="background: #FEF9E7; border: 1px solid #FDE68A; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                        <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 6px; color: #D97706;"><i class="fas fa-info-circle"></i> Explanations</div>
                                        <p style="font-size: 0.85rem; line-height: 1.6; color: var(--text-muted); margin-bottom: 8px;">NAPRA Model Standards 6.3 are <strong>advisory guidelines</strong>, not mandatory regulations. Provincial colleges adapt these standards differently. The requirement is for patient privacy during counseling - this can be achieved through various means (partitions, private rooms, or scheduling). Complete physical barriers are not always required.</p>
                                        <div style="font-size: 0.8rem; color: #92400E; font-weight: 600;">⚠️ Compliance Note: Flexible implementation - demonstrate privacy measures already in place or propose cost-effective solutions</div>
                                    </div>

                                    <!-- Actionable Guidance -->
                                    <div style="background: #F9FAFB; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                        <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-main);">🎯 Recommended Action</div>
                                        <div style="display: grid; gap: 8px;">
                                            <div style="display: flex; gap: 8px; align-items: start;">
                                                <span style="background: #F59E0B; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; white-space: nowrap;">REVIEW</span>
                                                <span style="font-size: 0.85rem; color: var(--text-main);"><strong>Review:</strong> Show existing privacy measures or propose low-cost solutions like privacy screens ($200-500) or portable partitions. Emphasize commitment to patient confidentiality with current practices.</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: white; border: 1px solid #FDE68A; color: #D97706; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-book-open"></i> Model Standards 6.3</span>
                                        <span style="background: white; border: 1px solid #E5E7EB; color: #6B7280; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-shield-alt"></i> Privacy</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <button class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;" onclick="openDraftResponseModal('Pharmacy Layout Privacy Concern', 'Counselling area lacks visual privacy barrier. NAPRA Model Standards 6.3 recommend semi-private consultation space for sensitive health discussions.', 'medium', 'issue3')"><i class="fas fa-pen"></i> Draft Response</button>
                        </div>
                        <div id="issue3-status" style="margin-top: 12px; padding: 12px; background: #F0FDF4; border: 1px solid #86EFAC; border-radius: 8px; display: none;">
                            <i class="fas fa-check-circle" style="color: #22C55E;"></i> <strong>Response Drafted</strong>
                        </div>
                    </div>

                    <!-- Issue 4 - BEST PRACTICE -->
                    <div style="background: white; border: 1px solid #BAE6FD; border-left: 4px solid #0EA5E9; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: var(--shadow-card);" id="issue4-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="display: flex; gap: 16px; flex: 1;">
                                <div style="position: relative; align-self: flex-start;">
                                    <button onclick="toggleIssueStatusMenu('issue4')" style="padding: 8px 16px; background: white; border: 2px solid #D1D5DB; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; color: #4B5563; display: flex; align-items: center; gap: 6px; transition: 0.2s;" id="issue4-status-btn" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='#D1D5DB'; this.style.background='white'">
                                        <i class="fas fa-circle" style="font-size: 0.6rem;"></i> Set Status
                                    </button>
                                    <div id="issue4-menu" style="display: none; position: absolute; top: calc(100% + 4px); left: 0; background: white; border: 1px solid var(--border-subtle); border-radius: 12px; box-shadow: var(--shadow-float); min-width: 200px; z-index: 1000;">
                                        <div onclick="setIssueStatus('issue4', 'resolved')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#F0FDF4'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-check-circle" style="color: #22C55E; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Mark as Resolved</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue4', 'ignore')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-eye-slash" style="color: #6B7280; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Ignore (N/A)</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue4', 'followup')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border-bottom: 1px solid var(--border-subtle);" onmouseover="this.style.background='#FEF9E7'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-clock" style="color: #F59E0B; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Needs Follow-up</span>
                                        </div>
                                        <div onclick="setIssueStatus('issue4', 'reset')" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s;" onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
                                            <i class="fas fa-undo" style="color: #6B7280; font-size: 1rem;"></i>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Reset Status</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <span style="background: #F0F9FF; color: #0369A1; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700;">Best Practice - Advisory</span>
                                    <span style="background: #F3F4F6; color: #4B5563; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600;">Page 14, Para 3</span>
                                </div>
                                    <h4 style="font-size: 1.1rem; margin-bottom: 8px; font-weight: 700;">Digital Backup System Recommended</h4>
                                    <p style="color: var(--text-muted); line-height: 1.6; font-style: italic; border-left: 3px solid #D1D5DB; padding-left: 12px; margin-bottom: 12px;">"Manual log system in use. While compliant, professional associations recommend cloud-based backup systems for improved disaster recovery and audit efficiency."</p>
                                    
                                    <!-- Rule Explanation -->
                                    <div style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                        <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 6px; color: #0369A1;"><i class="fas fa-info-circle"></i> Explanations</div>
                                        <p style="font-size: 0.85rem; line-height: 1.6; color: var(--text-muted); margin-bottom: 8px;">This is a <strong>professional recommendation</strong>, not a regulatory requirement. Current manual log system is fully compliant. Digital systems offer operational benefits (easier audits, disaster recovery, trend analysis) but are not mandated. This is purely an optimization suggestion.</p>
                                        <div style="font-size: 0.8rem; color: #0369A1; font-weight: 600;">💡 Potential Benefit: Improved efficiency and audit readiness, but zero compliance risk with current system</div>
                                    </div>

                                    <!-- Actionable Guidance -->
                                    <div style="background: #F9FAFB; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                        <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-main);">🎯 Recommended Action</div>
                                        <div style="display: grid; gap: 8px;">
                                            <div style="display: flex; gap: 8px; align-items: start;">
                                                <span style="background: #0EA5E9; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; white-space: nowrap;">OPTIONAL</span>
                                                <span style="font-size: 0.85rem; color: var(--text-main);"><strong>Optional:</strong> This is purely advisory with zero compliance risk. Consider for future efficiency improvements but no action required for this inspection response.</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: white; border: 1px solid #BAE6FD; color: #0369A1; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-lightbulb"></i> Professional Recommendation</span>
                                        <span style="background: white; border: 1px solid #E5E7EB; color: #6B7280; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-cloud"></i> Technology</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                            <button class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;" onclick="openDraftResponseModal('Digital Backup System Recommended', 'Manual log system in use. While compliant, professional associations recommend cloud-based backup systems for improved disaster recovery and audit efficiency.', 'low', 'issue4')"><i class="fas fa-pen"></i> Draft Response</button>
                        </div>
                        <div id="issue4-status" style="margin-top: 12px; padding: 12px; background: #F0FDF4; border: 1px solid #86EFAC; border-radius: 8px; display: none;">
                            <i class="fas fa-check-circle" style="color: #22C55E;"></i> <strong>Response Drafted</strong>
                        </div>
                    </div>
                </div>

                <!-- Generate Consolidated Response Section -->
                <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 32px; text-align: center;">
                    <h3 style="font-size: 1.3rem; margin-bottom: 12px; color: var(--text-main);">Ready to Generate Final Document?</h3>
                    <p style="color: var(--text-muted); margin-bottom: 8px;">After reviewing all individual responses, generate one consolidated document</p>
                    <p style="margin-bottom: 20px; font-size: 0.9rem; font-weight: 600;"><i class="fas fa-info-circle"></i> Combined format ready to send to inspector</p>
                    <button class="btn-primary" style="padding: 14px 32px; font-size: 1rem; background: #14532D;" onclick="showAllConfirmedResponses()">
                        <i class="fas fa-file-contract"></i> Review All Responses
                    </button>
                    <div id="responseCounter" style="margin-top: 12px; font-size: 0.9rem; color: var(--text-muted); font-weight: 600;">
                        <span id="responseCount">0</span> of 4 responses drafted
                    </div>
                </div>

            </div>
        </section>

        <section id="view-partnership" class="view-section">
            <div style="max-width: 1400px; margin: 0 auto; padding: 40px; width: 100%;">
                
                <!-- Header -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <i class="fas fa-globe" style="font-size: 2rem; color: var(--primary);"></i>
                        <h1 style="font-size: 2rem; font-weight: 700; margin: 0;">Partnership Proposal</h1>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 40px; margin-bottom: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
                        <h2 style="font-size: 1.75rem; color: var(--primary); margin: 0;">Executive Summary</h2>
                        <div class="chip" style="background: var(--primary-light); color: var(--primary); border: none; font-weight: 600;">
                            Partnership Discussion
                        </div>
                    </div>
                    
                    <p style="font-size: 1rem; line-height: 1.7; color: var(--text-main); margin-bottom: 32px;">
                        This document outlines a partnership opportunity to integrate Algo-Rythmn's proprietary <strong>Pharmacy Compliance Intelligence Platform</strong> with your existing pharmacy operations infrastructure. We transform raw regulatory data and inspection histories into actionable business intelligence for compliance management, inspector preparation, and operational excellence.
                    </p>

                    <!-- Core Partnership Concept -->
                    <div style="background: var(--bg-subtle); border-left: 4px solid var(--primary); padding: 24px; margin-bottom: 32px; border-radius: 8px;">
                        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 16px; color: var(--text-main);">Core Partnership Concept</h3>
                        <p style="line-height: 1.7; color: var(--text-main);">
                            You provide the foundational pharmacy network and operational data. Algo-Rythmn adds the <strong style="color: var(--primary);">Intelligence Layer</strong> that converts this data into compliance predictions, inspector profiling, and proactive risk management. Together, we move from "reactive compliance" to "predictive excellence."
                        </p>
                    </div>

                    <!-- Market Opportunity -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 16px; color: var(--text-main);">Market Opportunity</h3>
                        <p style="line-height: 1.7; color: var(--text-main);">
                            Pharmacy chains are drowning in compliance requirements but starving for predictive intelligence. By combining your established operational presence with our AI-powered compliance engine, we create a solution that not only ensures regulatory adherence but directly reduces inspection deficiencies, minimizes compliance costs, and identifies operational improvement opportunities.
                        </p>
                    </div>

                    <!-- Value Creation -->
                    <div>
                        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 16px; color: var(--text-main);">Value Creation</h3>
                        <p style="line-height: 1.7; color: var(--text-main);">
                            Our platform transforms static compliance checklists into an interactive operational ecosystem. Features include Inspector Profiling, Regulation-to-Practice matching, Competitor Gap Analysis, and Historical Pattern Recognition. This partnership positions both organizations to capture the high-value pharmacy compliance and operational excellence market segments.
                        </p>
                    </div>
                </div>

                <!-- Deliverable Features & Resource Estimates -->
                <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 40px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px;">
                        <h2 style="font-size: 1.75rem; color: var(--primary); margin: 0;">Deliverable Features & Resource Estimates</h2>
                        <div class="chip" style="background: var(--primary-light); color: var(--primary); border: none; font-weight: 600;">
                            Implementation Roadmap
                        </div>
                    </div>

                    <!-- Features Table -->
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                            <thead>
                                <tr style="background: var(--text-main);">
                                    <th style="padding: 16px; text-align: left; color: white; font-weight: 700; border: 1px solid var(--border-subtle);">Tier / Module</th>
                                    <th style="padding: 16px; text-align: left; color: white; font-weight: 700; border: 1px solid var(--border-subtle);">Features</th>
                                    <th style="padding: 16px; text-align: left; color: white; font-weight: 700; border: 1px solid var(--border-subtle);">Target Customer</th>
                                    <th style="padding: 16px; text-align: left; color: white; font-weight: 700; border: 1px solid var(--border-subtle);">Primary Value</th>
                                    <th style="padding: 16px; text-align: left; color: white; font-weight: 700; border: 1px solid var(--border-subtle);">Est. Resource</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid var(--border-subtle);">
                                    <td style="padding: 20px; vertical-align: top; background: var(--bg-subtle);">
                                        <div style="font-weight: 700; font-size: 1rem; margin-bottom: 8px;">Tier 1: Regulatory Search Intelligence</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic;">Foundation Module</div>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                            <li>Natural Language Search Engine</li>
                                            <li>Canadian Pharmacy Law Database</li>
                                            <li>Real-time Regulatory Updates Feed</li>
                                            <li>NAPRA, Health Canada, Provincial Sources</li>
                                            <li>Citation & Source Management</li>
                                        </ul>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        All Pharmacy Staff & Managers
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Instant access to accurate regulations; reduces research time from hours to seconds.
                                    </td>
                                    <td style="padding: 20px; vertical-align: top; font-weight: 700; color: var(--accent-green); font-size: 1.1rem;">
                                        5 Team-Months
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-subtle);">
                                    <td style="padding: 20px; vertical-align: top; background: var(--bg-subtle);">
                                        <div style="font-weight: 700; font-size: 1rem; margin-bottom: 8px;">Tier 2: Inspection Report Intelligence</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic;">Core Value Module</div>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                            <li>PDF Upload & OCR Processing</li>
                                            <li>AI Classification (Law/Guideline/Best Practice)</li>
                                            <li>Legal Consequence Analysis</li>
                                            <li>Auto-Response Letter Generation</li>
                                            <li>Compliance Priority Scoring</li>
                                        </ul>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Pharmacy Managers & Quality Officers
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Saves 2-3 days per inspection; eliminates legal risk with proper citations and defensible language.
                                    </td>
                                    <td style="padding: 20px; vertical-align: top; font-weight: 700; color: var(--accent-green); font-size: 1.1rem;">
                                        6 Team-Months
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-subtle);">
                                    <td style="padding: 20px; vertical-align: top; background: var(--bg-subtle);">
                                        <div style="font-weight: 700; font-size: 1rem; margin-bottom: 8px;">Tier 3: Pre-Inspection Intelligence</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic;">Predictive Module</div>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                            <li>Inspector Profile Database</li>
                                            <li>Historical Pattern Analysis (45+ audits)</li>
                                            <li>Focus Area Prediction Algorithm</li>
                                            <li>Custom Preparation Checklists</li>
                                            <li>Readiness Scoring System</li>
                                        </ul>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Multi-location Chains & Regional Managers
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Predicts inspector behaviour with 92% confidence; enables targeted prep to reduce findings.
                                    </td>
                                    <td style="padding: 20px; vertical-align: top; font-weight: 700; color: var(--accent-green); font-size: 1.1rem;">
                                        5 Team-Months
                                    </td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-subtle);">
                                    <td style="padding: 20px; vertical-align: top; background: var(--bg-subtle);">
                                        <div style="font-weight: 700; font-size: 1rem; margin-bottom: 8px;">Tier 4: Evidence & Analytics</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic;">Operational Module</div>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                            <li>Compliance Evidence Repository</li>
                                            <li>Document Verification & Tracking</li>
                                            <li>Performance Trend Visualization</li>
                                            <li>Peer Benchmarking Analytics</li>
                                            <li>Audit Trail & History</li>
                                        </ul>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Corporate Compliance & Operations Teams
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Centralizes evidence management; provides data-driven insights for continuous improvement.
                                    </td>
                                    <td style="padding: 20px; vertical-align: top; font-weight: 700; color: var(--accent-green); font-size: 1.1rem;">
                                        4 Team-Months
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 20px; vertical-align: top; background: var(--bg-subtle);">
                                        <div style="font-weight: 700; font-size: 1rem; margin-bottom: 8px;">Tier 5: Strategic Intelligence</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic;">Advanced Module</div>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                            <li>Multi-Year Trend Forecasting</li>
                                            <li>Competitive Gap Analysis</li>
                                            <li>Regulatory Change Impact Modeling</li>
                                            <li>Cost-Benefit Optimization</li>
                                            <li>Strategic Planning Dashboards</li>
                                        </ul>
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Executive Leadership & Strategy Teams
                                    </td>
                                    <td style="padding: 20px; vertical-align: top;">
                                        Transforms compliance from cost center to competitive advantage; enables proactive strategy.
                                    </td>
                                    <td style="padding: 20px; vertical-align: top; font-weight: 700; color: var(--accent-green); font-size: 1.1rem;">
                                        4 Team-Months
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Section -->
                    <div style="margin-top: 40px; padding: 24px; background: var(--primary-light); border-radius: 12px; border: 2px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; color: var(--primary);">Total Implementation Estimate</h3>
                                <p style="margin: 0; color: var(--text-main);">Comprehensive pharmacy compliance intelligence platform</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary);">24 Team-Months</div>
                                <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 4px;">Phased deployment over 15-18 months</div>
                            </div>
                        </div>
                    </div>

                    <!-- Call to Action -->
                    <div style="margin-top: 32px; text-align: center;">
                        <button class="btn-primary" style="padding: 16px 48px; font-size: 1.1rem;" onclick="showToast('Partnership inquiry sent to business development team')">
                            <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>
                            Schedule Partnership Discussion
                        </button>
                    </div>
                </div>

            </div>
        </section>

        <section id="view-settings" class="view-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 40px; width: 100%;">
                <div class="studio-header">
                     <h2>Settings & Configuration</h2>
                     <p>Manage your pharmacy profile, notifications, and AI preferences.</p>
                </div>

                <div style="display: grid; grid-template-columns: 240px 1fr; gap: 40px;">
                    <!-- Settings Nav -->
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div class="chip" style="justify-content: flex-start; background: var(--primary-light); color: var(--primary); border: none;"><i class="fas fa-user"></i> Profile</div>
                        <div class="chip" style="justify-content: flex-start; border: none; background: transparent;"><i class="fas fa-bell"></i> Notifications</div>
                        <div class="chip" style="justify-content: flex-start; border: none; background: transparent;"><i class="fas fa-robot"></i> AI tuning</div>
                        <div class="chip" style="justify-content: flex-start; border: none; background: transparent;"><i class="fas fa-lock"></i> Security</div>
                    </div>

                    <!-- Settings Content -->
                    <div style="background: white; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 32px;">
                        <h3 style="margin-bottom: 24px;">Pharmacy Profile</h3>
                        
                        <div class="detail-row" style="margin-top: 0;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">Pharmacy Licence #</div>
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Used for regulatory lookups</div>
                            </div>
                            <input type="text" value="PH-2024-8892" style="padding: 8px 12px; border: 1px solid var(--border-subtle); border-radius: 6px;">
                        </div>

                        <div class="detail-row">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">Auto-Monitor Netcare</div>
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Automatically check for opioid duplication</div>
                            </div>
                            <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
                        </div>

                        <div class="detail-row">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">Daily Briefing Email</div>
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Receive summary of new alerts at 8:00 AM</div>
                            </div>
                            <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
                        </div>

                        <div class="detail-row" style="border: none;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">Data Retention</div>
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Inspector logs kept for 10 years</div>
                            </div>
                           <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
                        </div>

                        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 12px;">
                            <button class="btn-primary" style="background: white; color: var(--text-main); border: 1px solid var(--border-subtle);">Cancel</button>
                            <button class="btn-primary" id="saveSettingsBtn" onclick="saveSettings()">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-overlay" id="toolWizardModal">
        <div class="modal-box" style="width: 800px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('toolWizardModal')"></i>
            <div id="toolWizardContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="genModal">
        <div class="modal-box" id="genContent">
            </div>
    </div>

    <div class="modal-overlay" id="feedModal">
        <div class="modal-box">
            <i class="fas fa-times modal-close" onclick="closeModal('feedModal')"></i>
            <h2 style="margin-bottom: 24px;"><i class="fas fa-rss" style="color: var(--primary);"></i> College Updates</h2>
            
            <div class="feed-item">
                <span class="feed-tag tag-law">New Law - Critical</span>
                <div style="font-weight: 700; margin-bottom: 4px;">Opioid Verification Standards</div>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">Effective March 1st. All pharmacists must check Netcare before dispensing any opioid agonist therapy. Failure to document this check constitutes professional misconduct.</div>
                <button class="btn-primary" style="padding: 6px 12px; font-size: 0.8rem;">Read Regulation</button>
            </div>
            
            <div class="feed-item">
                <span class="feed-tag tag-news">News</span>
                <div style="font-weight: 700; margin-bottom: 4px;">Licence Renewal Window Open</div>
                <div style="color: var(--text-muted); font-size: 0.9rem;">Renewal window opens in 14 days. Ensure all Continuing Competence (CCP) requirements are logged in your profile before starting the application.</div>
            </div>

            <div class="feed-item">
                <span class="feed-tag tag-law" style="background: #DBEAFE; color: #1E40AF;">Guideline Update</span>
                <div style="font-weight: 700; margin-bottom: 4px;">Symptomatic Prescribing (Minor Ailments)</div>
                <div style="color: var(--text-muted); font-size: 0.9rem;">New algorithms released for UTI and Cold Sore prescribing. Review standard 12.4.</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="inspectorModal">
        <div class="modal-box" style="width: 900px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('inspectorModal')"></i>
            
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                <div style="display: flex; gap: 16px; align-items: center;">
                    <div style="width: 64px; height: 64px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.8rem; font-weight:700; box-shadow: 0 4px 12px rgba(0, 105, 92, 0.2);">JS</div>
                    <div style="flex: 1;">
                        <h2 style="margin: 0 0 4px 0; font-size: 1.5rem;">Pre-Inspection Prep Checklist</h2>
                        <p style="color: var(--text-main); margin: 0; opacity: 0.8;"><strong>Inspector J. Smith</strong> • Next Audit: Feb 21, 2026</p>
                    </div>
                    <button class="btn-primary" onclick="downloadChecklist()" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px;">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>

            <!-- High Priority Warning -->
            <div style="background: #FEF2F2; border: 2px solid #FECACA; border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; gap: 12px; align-items: start;">
                <i class="fas fa-triangle-exclamation" style="color: #EF4444; font-size: 1.5rem; margin-top: 4px;"></i>
                <div>
                    <div style="font-weight: 700; color: #991B1B; margin-bottom: 4px;">Critical Focus Areas</div>
                    <div style="font-size: 0.9rem; color: #7F1D1D;">Inspector Smith flags <strong>Narcotic Reconciliation</strong> in 85% of audits. Prioritize tasks marked with 🔴</div>
                </div>
            </div>

            <!-- Checklist Items -->
            <div style="margin-bottom: 24px; max-height: 450px; overflow-y: auto; padding-right: 8px;">
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <div style="width: 32px; height: 32px; background: #FEE2E2; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #EF4444;">
                            <i class="fas fa-pills"></i>
                        </div>
                        Narcotic Reconciliation (85% Priority)
                    </h3>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">🔴 Verify all narcotic count sheets have dual signatures for last 30 days</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 15.2</span>
                    </div>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">🔴 Reconcile actual counts vs. system for all Narcotics and Controlled Drugs</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 15.3</span>
                    </div>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">🔴 Check destruction log - ensure proper witness signatures</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 15.7</span>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <div style="width: 32px; height: 32px; background: #FEF3C7; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #F59E0B;">
                            <i class="fas fa-temperature-half"></i>
                        </div>
                        Temperature Monitoring (70% Priority)
                    </h3>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">🟡 Review fridge logs for last 90 days - no gaps allowed</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 18.1</span>
                    </div>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">🟡 Verify temperature excursion documentation and resolutions</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 18.2</span>
                    </div>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">🟡 Check calibration certificates for all thermometers</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 18.3</span>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <div style="width: 32px; height: 32px; background: #DBEAFE; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #3B82F6;">
                            <i class="fas fa-flask"></i>
                        </div>
                        Sterile Compounding (45% Priority)
                    </h3>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">Ensure surface cleaning logs are current (last 7 days)</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">NAPRA 4.1</span>
                    </div>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">Verify staff competency assessments are up to date</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">NAPRA 4.3</span>
                    </div>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">Check hood certification expiry dates</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">NAPRA 4.2</span>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <div style="width: 32px; height: 32px; background: #E0F2F1; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        General Documentation
                    </h3>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">Review patient counselling records for last 50 prescriptions</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 9.4</span>
                    </div>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">Verify all staff licences are current and posted</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 2.1</span>
                    </div>
                    
                    <div class="check-item" style="background: white; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="updateChecklistProgress(this)">
                        <span style="flex: 1;">Update pharmacy manager contact info if changed</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Standard 1.2</span>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div style="background: var(--bg-subtle); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div>
                        <div style="font-weight: 700; font-size: 1.1rem;">Completion Progress</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted);">Track your preparation status</div>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary);" id="checklistProgressText">0/15</div>
                </div>
                <div class="progress-container" style="height: 12px;">
                    <div class="progress-fill" id="checklistProgressBar" style="width: 0%;"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px;">
                <button class="btn-primary" onclick="downloadChecklist()" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-file-pdf"></i> Download as PDF
                </button>
                <button class="btn-primary" onclick="emailChecklist()" style="flex: 1; background: white; color: var(--primary); border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-envelope"></i> Email to Team
                </button>
                <button class="btn-primary" onclick="printChecklist()" style="flex: 1; background: white; color: var(--text-main); border: 2px solid var(--border-subtle); display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="monitoringModal">
        <div class="modal-box" style="width: 900px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('monitoringModal')"></i>
            
            <!-- Header -->
            <div style="border-bottom: 2px solid var(--border-subtle); padding-bottom: 20px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                    <div style="width: 48px; height: 48px; background: var(--primary-light); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-file-contract" style="color: var(--primary); font-size: 1.3rem;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h2 style="margin: 0 0 4px 0;">Inspection Report Intelligence</h2>
                        <div style="font-size: 0.9rem; color: var(--text-muted);">Inspection_Feb05.pdf • Uploaded & Processed Feb 5, 2026</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">AI Confidence</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-green);">94%</div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <div style="background: #FEF2F2; padding: 12px; border-radius: 8px; border: 1px solid #FECACA; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 800; color: #991B1B;">3</div>
                        <div style="font-size: 0.75rem; color: #7F1D1D; font-weight: 600;">Total Findings</div>
                    </div>
                    <div style="background: #FEE2E2; padding: 12px; border-radius: 8px; border: 1px solid #FECACA; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 800; color: #DC2626;">2</div>
                        <div style="font-size: 0.75rem; color: #991B1B; font-weight: 600;">Critical</div>
                    </div>
                    <div style="background: #FEF9E7; padding: 12px; border-radius: 8px; border: 1px solid #FDE68A; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 800; color: #D97706;">1</div>
                        <div style="font-size: 0.75rem; color: #92400E; font-weight: 600;">Moderate</div>
                    </div>
                    <div style="background: #F0FDF4; padding: 12px; border-radius: 8px; border: 1px solid #BBF7D0; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 800; color: #166534;">70%</div>
                        <div style="font-size: 0.75rem; color: #14532D; font-weight: 600;">Compliance</div>
                    </div>
                </div>
            </div>

            <!-- Findings List -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: 1.05rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-circle" style="color: #EF4444;"></i> Detected Issues
                </h3>

                <!-- Issue 1 -->
                <div style="background: white; border: 1px solid #FECACA; border-left: 4px solid #EF4444; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span class="feed-tag tag-law">Law - Critical</span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Page 4, Para 2</span>
                            </div>
                            <div style="font-weight: 700; font-size: 1.05rem; margin-bottom: 6px; color: var(--text-main);">Narcotic Log Signature Missing</div>
                            <div style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; margin-bottom: 10px;">"Logbook on Dec 12 lacks pharmacist initial. Entry shows 'JD' but no licensed pharmacist signature per Section 56(1) Narcotic Control Regulations."</div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="font-size: 0.75rem; padding: 4px 8px; background: #F3F4F6; border-radius: 4px; color: var(--text-muted);"><i class="fas fa-scale-balanced" style="margin-right: 4px;"></i>NCR Section 56(1)</span>
                                <span style="font-size: 0.75rem; padding: 4px 8px; background: #F3F4F6; border-radius: 4px; color: var(--text-muted);"><i class="fas fa-calendar" style="margin-right: 4px;"></i>Dec 12, 2025</span>
                            </div>
                        </div>
                        <button class="btn-primary" style="padding: 6px 14px; font-size: 0.8rem; white-space: nowrap;" onclick="openDraftResponseModal('Narcotic Log Signature Missing', 'Logbook on Dec 12 lacks pharmacist initial. Entry shows JD but no licensed pharmacist signature per Section 56(1) Narcotic Control Regulations.', 'high');">Draft Response</button>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle); display: flex; gap: 12px;">
                        <button style="font-size: 0.8rem; padding: 6px 12px; background: #F3F4F6; border: none; border-radius: 6px; cursor: pointer; color: var(--text-main);">
                            <i class="fas fa-check-circle" style="margin-right: 4px; color: var(--accent-green);"></i>Mark Resolved
                        </button>
                        <button style="font-size: 0.8rem; padding: 6px 12px; background: #F3F4F6; border: none; border-radius: 6px; cursor: pointer; color: var(--text-main);">
                            <i class="fas fa-comment" style="margin-right: 4px; color: var(--primary);"></i>Add Note
                        </button>
                    </div>
                </div>

                <!-- Issue 2 -->
                <div style="background: white; border: 1px solid #FECACA; border-left: 4px solid #EF4444; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span class="feed-tag tag-law">Law - Critical</span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Page 6, Para 1</span>
                            </div>
                            <div style="font-weight: 700; font-size: 1.05rem; margin-bottom: 6px; color: var(--text-main);">Temperature Log Gap</div>
                            <div style="font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; margin-bottom: 10px;">"Missing evening temperature check for Jan 14. Fridge log shows only AM reading (4.2°C). Evening check required per Standard 3.4."</div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="font-size: 0.75rem; padding: 4px 8px; background: #F3F4F6; border-radius: 4px; color: var(--text-muted);"><i class="fas fa-book" style="margin-right: 4px;"></i>Standard 3.4</span>
                                <span style="font-size: 0.75rem; padding: 4px 8px; background: #F3F4F6; border-radius: 4px; color: var(--text-muted);"><i class="fas fa-calendar" style="margin-right: 4px;"></i>Jan 14, 2026</span>
                            </div>
                        </div>
                        <button class="btn-primary" style="padding: 6px 14px; font-size: 0.8rem; white-space: nowrap;" onclick="openDraftResponseModal('Temperature Log Gap', 'Missing evening temperature check for Jan 14. Fridge log shows only AM reading (4.2°C). Evening check required per Standard 3.4.', 'high');">Draft Response</button>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle); display: flex; gap: 12px;">
                        <button style="font-size: 0.8rem; padding: 6px 12px; background: #F3F4F6; border: none; border-radius: 6px; cursor: pointer; color: var(--text-main);">
                            <i class="fas fa-check-circle" style="margin-right: 4px; color: var(--accent-green);"></i>Mark Resolved
                        </button>
                        <button style="font-size: 0.8rem; padding: 6px 12px; background: #F3F4F6; border: none; border-radius: 6px; cursor: pointer; color: var(--text-main);">
                            <i class="fas fa-comment" style="margin-right: 4px; color: var(--primary);"></i>Add Note
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Insights -->
            <div style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border: 1px solid #BAE6FD; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <div style="display: flex; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: #0EA5E9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 8px 0; font-size: 1rem;">AI Analysis & Recommendations</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 0.9rem; color: #0C4A6E; line-height: 1.8;">
                            <li><strong>Pattern Detection:</strong> Narcotic documentation issues appear 3x in past year. Consider implementing dual-check system.</li>
                            <li><strong>Risk Assessment:</strong> Temperature gaps could lead to product integrity concerns. Recommend digital monitoring solution.</li>
                            <li><strong>Compliance Trend:</strong> Your score improved from 65% (last audit) to 70%. On track for 80%+ with these fixes.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Document Info -->
            <div style="background: #F9FAFB; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 12px 0; font-size: 0.95rem;">Document Details</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 0.85rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">File Name:</span>
                        <span style="font-weight: 600;">Inspection_Feb05.pdf</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Pages Analyzed:</span>
                        <span style="font-weight: 600;">12 pages</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Upload Date:</span>
                        <span style="font-weight: 600;">Feb 5, 2026</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Processing Time:</span>
                        <span style="font-weight: 600;">2.3 seconds</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Regulations Checked:</span>
                        <span style="font-weight: 600;">47 standards</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">Last Updated:</span>
                        <span style="font-weight: 600;">2 hours ago</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; margin-top: 32px;">
                <button onclick="showAllConfirmedResponses()" class="btn-primary" style="flex: 2; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-file-export"></i> Review & Download All Responses
                </button>
                <button onclick="downloadReport()" style="flex: 1; padding: 14px; background: white; border: 1px solid var(--border-subtle); border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-download"></i> Download Report
                </button>
            </div>
                </div>
            </div>

    <div class="modal-overlay" id="generateAllModal">
        <div class="modal-box">
            <i class="fas fa-times modal-close" onclick="closeModal('generateAllModal')"></i>
            <h2 style="margin-bottom: 8px;">Generate Consolidated Response</h2>
            <p style="color: var(--text-muted); margin-bottom: 24px;">Combine all individual responses into one formal document ready to send to the inspector.</p>

            <label style="font-weight: 600; display: block; margin-bottom: 8px;">Select Tone Strategy:</label>
            <div class="tone-selector">
                <div class="tone-option selected" onclick="selectTone(this)">
                    <i class="fas fa-check-circle"></i><br>Standard
                </div>
                <div class="tone-option" onclick="selectTone(this)">
                    <i class="fas fa-handshake"></i><br>Conciliatory
                </div>
                <div class="tone-option" onclick="selectTone(this)">
                    <i class="fas fa-gavel"></i><br>Dispute
                </div>
            </div>

            <label style="font-weight: 600; display: block; margin-bottom: 8px; margin-top: 24px;">Select Response Format:</label>
            <div class="tone-selector">
                <div class="tone-option selected" onclick="selectTone(this)">
                    <i class="fas fa-file-lines"></i><br>Formal Letter
                </div>
                <div class="tone-option" onclick="selectTone(this)">
                    <i class="fas fa-envelope"></i><br>Email
                </div>
                <div class="tone-option" onclick="selectTone(this)">
                    <i class="fas fa-list-ol"></i><br>Point-by-Point
                </div>
            </div>

            <div style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 12px; padding: 16px; margin: 24px 0; display: flex; gap: 12px; align-items: flex-start;">
                <i class="fas fa-info-circle" style="color: #0284C7; margin-top: 2px;"></i>
                <div style="font-size: 0.9rem; color: #0C4A6E;">
                    <strong>Note:</strong> This will combine all 4 individual responses into one professional document organized by severity (critical laws → guidelines → best practices). Standard format for regulatory submission.
                </div>
            </div>

            <button class="btn-primary" style="width: 100%;" onclick="startBatchGeneration()"><i class="fas fa-file-contract"></i> Generate Consolidated Document</button>
        </div>
    </div>

    <div class="modal-overlay" id="toolWizardModal">
        <div class="modal-box" style="width: 800px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('toolWizardModal')"></i>
            <div id="toolWizardContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="uploadModal">
        <div class="modal-box" style="width: 700px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('uploadModal')"></i>
            <h2 style="margin-bottom: 8px;">Upload Sources</h2>
            <p style="color: var(--text-muted); margin-bottom: 24px; font-size: 0.95rem;">Add documents, videos, audio, or web links to provide context for AI generation</p>
            
            <div class="file-drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 16px; display: block;"></i>
                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;">Drop files here or click to browse</div>
                <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 16px;">Supports PDF, DOCX, MP4, MP3, TXT and more</div>
                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.mp4,.mp3,.wav" style="display: none;" onchange="handleFileSelect(event)">
            </div>
            
            <div id="uploadPreview" style="margin-top: 24px; display: none;">
                <h4 style="font-size: 0.95rem; font-weight: 700; margin-bottom: 12px; color: var(--text-muted);">FILES TO UPLOAD</h4>
                <div id="filesList" style="max-height: 200px; overflow-y: auto;"></div>
                <button class="btn-primary" style="width: 100%; margin-top: 16px;" onclick="uploadFiles()">
                    <i class="fas fa-upload"></i> Upload <span id="fileCount">0</span> File(s)
                </button>
            </div>
            
            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
                <h4 style="font-size: 0.9rem; font-weight: 700; margin-bottom: 12px;">Quick Add from Templates</h4>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="chip" onclick="addSampleFile('ACP Guidelines 2026', 'pdf')" style="cursor: pointer;">
                        <i class="fas fa-file-pdf"></i> ACP Guidelines 2026
                    </button>
                    <button class="chip" onclick="addSampleFile('Opioid Standard 18.2', 'pdf')" style="cursor: pointer;">
                        <i class="fas fa-file-pdf"></i> Opioid Standard 18.2
                    </button>
                    <button class="chip" onclick="addSampleFile('NAPRA Model Standards', 'pdf')" style="cursor: pointer;">
                        <i class="fas fa-file-pdf"></i> NAPRA Model Standards
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reportQueryModal">
        <div class="modal-box" style="width: 800px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('reportQueryModal')"></i>
            <div style="margin-bottom: 24px;">
                <h2 style="margin-bottom: 4px;">Ask Questions About This Report</h2>
                <p id="selectedReportTitle" style="color: var(--text-muted); font-size: 0.95rem;">Report: Jan 15, 2026 - Regular Audit</p>
            </div>
            
            <div class="query-chat-container">
                <div class="query-messages" id="queryMessages">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p style="font-size: 0.95rem;">Ask any question about this inspection report.<br>I'll help you understand findings, citations, and recommendations.</p>
                    </div>
                </div>
                
                <div class="query-input-box">
                    <input type="text" id="queryInput" placeholder="E.g., What were the main issues found?" onkeypress="handleQueryInput(event)">
                    <button onclick="sendQuery()">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="uploadReportModal">
        <div class="modal-box" style="width: 700px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('uploadReportModal')"></i>
            <h2 style="margin-bottom: 8px;">Upload Inspection Report</h2>
            <p style="color: var(--text-muted); margin-bottom: 24px; font-size: 0.95rem;">Upload your pharmacy inspection report for AI-powered analysis</p>
            
            <div class="file-drop-zone" id="reportDropZone" onclick="document.getElementById('reportFileInput').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 16px;"></i>
                <p style="font-weight: 600; margin-bottom: 8px; color: var(--text-main);">Drop inspection report here or click to browse</p>
                <p style="font-size: 0.85rem; color: var(--text-muted);">Supports PDF, DOCX, or scanned images</p>
                <input type="file" id="reportFileInput" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.png" onchange="handleReportUpload(event)">
            </div>
            
            <div id="uploadedReportPreview" style="margin-top: 24px; display: none;">
                <div style="background: var(--bg-subtle); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-file-pdf" style="font-size: 2rem; color: #EF4444;"></i>
                    <div style="flex: 1;">
                        <div id="uploadedFileName" style="font-weight: 600; margin-bottom: 4px;"></div>
                        <div id="uploadedFileSize" style="font-size: 0.85rem; color: var(--text-muted);"></div>
                    </div>
                    <i class="fas fa-times-circle" style="color: var(--text-muted); cursor: pointer; font-size: 1.2rem;" onclick="clearReportUpload()"></i>
                </div>
            </div>
            
            <div style="margin-top: 24px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Report Details (Optional)</label>
                <input type="text" id="reportFacilityName" placeholder="Facility Name" style="width: 100%; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 12px; font-size: 0.95rem;">
                <input type="date" id="reportInspectionDate" style="width: 100%; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 0.95rem;">
            </div>
            
            <button class="btn-primary" style="width: 100%; margin-top: 24px;" id="analyzeReportBtn" onclick="startReportAnalysis()" disabled>
                <i class="fas fa-brain"></i> Analyze Report with AI
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="analysisProgressModal">
        <div class="modal-box" style="width: 600px; max-width: 95%;">
            <h2 style="text-align: center; margin-bottom: 24px;">Analyzing Inspection Report</h2>
            
            <div class="gen-loader">
                <div class="gen-spinner"><i class="fas fa-brain"></i></div>
                <div class="gen-steps">
                    <div class="gen-step" id="analysis-step1"><i class="fas fa-circle"></i> Extracting text from document...</div>
                    <div class="gen-step" id="analysis-step2"><i class="fas fa-circle"></i> Identifying compliance issues...</div>
                    <div class="gen-step" id="analysis-step3"><i class="fas fa-circle"></i> Matching with regulations...</div>
                    <div class="gen-step" id="analysis-step4"><i class="fas fa-circle"></i> Generating recommendations...</div>
                    <div class="gen-step" id="analysis-step5"><i class="fas fa-circle"></i> Preparing report...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="draftResponseModal">
        <div class="modal-box" style="width: 800px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('draftResponseModal')"></i>
            <h2 style="margin-bottom: 8px;">Draft Response</h2>
            <p style="color: var(--text-muted); margin-bottom: 24px; font-size: 0.95rem;">Add your notes and let AI generate a formal response</p>
            
            <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                <div style="display: flex; gap: 12px;">
                    <i class="fas fa-exclamation-triangle" style="color: #DC2626; font-size: 1.2rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <div>
                        <div style="font-weight: 700; color: #991B1B; margin-bottom: 4px;" id="issueTitle">Issue Title</div>
                        <div style="font-size: 0.9rem; color: #7F1D1D;" id="issueDescription">Issue description</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Your Notes & Action Points</label>
                <textarea id="responseNotes" placeholder="E.g., We have already implemented daily log checks. New SOP was created on Jan 15. Staff training scheduled for next week." style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical;"></textarea>
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Response Tone</label>
                <div class="tone-selector">
                    <div class="tone-option selected" onclick="selectTone(this)" data-tone="professional">
                        <div style="font-weight: 700; margin-bottom: 4px;">Professional</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Formal & detailed</div>
                    </div>
                    <div class="tone-option" onclick="selectTone(this)" data-tone="concise">
                        <div style="font-weight: 700; margin-bottom: 4px;">Concise</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Brief & direct</div>
                    </div>
                    <div class="tone-option" onclick="selectTone(this)" data-tone="collaborative">
                        <div style="font-weight: 700; margin-bottom: 4px;">Collaborative</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Cooperative tone</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Response Format</label>
                <div class="tone-selector">
                    <div class="tone-option selected" onclick="selectTone(this)" data-format="paragraph">
                        <i class="fas fa-align-left" style="font-size: 1.2rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 700;">Paragraph</div>
                    </div>
                    <div class="tone-option" onclick="selectTone(this)" data-format="bullet">
                        <i class="fas fa-list-ul" style="font-size: 1.2rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 700;">Bullet Points</div>
                    </div>
                    <div class="tone-option" onclick="selectTone(this)" data-format="table">
                        <i class="fas fa-table" style="font-size: 1.2rem; margin-bottom: 8px;"></i>
                        <div style="font-weight: 700;">Table Format</div>
                    </div>
                </div>
            </div>
            
            <button class="btn-primary" style="width: 100%;" onclick="generateDraftResponse()">
                <i class="fas fa-wand-magic-sparkles"></i> Generate Response
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="responsePreviewModal">
        <div class="modal-box" style="width: 900px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('responsePreviewModal')"></i>
            <h2 style="margin-bottom: 24px;">Review & Edit Response</h2>
            
            <div style="background: var(--bg-subtle); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                <div style="font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Responding To:</div>
                <div style="font-weight: 700; color: var(--text-main);" id="previewIssueTitle">Issue Title</div>
            </div>
            
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label style="font-weight: 600;">AI-Generated Response</label>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="regenerateResponse()" style="padding: 6px 12px; background: var(--bg-subtle); border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-rotate"></i> Regenerate
                        </button>
                        <button onclick="copyResponse()" style="padding: 6px 12px; background: var(--bg-subtle); border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                <textarea id="generatedResponse" style="width: 100%; min-height: 300px; padding: 16px; border: 1px solid var(--border-subtle); border-radius: 12px; font-size: 0.95rem; font-family: inherit; line-height: 1.6; resize: vertical;"></textarea>
            </div>
            
            <div style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                <div style="display: flex; gap: 12px; align-items: start;">
                    <i class="fas fa-lightbulb" style="color: #0284C7; font-size: 1.2rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <div style="font-size: 0.9rem; color: #0C4A6E;">
                        <strong>Tip:</strong> You can edit the response directly in the text box above. The AI has cited relevant regulations to strengthen your response.
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="closeModal('responsePreviewModal');" style="flex: 1; padding: 14px; background: var(--bg-subtle); border: 1px solid var(--border-subtle); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                    Cancel
                </button>
                <button onclick="confirmResponse()" class="btn-primary" style="flex: 2; padding: 14px; font-size: 0.95rem;">
                    <i class="fas fa-check"></i> Confirm Response
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="allResponsesModal">
        <div class="modal-box" style="width: 1000px; max-width: 95%; max-height: 90vh;">
            <i class="fas fa-times modal-close" onclick="closeModal('allResponsesModal')"></i>
            <h2 style="margin-bottom: 8px;">All Responses - Final Review</h2>
            <p style="color: var(--text-muted); margin-bottom: 24px; font-size: 0.95rem;">Review all responses before downloading the complete package</p>
            
            <div id="allResponsesContainer" style="max-height: 500px; overflow-y: auto; margin-bottom: 24px;">
                <!-- Responses will be populated here -->
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="generateConsolidatedResponse()" class="btn-primary" style="width: 100%; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-file-contract"></i> Generate Consolidated Response
                </button>
            </div>
            
            <!-- Download section - shown after generation -->
            <div id="downloadSection" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <button id="editConsolidatedBtn" onclick="editConsolidatedResponse()" style="flex: 1; padding: 14px; background: white; border: 1px solid var(--border-subtle); border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition);" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='white'">
                        <i class="fas fa-edit"></i> Edit Document
                    </button>
                    <button id="saveConsolidatedBtn" onclick="saveConsolidatedResponse()" style="flex: 1; padding: 14px; background: var(--accent-green); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: none; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="downloadAsWord()" style="flex: 1; padding: 14px; background: white; border: 1px solid var(--border-subtle); border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition);" onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'" onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='white'">
                        <i class="fas fa-file-word" style="color: #2B579A;"></i> Download as Word
                    </button>
                    <button onclick="downloadAsPDF()" class="btn-primary" style="flex: 1; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-file-pdf"></i> Download as PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="regulationModal">
        <div class="modal-box" style="width: 900px; max-width: 95%;">
            <i class="fas fa-times modal-close" onclick="closeModal('regulationModal')"></i>
            <div id="regulationContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="sopModal">
        <div class="modal-box">
            <i class="fas fa-times modal-close" onclick="closeModal('sopModal')"></i>
            <h2 style="margin-bottom: 24px;">SOP Generator Wizard</h2>

            <div class="wizard-step active" id="step1">
                <label style="font-weight: 600; display: block; margin-bottom: 12px;">1. What are we creating?</label>
                <select id="sopType" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-subtle); margin-bottom: 24px;">
                    <option>Standard Operating Procedure (SOP)</option>
                    <option>Incident Report</option>
                    <option>Loss Report</option>
                </select>
                
                <label style="font-weight: 600; display: block; margin-bottom: 12px;">2. Procedure Title</label>
                <input type="text" id="sopTitle" placeholder="e.g. Cold Chain Maintenance" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-subtle); margin-bottom: 24px;">
                
                <label style="font-weight: 600; display: block; margin-bottom: 12px;">3. Key Roles</label>
                <input type="text" id="sopRoles" placeholder="e.g. Pharmacy Manager, Technician" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-subtle); margin-bottom: 24px;">
                
                <button class="btn-primary" style="width: 100%;" onclick="startGeneration('Standard Operating Procedure', 'checklist')">Generate SOP</button>
            </div>
        </div>
    </div>

    <script>
        // === MOCK DATA FOR SEARCH ===
        const knowledgeBase = [
            { question: "training for cleaning personnel", answer: "NAPRA 5.1.2.2 requires established theoretical and practical training and assessment programs for cleaning practices in sterile compounding environments." },
            { question: "hazardous drug transport", answer: "NAPRA 6.9 requires hazardous compounded sterile preparations to be transported in rigid containers marked 'Cytotoxic' to minimize breakage risk." },
            { question: "unregulated staff requirements", answer: "All unregulated pharmacy personnel involved in restricted activities or delivery must have a completed criminal record check." },
            { question: "clinical documentation", answer: "Standard 11.10 requires pharmacists to document rationale/references when prescribing, ensuring use is approved or best practice." },
            { question: "anaphylaxis kit location", answer: "Anaphylaxis kits must be present in the room during administration and not stored remotely if multiple rooms are used." },
            { question: "licence", answer: "Licence renewal window opens 45 days before expiry. Ensure CCP requirements are completed." }
        ];

        // === ISSUE STATUS MANAGEMENT ===
        function toggleIssueStatusMenu(issueId) {
            const menu = document.getElementById(issueId + '-menu');
            const allMenus = document.querySelectorAll('[id$="-menu"]');
            
            // Close all other menus
            allMenus.forEach(m => {
                if (m.id !== issueId + '-menu') {
                    m.style.display = 'none';
                }
            });
            
            // Toggle current menu
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        function setIssueStatus(issueId, status) {
            const card = document.getElementById(issueId + '-card');
            const btn = document.getElementById(issueId + '-status-btn');
            const menu = document.getElementById(issueId + '-menu');
            const heading = card.querySelector('h4');
            
            // Close menu
            menu.style.display = 'none';
            
            // Reset styles first
            card.style.opacity = '';
            card.style.filter = '';
            if (heading) heading.style.textDecoration = '';
            btn.style.borderColor = '';
            btn.style.background = '';
            btn.style.color = '';
            
            if (status === 'resolved') {
                card.style.opacity = '0.6';
                card.style.filter = 'grayscale(50%)';
                if (heading) heading.style.textDecoration = 'line-through';
                btn.innerHTML = '<i class="fas fa-check-circle" style="font-size: 0.9rem; color: #22C55E;"></i> Resolved';
                btn.style.borderColor = '#22C55E';
                btn.style.background = '#F0FDF4';
                btn.style.color = '#15803D';
            } else if (status === 'ignore') {
                card.style.opacity = '0.4';
                card.style.filter = 'grayscale(80%)';
                btn.innerHTML = '<i class="fas fa-eye-slash" style="font-size: 0.9rem; color: #6B7280;"></i> Ignored';
                btn.style.borderColor = '#9CA3AF';
                btn.style.background = '#F9FAFB';
                btn.style.color = '#6B7280';
            } else if (status === 'followup') {
                btn.innerHTML = '<i class="fas fa-clock" style="font-size: 0.9rem; color: #F59E0B;"></i> Follow-up';
                btn.style.borderColor = '#F59E0B';
                btn.style.background = '#FEF9E7';
                btn.style.color = '#D97706';
            } else if (status === 'reset') {
                btn.innerHTML = '<i class="fas fa-circle" style="font-size: 0.6rem;"></i> Set Status';
                btn.style.borderColor = '#D1D5DB';
                btn.style.background = 'white';
                btn.style.color = '#4B5563';
            }
        }
        
        // Close menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[id$="-status-btn"]') && !e.target.closest('[id$="-menu"]')) {
                const allMenus = document.querySelectorAll('[id$="-menu"]');
                allMenus.forEach(m => m.style.display = 'none');
            }
        });

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
             updateGreeting();
             
             // Attach listeners to modal generate buttons
             document.querySelector('#sopModal .btn-primary:last-child').setAttribute('onclick', "startGeneration('Standard Operating Procedure', 'checklist')");
             document.querySelector('#responseModal .btn-primary').setAttribute('onclick', "startGeneration('Draft Response', 'form')");
        });

        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting = "Welcome back";
            if (hour < 12) greeting = "Good Morning";
            else if (hour < 18) greeting = "Hi";
            else greeting = "Good Evening";
            
            const subtitle = document.querySelector('.hero-subtitle');
            if(subtitle) subtitle.innerHTML = `${greeting}, Peter. What would you like to solve today?`;
        }

        // === NAVIGATION ===
        function switchView(viewName, el) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewName)?.classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
        }

        // === SEARCH LOGIC ===
        function handleHomePrompt(e) {
            if (e.key === 'Enter') {
                const query = e.target.value;
                if(query) {
                    showToast("Analyzing query...", "info");
                    setTimeout(() => {
                        switchView('search', document.querySelectorAll('.nav-item')[2]);
                        const searchInput = document.getElementById('searchInput');
                        searchInput.value = query;
                        performSearch();
                    }, 1000);
                }
            }
        }

        function handleSearch(e) {
            if (e.key === 'Enter') performSearch();
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            
            if (!query) return;

            // Simple search logic
            const match = knowledgeBase.find(item => query.includes(item.question) || item.answer.toLowerCase().includes(query));
            
            let html = '';
            if (match) {
                html = `
                    <div class="result-card" style="animation: slideUp 0.3s ease-out;">
                        <h3 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-robot" style="color: var(--primary);"></i> AI Insight
                        </h3>
                        <p style="line-height: 1.6; color: var(--text-main); font-size: 1.1rem;">
                            ${match.answer}
                        </p>
                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <span class="source-pill">Verified Source</span>
                            <span class="source-pill">Updated 2 days ago</span>
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div style="text-align: center; color: var(--text-muted); margin-top: 40px; animation: fadeIn 0.5s;">
                         <p>Analyzing 15,000 documents...</p>
                         <p>No direct match found. Try asking about "fridge temperature" or "opioid".</p>
                    </div>
                `;
            }

            resultsContainer.innerHTML = html;
        }

        // === GENERATION LOGIC ===
        function startBatchGeneration() {
            closeModal('generateAllModal');
            
            const modal = document.getElementById('genModal');
            const content = document.getElementById('genContent');
            
            modal.classList.add('open');
            
            // Show batch generation loading state
            content.innerHTML = `
                <div class="gen-loader">
                    <div class="gen-spinner"><i class="fas fa-circle-notch fa-spin"></i></div>
                    <h3 style="margin-bottom: 24px;">Generating All Responses...</h3>
                    <div class="gen-steps">
                        <div class="gen-step active" id="batch-step1"><i class="fas fa-circle-notch fa-spin"></i> Analyzing all issues...</div>
                        <div class="gen-step" id="batch-step2"><i class="fas fa-circle"></i> Mapping regulations...</div>
                        <div class="gen-step" id="batch-step3"><i class="fas fa-circle"></i> Drafting responses...</div>
                        <div class="gen-step" id="batch-step4"><i class="fas fa-circle"></i> Formatting documents...</div>
                    </div>
                </div>
            `;
            
            // Simulate batch generation steps
            setTimeout(() => { 
                document.getElementById('batch-step1').classList.add('done'); 
                document.getElementById('batch-step1').innerHTML = '<i class="fas fa-check-circle"></i> Analyzed 4 issues';
                document.getElementById('batch-step2').classList.add('active'); 
            }, 800);
            
            setTimeout(() => { 
                document.getElementById('batch-step2').classList.add('done'); 
                document.getElementById('batch-step2').innerHTML = '<i class="fas fa-check-circle"></i> Mapped 8 regulations';
                document.getElementById('batch-step3').classList.add('active'); 
            }, 1800);
            
            setTimeout(() => { 
                document.getElementById('batch-step3').classList.add('done'); 
                document.getElementById('batch-step3').innerHTML = '<i class="fas fa-check-circle"></i> Generated 4 drafts';
                document.getElementById('batch-step4').classList.add('active'); 
            }, 3200);
            
            setTimeout(() => {
                document.getElementById('batch-step4').classList.add('done');
                document.getElementById('batch-step4').innerHTML = '<i class="fas fa-check-circle"></i> Ready for review';
                
                // Show success result
                content.innerHTML = `
                    <i class="fas fa-times modal-close" onclick="closeModal('genModal')"></i>
                    <div style="text-align:center;">
                        <div style="width: 80px; height: 80px; background: #DCFCE7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: #22C55E; font-size: 2.5rem;">
                            <i class="fas fa-check"></i>
                        </div>
                        <h2 style="margin-bottom: 12px;">Consolidated Response Ready!</h2>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">Successfully combined all 4 responses into one professional document ready for inspector submission.</p>
                        
                        <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 24px; text-align: left; margin-bottom: 24px;">
                            <h4 style="margin-bottom: 16px; font-size: 1rem;">Generated Responses:</h4>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #FEE2E2; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-exclamation-circle" style="color: #EF4444;"></i>
                                        <span style="font-size: 0.9rem; font-weight: 600;">Issue #1 - Narcotic Reconciliation Log</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: #991B1B; font-weight: 600;">CRITICAL LAW</span>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #FEE2E2; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-exclamation-circle" style="color: #EF4444;"></i>
                                        <span style="font-size: 0.9rem; font-weight: 600;">Issue #2 - Temperature Monitoring Logs</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: #991B1B; font-weight: 600;">CRITICAL LAW</span>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #FEF3C7; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-exclamation-triangle" style="color: #F59E0B;"></i>
                                        <span style="font-size: 0.9rem; font-weight: 600;">Issue #3 - Patient Privacy Layout</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: #92400E; font-weight: 600;">GUIDELINE</span>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #DBEAFE; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-info-circle" style="color: #3B82F6;"></i>
                                        <span style="font-size: 0.9rem; font-weight: 600;">Issue #4 - Digital Records Backup</span>
                                    </div>
                                    <span style="font-size: 0.75rem; color: #1E3A8A; font-weight: 600;">BEST PRACTICE</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button class="btn-primary" style="flex: 1; background: white; color: var(--primary); border: 2px solid var(--primary);" onclick="closeModal('genModal')">
                                <i class="fas fa-file-alt"></i> Preview Document
                            </button>
                            <button class="btn-primary" style="flex: 1;">
                                <i class="fas fa-paper-plane"></i> Send to Inspector
                            </button>
                        </div>
                    </div>
                `;
                
                showToast('All responses generated successfully!');
            }, 4500);
        }
        
        function startGeneration(title, type) {
            closeModal('sopModal');
            closeModal('responseModal');
            
            const modal = document.getElementById('genModal');
            const content = document.getElementById('genContent');
            
            modal.classList.add('open');
            
            // 1. Show Loading State
            content.innerHTML = `
                <div class="gen-loader">
                    <div class="gen-spinner"><i class="fas fa-circle-notch"></i></div>
                    <h2 style="margin-bottom: 8px;">Generating ${title}...</h2>
                    <div class="gen-steps">
                        <div class="gen-step" id="step1"><i class="fas fa-check-circle"></i> Analyzing Regulations...</div>
                        <div class="gen-step" id="step2"><i class="fas fa-check-circle"></i> Synthesizing Content...</div>
                        <div class="gen-step" id="step3"><i class="fas fa-check-circle"></i> Finalizing Layout...</div>
                    </div>
                </div>
            `;

            // 2. Simulate Steps (Fast for demo)
            setTimeout(() => document.getElementById('step1').classList.add('active'), 300);
            setTimeout(() => { document.getElementById('step1').classList.add('done'); document.getElementById('step2').classList.add('active'); }, 1000);
            setTimeout(() => { document.getElementById('step2').classList.add('done'); document.getElementById('step3').classList.add('active'); }, 2000);
            
            // 3. Show Result (after 3s)
            setTimeout(() => {
                showResult(title, type);
                showToast(`${title} generated successfully!`);
            }, 3000);
        }

        // Global State for Interactive Demos
        let currentSlide = 1;
        const totalSlides = 5;
        const slideContent = [
            { title: "Audit Risks 2026", sub: "Top 3 Focus Areas for Pharmacy Teams" },
            { title: "1. Narcotic Reconciliation", sub: "Ensure all counts are signed daily by 2 staff." },
            { title: "2. Temperature Logs", sub: "Digital logs must be backed up weekly." },
            { title: "3. Sterile Compounding", sub: "New NAPRA standards effective July 1st." },
            { title: "Action Plan", sub: "Download the attached checklist." }
        ];

        function showResult(title, type) {
            const content = document.getElementById('genContent');
            let resultHTML = '';

            if (type === 'audio') {
                // Generate 20 random heights for waveform bars
                let bars = '';
                for(let i=0; i<20; i++) {
                    const h = Math.floor(Math.random() * 80 + 20);
                    const d = (Math.random() * 0.5).toFixed(2); // Random delay
                    bars += `<div class="waveform-bar" style="height: ${h}%; animation-delay: ${d}s;"></div>`;
                }

                resultHTML = `
                    <h2 style="margin-bottom:10px;">${title} Ready</h2>
                    <p style="color:var(--text-muted); margin-bottom:20px;">Podcast summary of Opioid Verification (5m 12s).</p>
                    <div class="preview-box">
                        <div class="audio-player" id="audioPlayer" style="height: 60px; gap: 8px; align-items: center;">
                            <div class="play-btn" onclick="toggleAudio(this)"><i class="fas fa-play"></i></div>
                            <div style="flex:1; height: 30px; display: flex; align-items: center; gap: 2px;">
                                ${bars}
                            </div>
                            <div style="font-size:0.8rem; font-weight:600; color:var(--text-muted); width: 80px; text-align: right;">00:00</div>
                        </div>
                    </div>
                `;
            } else if (type === 'quiz') {
                resultHTML = `
                    <h2 style="margin-bottom:10px;">Staff Quiz Ready</h2>
                    <p style="color:var(--text-muted); margin-bottom:20px;">Test your knowledge on the new SOP.</p>
                    <div class="preview-box" style="background:white; border:1px solid #e5e7eb;">
                        <div class="quiz-question">1. When must the Netcare check be performed?</div>
                        
                        <div class="quiz-option" onclick="runQuiz(this, false)">
                            A) At drop-off
                        </div>
                        <div class="quiz-option" onclick="runQuiz(this, true)">
                            B) Before final sign-off (dispensing)
                        </div>
                        <div class="quiz-option" onclick="runQuiz(this, false)">
                            C) Only for new patients
                        </div>
                        
                        <div id="quizFeedback" style="margin-top: 16px; font-weight: 600; font-size: 0.9rem; text-align: center; height: 20px;"></div>
                    </div>
                `;
            } else if (type === 'slides') {
                // Reset slide state
                currentSlide = 1;
                resultHTML = `
                    <h2 style="margin-bottom:10px;">Inspection Deck Ready</h2>
                    <div class="preview-box" style="background:white;">
                        <div class="slide-preview">
                            <div style="text-align:center;" id="slideContainer" class="slide-content">
                                <h3 style="color:var(--primary); margin-bottom: 12px; font-size: 1.8rem;">${slideContent[0].title}</h3>
                                <p style="font-size:1.1rem; color: var(--text-muted);">${slideContent[0].sub}</p>
                            </div>
                            <div style="position: absolute; bottom: 12px; right: 12px; font-size: 0.8rem; color: #ccc;">AlgoRythmn AI</div>
                        </div>
                        <div class="slide-controls">
                            <button class="btn-primary" style="padding:8px 16px;" onclick="changeSlide(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span style="align-self:center; font-weight:600; min-width: 80px; text-align: center;" id="slideCounter">Slide 1 of ${totalSlides}</span>
                            <button class="btn-primary" style="padding:8px 16px;" onclick="changeSlide(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                `;
            } else if (type === 'checklist' || type === 'form') {
                resultHTML = `
                     <h2 style="margin-bottom:10px;">${title} Generated</h2>
                     <div class="preview-box" style="background:white; text-align:left;">
                         <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                            <span style="font-weight: 700;">Progress</span>
                            <span id="checkProgress">1/3</span>
                         </div>
                         <div class="progress-container" style="margin-bottom: 20px;">
                            <div class="progress-fill" id="checkBar" style="width: 33%;"></div>
                         </div>
                         
                        <div class="check-item" style="display:flex; gap:10px; margin-bottom:10px; padding:10px; border-bottom:1px solid #eee;">
                            <input type="checkbox" checked onclick="updateChecklist(this)"> <span style="text-decoration:line-through; color:#aaa;">Verify Narcotic Safe Logs</span>
                        </div>
                        <div class="check-item" style="display:flex; gap:10px; margin-bottom:10px; padding:10px; border-bottom:1px solid #eee;">
                            <input type="checkbox" onclick="updateChecklist(this)"> <span>Check Fridge Temp Logs (Jan)</span>
                        </div>
                        <div class="check-item" style="display:flex; gap:10px; margin-bottom:10px; padding:10px; border-bottom:1px solid #eee;">
                            <input type="checkbox" onclick="updateChecklist(this)"> <span>Sign Staff Training Matrix</span>
                        </div>
                     </div>
                `;
            }

            content.innerHTML = `
                <i class="fas fa-times modal-close" onclick="closeModal('genModal')"></i>
                <div style="text-align:center;">
                    <div style="font-size:3rem; color:var(--accent-green); margin-bottom:16px;"><i class="fas fa-check-circle"></i></div>
                    ${resultHTML}
                    <div style="margin-top:24px; display:flex; gap:10px; justify-content:center;">
                        <button class="btn-primary"><i class="fas fa-download"></i> Download</button>
                        <button class="btn-primary" style="background:white; color:var(--text-main); border:1px solid #ddd;">Edit</button>
                    </div>
                </div>
            `;
        }

        // === INTERACTIVE DEMO HANDLERS ===
        
        // 1. Audio
        function toggleAudio(btn) {
            const player = document.getElementById('audioPlayer');
            const icon = btn.querySelector('i');
            
            if (player.classList.contains('playing')) {
                player.classList.remove('playing');
                icon.className = 'fas fa-play';
            } else {
                player.classList.add('playing');
                icon.className = 'fas fa-pause';
            }
        }

        // 2. Quiz
        function runQuiz(el, isCorrect) {
            // Reset siblings
            el.parentElement.querySelectorAll('.quiz-option').forEach(opt => {
                opt.className = 'quiz-option';
            });

            if (isCorrect) {
                el.classList.add('correct');
                document.getElementById('quizFeedback').innerHTML = '<span style="color: #15803D"><i class="fas fa-check"></i> Correct! This ensures patient safety before release.</span>';
                showToast("Correct Answer!");
            } else {
                el.classList.add('wrong');
                document.getElementById('quizFeedback').innerHTML = '<span style="color: #991B1B"><i class="fas fa-times"></i> Incorrect. Consult Standard 18.2.</span>';
            }
        }

        // 3. Slides
        function changeSlide(dir) {
            const next = currentSlide + dir;
            if (next < 1 || next > totalSlides) return;
            
            currentSlide = next;
            
            // Update UI
            document.getElementById('slideCounter').innerText = `Slide ${currentSlide} of ${totalSlides}`;
            
            const content = slideContent[currentSlide - 1];
            const container = document.getElementById('slideContainer');
            
            // Animate
            container.style.opacity = '0';
            container.style.transform = 'translateX(10px)';
            
            setTimeout(() => {
                container.innerHTML = `
                    <h3 style="color:var(--primary); margin-bottom: 12px; font-size: 1.8rem;">${content.title}</h3>
                    <p style="font-size:1.1rem; color: var(--text-muted);">${content.sub}</p>
                `;
                container.style.opacity = '1';
                container.style.transform = 'translateX(0)';
            }, 200);
        }

        // 4. Checklist
        function updateChecklist(checkbox) {
            const row = checkbox.parentElement;
            const label = row.querySelector('span');
            
            if (checkbox.checked) {
                label.style.textDecoration = 'line-through';
                label.style.color = '#aaa';
            } else {
                label.style.textDecoration = 'none';
                label.style.color = 'inherit';
            }
            
            // Calc Progress
            const all = document.querySelectorAll('.check-item input');
            const checked = document.querySelectorAll('.check-item input:checked');
            const percent = (checked.length / all.length) * 100;
            
            document.getElementById('checkProgress').innerText = `${checked.length}/${all.length}`;
            document.getElementById('checkBar').style.width = `${percent}%`;
            
            if (percent === 100) showToast("All tasks completed!");
        }

        // === PREP CHECKLIST FUNCTIONS ===
        function updateChecklistProgress(checkbox) {
            const row = checkbox.parentElement;
            const label = row.querySelector('span');
            
            if (checkbox.checked) {
                label.style.textDecoration = 'line-through';
                label.style.opacity = '0.5';
            } else {
                label.style.textDecoration = 'none';
                label.style.opacity = '1';
            }
            
            // Calculate Progress
            const all = document.querySelectorAll('#inspectorModal .check-item input');
            const checked = document.querySelectorAll('#inspectorModal .check-item input:checked');
            const percent = (checked.length / all.length) * 100;
            
            document.getElementById('checklistProgressText').innerText = `${checked.length}/${all.length}`;
            document.getElementById('checklistProgressBar').style.width = `${percent}%`;
            
            if (percent === 100) {
                showToast("🎉 All checklist items completed! You're ready for the inspection!");
            } else if (percent >= 50 && checked.length === Math.ceil(all.length / 2)) {
                showToast("Halfway there! Keep up the good work.");
            }
        }

        function downloadChecklist() {
            showToast('📄 Generating PDF checklist...');
            setTimeout(() => {
                showToast('✅ Checklist downloaded successfully!');
            }, 1500);
        }

        function emailChecklist() {
            showToast('📧 Sending checklist to your team...');
            setTimeout(() => {
                showToast('✅ Email sent successfully!');
            }, 1500);
        }

        function printChecklist() {
            showToast('🖨️ Opening print dialog...');
            setTimeout(() => {
                window.print();
            }, 500);
        }

        // 5. Settings
        function saveSettings() {
            const btn = document.getElementById('saveSettingsBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
            btn.disabled = true;
            
            // Simulating API call
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast("Configuration saved successfully");
            }, 1500);
        }

        // === QUERY FUNCTION BUTTONS ===
        function toggleDeepThinking(btn) {
            btn.classList.toggle('active');
            if (btn.classList.contains('active')) {
                showToast('🧠 Deep Thinking mode enabled - Analysis will be more thorough');
            } else {
                showToast('Deep Thinking mode disabled');
            }
        }

        function toggleDropdown(btn, type) {
            if (type === 'search') {
                showToast('🔍 Search options: Regulatory KB, FDA Database, State Guidelines');
            } else if (type === 'tool') {
                showToast('🛠️ Tools: Document Analyzer, Compliance Checker, Response Generator');
            }
        }

        // === HISTORICAL REPORTS DROPDOWN ===
        let selectedReport = null;

        function toggleReportsDropdown() {
            const btn = document.getElementById('reportsDropdownBtn');
            const menu = document.getElementById('reportsDropdownMenu');
            
            btn.classList.toggle('open');
            menu.classList.toggle('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.querySelector('.reports-dropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                document.getElementById('reportsDropdownBtn')?.classList.remove('open');
                document.getElementById('reportsDropdownMenu')?.classList.remove('open');
            }
        });

        function selectReport(title, verdict, date) {
            selectedReport = { title, verdict, date };
            
            // Update dropdown button text
            document.getElementById('reportsDropdownBtn').textContent = title;
            
            // Close dropdown
            toggleReportsDropdown();
            
            // Open query modal
            openReportQueryModal();
        }

        function openReportQueryModal() {
            if (!selectedReport) return;
            
            // Update modal title
            document.getElementById('selectedReportTitle').textContent = `Report: ${selectedReport.title}`;
            
            // Clear previous messages
            const messagesContainer = document.getElementById('queryMessages');
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                    <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p style="font-size: 0.95rem;">Ask any question about this inspection report.<br>I'll help you understand findings, citations, and recommendations.</p>
                </div>
            `;
            
            // Clear input
            document.getElementById('queryInput').value = '';
            
            // Open modal
            openModal('reportQueryModal');
        }

        function handleQueryInput(e) {
            if (e.key === 'Enter') {
                sendQuery();
            }
        }

        function sendQuery() {
            const input = document.getElementById('queryInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            const messagesContainer = document.getElementById('queryMessages');
            
            // Clear welcome message if exists
            if (messagesContainer.querySelector('div[style*="text-align: center"]')) {
                messagesContainer.innerHTML = '';
            }
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'query-message user';
            userMsg.innerHTML = `<div class="query-bubble">${question}</div>`;
            messagesContainer.appendChild(userMsg);
            
            // Clear input
            input.value = '';
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Simulate AI response
            setTimeout(() => {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'query-message';
                
                // Generate contextual response based on question
                let response = generateReportResponse(question);
                
                aiMsg.innerHTML = `
                    <div class="query-bubble">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-robot" style="color: var(--primary);"></i>
                            <strong style="font-size: 0.9rem;">AI Assistant</strong>
                        </div>
                        <div style="line-height: 1.6;">${response}</div>
                    </div>
                `;
                messagesContainer.appendChild(aiMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 800);
        }

        function generateReportResponse(question) {
            const q = question.toLowerCase();
            
            // Sample responses based on common questions
            if (q.includes('main') || q.includes('key') || q.includes('major')) {
                return `Based on the ${selectedReport.title}, the main issues were:<br><br>
                    <strong>1. Narcotic Reconciliation:</strong> Missing signatures on 3 daily count sheets (Dec 12-14)<br>
                    <strong>2. Temperature Logs:</strong> Gap in refrigerator monitoring for 2 days<br>
                    <strong>3. Counselling Documentation:</strong> 5 prescriptions lacked proper counselling records<br><br>
                    The inspector cited Standards 15.2, 18.1, and 9.4 respectively.`;
            } else if (q.includes('narcotic') || q.includes('controlled')) {
                return `Regarding narcotics in this report:<br><br>
                    The inspector found that daily narcotic count sheets for December 12-14 were missing required co-signatures from two healthcare professionals. This violates <strong>Standard 15.2</strong> of the Pharmacy and Drug Regulations.<br><br>
                    <strong>Recommendation:</strong> Implement a daily checklist system with automated reminders for staff to complete narcotic reconciliation.`;
            } else if (q.includes('temperature') || q.includes('fridge') || q.includes('refrigerator')) {
                return `Temperature monitoring issues found:<br><br>
                    The refrigerator temperature log showed gaps for December 15-16. According to <strong>Standard 18.1</strong>, temperature must be recorded twice daily (morning and evening) without exception.<br><br>
                    The inspector noted that digital monitoring systems with automatic alerts are acceptable alternatives to manual logging.`;
            } else if (q.includes('counselling') || q.includes('documentation') || q.includes('patient')) {
                return `Patient counselling documentation concerns:<br><br>
                    Five new prescriptions dispensed on January 10-12 lacked proper documentation of patient counselling as required by <strong>Standard 9.4</strong>.<br><br>
                    The inspector expects to see notes indicating what was discussed, including medication purpose, dosage instructions, and potential side effects.`;
            } else if (q.includes('verdict') || q.includes('result') || q.includes('outcome')) {
                return `The audit resulted in a <strong>${selectedReport.verdict}</strong>.<br><br>
                    This means corrective actions are required, and a follow-up inspection will be scheduled within 60 days to verify compliance. All findings must be addressed and documented evidence of corrections must be prepared.`;
            } else if (q.includes('fix') || q.includes('solve') || q.includes('correct')) {
                return `To address the findings:<br><br>
                    <strong>Immediate Actions:</strong><br>
                    • Review all narcotic logs and ensure dual signatures moving forward<br>
                    • Implement automated temperature monitoring or daily checklists<br>
                    • Create a counselling documentation template<br><br>
                    <strong>Long-term Solutions:</strong><br>
                    • Staff training on documentation requirements<br>
                    • Regular internal audits to catch gaps early<br>
                    • Consider pharmacy management software with built-in compliance checks`;
            } else {
                return `Based on the ${selectedReport.title}:<br><br>
                    The report contains detailed findings about compliance issues, specific standard citations, and recommended corrective actions. The inspector documented 8 total findings, with 5 classified as mandatory compliance items and 3 as recommendations.<br><br>
                    Could you ask a more specific question? For example:<br>
                    • "What were the main issues?"<br>
                    • "Tell me about the narcotic findings"<br>
                    • "How do I fix the temperature monitoring issue?"`;
            }
        }

        // === UTILS ===
        function showToast(message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        function selectTone(el) {
            // Only remove 'selected' from siblings in the same parent group
            const parent = el.parentElement;
            parent.querySelectorAll('.tone-option').forEach(t => t.classList.remove('selected'));
            el.classList.add('selected');
        }

        // === REGULATION DETAIL MODAL ===
        const regulationData = {
            'hpa': {
                title: 'Health Professions Act (Alberta)',
                type: 'Law / Standard',
                tagClass: 'tag-law',
                summary: 'The Health Professions Act establishes the legal framework for regulated health professions in Alberta. It defines restricted activities that can only be performed by authorized professionals, including prescribing, dispensing, and compounding medications. This legislation provides the foundational authority for pharmacy practice in the province.',
                keyPoints: [
                    'Defines restricted activities requiring professional authorization',
                    'Establishes scope of practice for pharmacists and pharmacy technicians',
                    'Provides legal authority for prescribing and dispensing activities',
                    'Sets framework for professional oversight and disciplinary processes'
                ],
                effectiveDate: 'Current as of: Jan 7, 2026',
                source: 'Government of Alberta',
                category: 'Provincial Legislation',
                url: 'https://open.alberta.ca/publications/h07'
            },
            'fda': {
                title: 'Food and Drugs Act (Canada)',
                type: 'Law / Standard',
                tagClass: 'tag-law',
                summary: 'Canada\'s primary federal legislation governing the safety and efficacy of drugs, medical devices, and food products. This Act provides Health Canada with the authority to regulate drug approval, manufacturing standards, labeling requirements, and distribution practices across the country. Last amended March 27, 2025 to strengthen drug safety monitoring.',
                keyPoints: [
                    'Establishes federal requirements for drug approval and market authorization',
                    'Defines manufacturing, packaging, and labeling standards',
                    'Regulates importation and distribution of drugs across Canada',
                    'Provides enforcement mechanisms for drug safety violations',
                    'Recent amendments strengthen adverse event reporting requirements'
                ],
                effectiveDate: 'Current to: Dec 29, 2025',
                source: 'Health Canada',
                category: 'Federal Act',
                url: 'https://laws-lois.justice.gc.ca/eng/acts/f-27/'
            },
            'spppt': {
                title: 'Standards of Practice for Pharmacists & Pharmacy Technicians',
                type: 'Law / Standard',
                tagClass: 'tag-law',
                summary: 'The ACP Standards of Practice outline mandatory professional obligations for all licensed pharmacists and pharmacy technicians in Alberta. These standards cover clinical decision-making, documentation requirements, patient care responsibilities, and professional conduct. Standard 11 specifically mandates documentation of prescribing rationale and clinical assessments.',
                keyPoints: [
                    'Standard 11 requires comprehensive documentation of prescribing rationale',
                    'Establishes minimum requirements for patient assessment and monitoring',
                    'Defines professional accountability for clinical decisions',
                    'Mandates ongoing competency and continuing education',
                    'Sets expectations for collaboration with other healthcare providers'
                ],
                effectiveDate: 'Effective: Feb 1, 2025',
                source: 'Alberta College of Pharmacy',
                category: 'Professional Standards',
                url: 'https://abpharmacy.ca/articles/standards-practice-pharmacists-pharmacy-technicians'
            },
            'nsc-guidance': {
                title: 'Guidance Document for Non-Sterile Compounding',
                type: 'Guideline',
                tagClass: 'tag-guideline',
                summary: 'This companion guidance document provides detailed clarification on implementing NAPRA\'s Model Standards for non-sterile compounding. It explains how to develop master formulation records, conduct risk assessments for Level A/B/C preparations, and establish quality assurance processes. While not law, it represents best practices recognized across Canadian jurisdictions.',
                keyPoints: [
                    'Clarifies requirements for master formulation record content and format',
                    'Provides risk assessment frameworks for different compounding levels',
                    'Explains beyond-use dating calculations and stability considerations',
                    'Offers practical examples of quality assurance documentation',
                    'Helps distinguish between Level A, B, and C compounding activities'
                ],
                effectiveDate: 'Clarified: Jan 2022',
                source: 'NAPRA',
                category: 'Guidance Document',
                url: 'https://napra.ca/general-practice-resources/model-standards-pharmacy-compounding-non-sterile-preparations'
            },
            'nsc-standards': {
                title: 'Model Standards for Non-Sterile Compounding',
                type: 'Law / Standard',
                tagClass: 'tag-law',
                summary: 'NAPRA\'s Model Standards establish comprehensive requirements for non-sterile preparation compounding across Canada. These standards define three compounding levels (A, B, C) based on risk, set requirements for beyond-use dating, stability testing, quality assurance, and personnel training. Most provinces have adopted these as enforceable regulations.',
                keyPoints: [
                    'Defines Level A (simple), B (moderate), and C (complex) compounding categories',
                    'Establishes beyond-use date requirements based on preparation type',
                    'Mandates stability data and testing for extended dating',
                    'Requires documented training and competency assessment',
                    'Sets environmental controls and cleaning requirements'
                ],
                effectiveDate: 'Clarified: Jan 2022',
                source: 'NAPRA',
                category: 'Model Standards',
                url: 'https://napra.ca/general-practice-resources/model-standards-pharmacy-compounding-non-sterile-preparations'
            },
            'haz-sterile': {
                title: 'Model Standards for Hazardous Sterile Preparations',
                type: 'Law / Standard',
                tagClass: 'tag-law',
                summary: 'These standards govern the compounding of cytotoxic and other hazardous drugs requiring sterile preparation. NAPRA 6.9 mandates dedicated negative pressure rooms with specific air exchange rates, containment devices, and strict transport protocols. Personnel must complete specialized training in hazardous drug handling beyond general sterile compounding competencies.',
                keyPoints: [
                    'Requires dedicated negative pressure rooms for hazardous drug preparation',
                    'Mandates use of closed-system transfer devices for cytotoxic drugs',
                    'Establishes strict containment and transport protocols (NAPRA 6.9)',
                    'Requires specialized training in hazardous drug handling and spill management',
                    'Defines personal protective equipment requirements'
                ],
                effectiveDate: 'Revised: Nov 2016',
                source: 'NAPRA',
                category: 'Hazardous Standards',
                url: 'https://napra.ca/general-practice-resources/model-standards-pharmacy-compounding-hazardous-sterile-preparations'
            },
            'nonhaz-sterile': {
                title: 'Model Standards for Non-Hazardous Sterile Preparations',
                type: 'Law / Standard',
                tagClass: 'tag-law',
                summary: 'Comprehensive standards for sterile compounding of non-hazardous medications, including IV admixtures and ophthalmics. Section 5.1.2 specifically mandates documented training programs for all personnel, including cleaning staff. Environmental monitoring, aseptic technique validation, and media fill testing are required for all compounding pharmacies.',
                keyPoints: [
                    'Section 5.1.2 requires documented training for all personnel including cleaners',
                    'Mandates regular environmental monitoring (air, surface sampling)',
                    'Requires annual aseptic technique validation through media fill testing',
                    'Establishes cleanroom classification and maintenance standards',
                    'Defines beyond-use dating based on USP standards'
                ],
                effectiveDate: 'Revised: Nov 2016',
                source: 'NAPRA',
                category: 'Non-Hazardous Sterile',
                url: 'https://napra.ca/general-practice-resources/model-standards-pharmacy-compounding-non-hazardous-sterile-preparations'
            }
        };

        function showRegulationDetail(regId) {
            const reg = regulationData[regId];
            if (!reg) return;

            const content = `
                <div style="margin-bottom: 20px;">
                    <span class="feed-tag ${reg.tagClass}" style="display: inline-block; margin-bottom: 12px;">${reg.type}</span>
                    <h2 style="font-size: 1.8rem; margin-bottom: 8px; line-height: 1.3;">${reg.title}</h2>
                </div>

                <div class="regulation-summary">
                    <h4><i class="fas fa-sparkles"></i> AI Summary</h4>
                    <p>${reg.summary}</p>
                </div>

                <div class="key-points">
                    <h4><i class="fas fa-list-check"></i> Key Points</h4>
                    ${reg.keyPoints.map(point => `
                        <div class="key-point-item">
                            <div class="key-point-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="key-point-text">${point}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="metadata-grid">
                    <div class="metadata-item">
                        <div class="metadata-label">Source Organization</div>
                        <div class="metadata-value">${reg.source}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Document Type</div>
                        <div class="metadata-value">${reg.category}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Status</div>
                        <div class="metadata-value">${reg.effectiveDate}</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Last Verified</div>
                        <div class="metadata-value">Feb 10, 2026</div>
                    </div>
                </div>

                <div class="source-actions">
                    <button class="btn-source primary" onclick="window.open('${reg.url}', '_blank')">
                        <i class="fas fa-external-link-alt"></i>
                        View Original Source
                    </button>
                    <button class="btn-source secondary" onclick="openRegulationChat('${regId}', '${reg.title}')">
                        <i class="fas fa-comments"></i>
                        Ask AI Questions
                    </button>
                </div>
            `;

            document.getElementById('regulationContent').innerHTML = content;
            openModal('regulationModal');
        }

        function openRegulationChat(regId, regTitle) {
            closeModal('regulationModal');
            
            // Prepare chat interface
            const chatContent = `
                <h2 style="font-size: 1.8rem; margin-bottom: 8px;">Ask Questions About This Regulation</h2>
                <p style="color: var(--text-muted); margin-bottom: 24px; font-size: 0.95rem;">Get AI-powered answers about: <strong>${regTitle}</strong></p>
                
                <div class="query-chat-container">
                    <div class="query-messages" id="regChatMessages">
                        <div class="query-message assistant">
                            <div class="query-bubble">
                                <p style="margin: 0;">Hi! I'm here to help you understand this regulation. You can ask me things like:</p>
                                <ul style="margin: 12px 0 0 0; padding-left: 20px; line-height: 1.8;">
                                    <li>What are the key compliance requirements?</li>
                                    <li>How does this apply to my pharmacy?</li>
                                    <li>What documentation is needed?</li>
                                    <li>What are the penalties for non-compliance?</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="query-input-box">
                        <input type="text" id="regChatInput" placeholder="Type your question..." onkeypress="if(event.key==='Enter') sendRegulationQuestion('${regId}')">
                        <button onclick="sendRegulationQuestion('${regId}')">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('reportQueryModal').querySelector('.modal-box').innerHTML = `
                <i class="fas fa-times modal-close" onclick="closeModal('reportQueryModal')"></i>
                ${chatContent}
            `;
            
            openModal('reportQueryModal');
            setTimeout(() => document.getElementById('regChatInput').focus(), 300);
        }
        
        function sendRegulationQuestion(regId) {
            const input = document.getElementById('regChatInput');
            const question = input.value.trim();
            if (!question) return;
            
            const messagesDiv = document.getElementById('regChatMessages');
            
            // Add user message
            messagesDiv.innerHTML += `
                <div class="query-message user">
                    <div class="query-bubble">${question}</div>
                </div>
            `;
            
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Show typing indicator
            messagesDiv.innerHTML += `
                <div class="query-message assistant" id="typing-indicator">
                    <div class="query-bubble">
                        <i class="fas fa-circle-notch fa-spin"></i> Analyzing regulation...
                    </div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Simulate AI response
            setTimeout(() => {
                document.getElementById('typing-indicator').remove();
                
                const responses = {
                    'hpa': generateHPAResponse(question),
                    'fda': generateFDAResponse(question),
                    'spppt': generateSPPPTResponse(question),
                    'nsc-guidance': generateNSCGuidanceResponse(question),
                    'nsc-standards': generateNSCStandardsResponse(question),
                    'haz-sterile': generateHazSterileResponse(question),
                    'nonhaz-sterile': generateNonHazSterileResponse(question)
                };
                
                const answer = responses[regId] || "Based on this regulation, I recommend consulting the official source document for specific guidance on your question. The regulation establishes binding requirements that must be followed to maintain compliance.";
                
                messagesDiv.innerHTML += `
                    <div class="query-message assistant">
                        <div class="query-bubble">${answer}</div>
                    </div>
                `;
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 1500);
        }
        
        function generateHPAResponse(question) {
            const q = question.toLowerCase();
            if (q.includes('apply') || q.includes('pharmacy')) {
                return "The Health Professions Act applies to all licensed pharmacists and pharmacy technicians in Alberta. It defines restricted activities including prescribing, dispensing, and compounding as activities that can only be performed by authorized health professionals. Your pharmacy must ensure all staff performing these activities hold appropriate licenses.";
            } else if (q.includes('document') || q.includes('requirement')) {
                return "Key documentation requirements include maintaining records of professional authorization, scope of practice decisions, and any restricted activities performed. The ACP can request these records during inspections to verify compliance with the HPA.";
            } else if (q.includes('penalty') || q.includes('violation')) {
                return "Violations of the Health Professions Act can result in professional discipline through the ACP, including fines, license suspension, or revocation. Unauthorized individuals performing restricted activities may face legal prosecution under provincial law.";
            }
            return "The Health Professions Act provides the legal foundation for pharmacy practice in Alberta. It's enforced through the Alberta College of Pharmacy and carries significant professional and legal consequences for non-compliance. What specific aspect would you like to know more about?";
        }
        
        function generateFDAResponse(question) {
            const q = question.toLowerCase();
            if (q.includes('apply') || q.includes('pharmacy')) {
                return "The Food and Drugs Act applies to all pharmacies in Canada that handle prescription and over-the-counter drugs. It governs drug safety, quality standards, labeling, storage, and distribution. Recent amendments (March 2025) strengthened adverse event reporting requirements.";
            } else if (q.includes('document') || q.includes('requirement')) {
                return "Required documentation includes proper drug labeling per FDA regulations, records of drug receipt and distribution, adverse event reporting logs, and compliance with storage temperature requirements. Health Canada may inspect these records.";
            } else if (q.includes('penalty') || q.includes('violation')) {
                return "FDA violations can result in Health Canada enforcement actions including warning letters, monetary penalties up to $5 million, product seizures, and criminal prosecution for serious violations. License suspension or revocation is possible for repeat offenders.";
            }
            return "The Food and Drugs Act is federal law enforced by Health Canada. It sets baseline standards that all Canadian pharmacies must meet. Provincial regulations may add additional requirements but cannot reduce these federal standards.";
        }
        
        function generateSPPPTResponse(question) {
            const q = question.toLowerCase();
            if (q.includes('standard 11') || q.includes('document')) {
                return "Standard 11 requires comprehensive documentation of prescribing rationale including: patient assessment findings, clinical decision-making process, drug and dose selection rationale, and monitoring plan. This must be completed for all prescribing activities by pharmacists.";
            } else if (q.includes('apply') || q.includes('pharmacy')) {
                return "These Standards apply to ALL licensed pharmacists and pharmacy technicians in Alberta. They define minimum professional obligations for patient care, documentation, decision-making, and professional conduct. Compliance is mandatory, not optional.";
            } else if (q.includes('penalty') || q.includes('violation')) {
                return "Violations of the Standards of Practice are professional misconduct and can lead to ACP disciplinary action including mandatory remediation, practice restrictions, fines up to $20,000, license suspension, or revocation depending on severity.";
            }
            return "The ACP Standards of Practice are legally enforceable requirements for all pharmacy professionals in Alberta. They complement the Health Professions Act and are commonly cited in inspection findings. What specific standard are you asking about?";
        }
        
        function generateNSCGuidanceResponse(question) {
            const q = question.toLowerCase();
            if (q.includes('required') || q.includes('mandatory')) {
                return "As a guidance document, this is not technically mandatory law. However, it represents best practices widely recognized across Canada. Many inspectors reference it when evaluating compliance with the related Model Standards (which ARE mandatory). Following this guidance significantly reduces audit risk.";
            } else if (q.includes('level') || q.includes('risk')) {
                return "The guidance explains three compounding levels: Level A (simple, low risk), Level B (moderate complexity), and Level C (complex, high risk). Each level requires different documentation, testing, and quality assurance processes. The guidance provides detailed examples of what qualifies for each level.";
            } else if (q.includes('document') || q.includes('record')) {
                return "The guidance recommends master formulation records include: ingredients and quantities, preparation procedure, equipment needed, beyond-use date rationale, stability references, quality control tests, and labeling requirements. This goes beyond basic recipe documentation.";
            }
            return "This NAPRA guidance document clarifies how to implement the Model Standards for non-sterile compounding. While not law itself, following this guidance demonstrates good-faith compliance efforts and is highly recommended to avoid inspection findings.";
        }
        
        function generateNSCStandardsResponse(question) {
            const q = question.toLowerCase();
            if (q.includes('level') || q.includes('category')) {
                return "Level A: Simple preparations from commercially available products. Level B: Preparations requiring calculations or multiple steps. Level C: Complex preparations requiring special equipment or sterile technique. Each level has specific beyond-use date limits and quality requirements.";
            } else if (q.includes('beyond-use') || q.includes('dating')) {
                return "Beyond-use dates depend on preparation level and packaging. Without stability data: Level A (30 days), Level B (14 days), Level C (varies by product). Longer dating requires published stability studies or your own validation data.";
            } else if (q.includes('training') || q.includes('staff')) {
                return "All personnel involved in compounding must have documented training specific to the level of compounding performed. This includes initial competency assessment and ongoing evaluation. Training records must be available during inspections.";
            }
            return "These NAPRA Model Standards are mandatory in most provinces and set the baseline for non-sterile compounding compliance. Violations are typically cited as regulatory findings requiring corrective action. What aspect of the standards do you need clarification on?";
        }
        
        function generateHazSterileResponse(question) {
            const q = question.toLowerCase();
            if (q.includes('room') || q.includes('facility')) {
                return "NAPRA 6.9 requires dedicated negative pressure rooms for hazardous drug preparation. Minimum 12 air changes/hour, 0.01-0.03 inches water column negative pressure, and HEPA-filtered exhaust. The room must remain under negative pressure at all times during compounding.";
            } else if (q.includes('training') || q.includes('staff')) {
                return "Personnel must complete specialized hazardous drug handling training beyond standard sterile compounding. This includes: spill procedures, PPE donning/doffing, closed-system transfer device use, and exposure prevention. Annual competency reassessment is required.";
            } else if (q.includes('transport') || q.includes('6.9')) {
                return "NAPRA 6.9 mandates strict transport protocols for hazardous preparations: sealed containers, secondary containment, proper labeling ('HAZARDOUS DRUG'), and documented transport logs. Preparations cannot be transported with non-hazardous items.";
            }
            return "Hazardous sterile preparation standards are strictly enforced due to safety risks. Non-compliance can result in immediate suspension of compounding operations. These are typically inspected with extra scrutiny. What specific requirement are you asking about?";
        }
        
        function generateNonHazSterileResponse(question) {
            const q = question.toLowerCase();
            if (q.includes('5.1.2') || q.includes('cleaning') || q.includes('training')) {
                return "Section 5.1.2 explicitly requires documented training for ALL personnel entering the cleanroom, including cleaning staff. Training must cover: gowning procedures, cleaning protocols, appropriate materials, and contamination prevention. Records must show dates and competency verification.";
            } else if (q.includes('monitoring') || q.includes('environmental')) {
                return "Environmental monitoring is mandatory and includes: viable air sampling (monthly minimum), surface sampling of critical areas (daily/weekly depending on location), and documented corrective actions for out-of-spec results. All monitoring must be performed by qualified personnel.";
            } else if (q.includes('media fill') || q.includes('validation')) {
                return "Annual media fill testing (aseptic technique validation) is required for all personnel performing sterile compounding. Failed media fills require immediate remediation and repeat testing before resuming compounding activities. Three consecutive successful tests required initially.";
            }
            return "Non-hazardous sterile compounding standards are comprehensive and frequently cited in inspections. The 5.1.2 cleaning personnel training requirement is one of the most commonly missed items. What specific aspect of sterile compounding compliance do you need help with?";
        }

        function nextStep(stepNum) {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + stepNum).classList.add('active');
        }

        // === INSPECTION REPORT INTELLIGENCE WORKFLOW ===
        
        let uploadedReportFile = null;
        let confirmedResponses = [];
        let currentIssueData = null;
        
        // State Management
        function showUploadState() {
            document.getElementById('uploadState').style.display = 'block';
            document.getElementById('analysisState').style.display = 'none';
            document.getElementById('reportDetailState').style.display = 'none';
        }
        
        function showAnalysisState() {
            document.getElementById('uploadState').style.display = 'none';
            document.getElementById('analysisState').style.display = 'block';
            document.getElementById('reportDetailState').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showReportDetailState() {
            document.getElementById('uploadState').style.display = 'none';
            document.getElementById('analysisState').style.display = 'none';
            document.getElementById('reportDetailState').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function backToUpload() {
            confirmedResponses = [];
            showUploadState();
        }
        
        // Inline Upload Handlers
        function handleInlineReportUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            uploadedReportFile = file;
            
            // Show preview
            document.getElementById('uploadedReportPreviewInline').style.display = 'block';
            document.getElementById('uploadedFileNameInline').textContent = file.name;
            document.getElementById('uploadedFileSizeInline').textContent = (file.size / 1024).toFixed(2) + ' KB';
            
            showToast('📄 Report uploaded successfully');
            
            // Scroll to preview
            document.getElementById('uploadedReportPreviewInline').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function clearInlineReportUpload() {
            uploadedReportFile = null;
            document.getElementById('reportFileInputInline').value = '';
            document.getElementById('uploadedReportPreviewInline').style.display = 'none';
            document.getElementById('reportFacilityNameInline').value = '';
            document.getElementById('reportInspectionDateInline').value = '';
        }
        
        function handleEvidenceUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show success toast
            showToast(`📄 ${file.name} uploaded successfully`);
            
            // You could add more functionality here like:
            // - Display the uploaded file in the grid
            // - Send to server for processing
            // - Add to a list of uploaded documents
            console.log('Evidence document uploaded:', file.name, file.size, 'bytes');
        }
        
        function startInlineReportAnalysis() {
            if (!uploadedReportFile) return;
            
            showAnalysisState();
            
            // Simulate analysis steps
            setTimeout(() => {
                document.getElementById('inline-step1').classList.add('active');
            }, 100);
            
            setTimeout(() => {
                document.getElementById('inline-step1').classList.add('done');
                document.getElementById('inline-step1').querySelector('i').className = 'fas fa-check-circle';
                document.getElementById('inline-step2').classList.add('active');
            }, 400);
            
            setTimeout(() => {
                document.getElementById('inline-step2').classList.add('done');
                document.getElementById('inline-step2').querySelector('i').className = 'fas fa-check-circle';
                document.getElementById('inline-step3').classList.add('active');
            }, 800);
            
            setTimeout(() => {
                document.getElementById('inline-step3').classList.add('done');
                document.getElementById('inline-step3').querySelector('i').className = 'fas fa-check-circle';
                document.getElementById('inline-step4').classList.add('active');
            }, 1200);
            
            setTimeout(() => {
                document.getElementById('inline-step4').classList.add('done');
                document.getElementById('inline-step4').querySelector('i').className = 'fas fa-check-circle';
                document.getElementById('inline-step5').classList.add('active');
            }, 1600);
            
            setTimeout(() => {
                document.getElementById('inline-step5').classList.add('done');
                document.getElementById('inline-step5').querySelector('i').className = 'fas fa-check-circle';
                
                setTimeout(() => {
                    showReportDetailState();
                    showToast('✅ Analysis complete! 2 critical issues detected');
                    clearInlineReportUpload();
                }, 300);
            }, 2000);
        }
        
        function loadSampleReport() {
            setTimeout(() => {
                showReportDetailState();
            }, 400);
        }
        
        // Step 1: Handle Report Upload
        function handleReportUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            uploadedReportFile = file;
            
            // Show preview
            document.getElementById('uploadedReportPreview').style.display = 'block';
            document.getElementById('uploadedFileName').textContent = file.name;
            document.getElementById('uploadedFileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
            
            // Enable analyze button
            document.getElementById('analyzeReportBtn').disabled = false;
        }
        
        function clearReportUpload() {
            uploadedReportFile = null;
            document.getElementById('reportFileInput').value = '';
            document.getElementById('uploadedReportPreview').style.display = 'none';
            document.getElementById('analyzeReportBtn').disabled = true;
        }
        
        // Step 2: Start AI Analysis
        function startReportAnalysis() {
            if (!uploadedReportFile) return;
            
            closeModal('uploadReportModal');
            openModal('analysisProgressModal');
            
            // Simulate analysis steps
            setTimeout(() => {
                document.getElementById('analysis-step1').classList.add('active');
            }, 100);
            
            setTimeout(() => {
                document.getElementById('analysis-step1').classList.add('done');
                document.getElementById('analysis-step1').querySelector('i').className = 'fas fa-check-circle';
                document.getElementById('analysis-step2').classList.add('active');
            }, 400);
            
            setTimeout(() => {
                document.getElementById('analysis-step2').classList.add('done');
                document.getElementById('analysis-step2').querySelector('i').className = 'fas fa-check-circle';
                document.getElementById('analysis-step3').classList.add('active');
            }, 800);
            
            setTimeout(() => {
                document.getElementById('analysis-step3').classList.add('done');
                document.getElementById('analysis-step3').querySelector('i').className = 'fas fa-check-circle';
                document.getElementById('analysis-step4').classList.add('active');
            }, 1200);
            
            setTimeout(() => {
                document.getElementById('analysis-step4').classList.add('done');
                document.getElementById('analysis-step4').querySelector('i').className = 'fas fa-check-circle';
                document.getElementById('analysis-step5').classList.add('active');
            }, 1600);
            
            setTimeout(() => {
                document.getElementById('analysis-step5').classList.add('done');
                document.getElementById('analysis-step5').querySelector('i').className = 'fas fa-check-circle';
                
                setTimeout(() => {
                    closeModal('analysisProgressModal');
                    openModal('monitoringModal');
                    
                    // Reset for next upload
                    clearReportUpload();
                }, 300);
            }, 2000);
        }
        
        // Step 3: Open Draft Response Modal
        function openDraftResponseModal(title, description, severity, issueId) {
            currentIssueData = { title, description, severity, issueId };
            
            document.getElementById('issueTitle').textContent = title;
            document.getElementById('issueDescription').textContent = description;
            
            // Pre-fill with existing notes if available
            const existingResponse = confirmedResponses.find(r => r.issueId === issueId);
            if (existingResponse) {
                document.getElementById('responseNotes').value = existingResponse.notes || '';
            } else {
                document.getElementById('responseNotes').value = '';
            }
            
            // Reset selections
            document.querySelectorAll('#draftResponseModal .tone-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector('#draftResponseModal .tone-option[data-tone="professional"]')?.classList.add('selected');
            document.querySelector('#draftResponseModal .tone-option[data-format="paragraph"]')?.classList.add('selected');
            
            openModal('draftResponseModal');
        }
        
        // Step 4: Generate Draft Response
        function generateDraftResponse() {
            const notes = document.getElementById('responseNotes').value;
            const tone = document.querySelector('#draftResponseModal .tone-option.selected[data-tone]')?.getAttribute('data-tone') || 'professional';
            const format = document.querySelector('#draftResponseModal .tone-option.selected[data-format]')?.getAttribute('data-format') || 'paragraph';
            
            closeModal('draftResponseModal');
            
            // Show generation progress
            const modal = document.getElementById('genModal');
            const content = document.getElementById('genContent');
            modal.classList.add('open');
            
            content.innerHTML = `
                <div class="gen-loader">
                    <div class="gen-spinner"><i class="fas fa-wand-magic-sparkles"></i></div>
                    <p style="text-align: center; color: var(--text-muted); margin-top: 16px;">Generating formal response...</p>
                </div>
            `;
            
            // Generate response based on issue
            setTimeout(() => {
                let response = generateResponseText(currentIssueData.title, notes, tone, format);
                
                document.getElementById('previewIssueTitle').textContent = currentIssueData.title;
                document.getElementById('generatedResponse').value = response;
                
                closeModal('genModal');
                openModal('responsePreviewModal');
            }, 1000);
        }
        
        function generateResponseText(issueTitle, notes, tone, format) {
            // Generate contextual responses based on issue type
            let responses = {
                'Missing Initial Training - Cleaning Personnel': `We take NAPRA 5.1.2.2 and 5.1.2.3 requirements seriously and have taken immediate action to address this deficiency.

Upon review, we identified that while our pharmacy technicians received verbal instruction on cleaning protocols, we did not have a documented theoretical and practical training program for sterile compounding cleaning practices.

Corrective Actions Implemented:
• Developed comprehensive training program covering NAPRA standards for cleaning/disinfecting (completed February 8th)
• Conducted formal training sessions for all pharmacy technicians with documented assessments (completed February 9th)
• Created training records with signatures and competency verification for all personnel
• Implemented annual refresher training requirement with documented assessments
• Uploaded all training records to our secure ShareFile system for regulatory access

${notes ? 'Additional Context: ' + notes + '\\n\\n' : ''}As per NAPRA 5.1.2 standards, we now maintain documented evidence of both theoretical knowledge and practical competency for all personnel involved in sterile compounding cleaning. Our training program includes environmental monitoring, proper disinfectant use, and contamination prevention protocols.`,
                
                'Unregulated Staff Criminal Record Checks': `We acknowledge that recent amendments to the Pharmacy and Drug Regulation require criminal record checks for unregulated personnel involved in restricted activities or delivery.

Thank you for bringing the criminal record check requirement to our attention. We acknowledge that recent amendments to the Pharmacy and Drug Regulation require criminal record checks for unregulated personnel involved in restricted activities or delivery.

Upon review, we identified that our current policies did not reflect these regulatory amendments regarding unregulated staff performing controlled substance delivery or restricted pharmacy activities.

Corrective Actions Implemented:
• Immediately initiated criminal record checks for all unregulated staff involved in delivery or restricted activities (in progress - completion expected February 20th)
• Updated our Human Resources policy to require criminal record checks before any unregulated staff performs these duties
• Created a tracking system to monitor criminal record check expiry dates with annual renewal requirements
• Provided training to pharmacy management on the new regulatory requirements
• Temporarily reassigned unregulated staff from restricted activities until clearances are obtained

${notes ? 'Additional Context: ' + notes + '\\n\\n' : ''}As per the Pharmacy and Drug Regulation amendments, all unregulated personnel will maintain current criminal record checks on file before participating in medication delivery or any restricted pharmacy activities. We have implemented a compliance tracking system to ensure ongoing adherence to this requirement.`,
                
                'Pharmacy Layout Privacy Concern': `While we understand NAPRA Model Standards 6.3 are advisory guidelines, we recognize the importance of patient confidentiality during health consultations.

Current Privacy Measures:
• We currently maintain patient privacy through strategic scheduling that minimizes overlapping consultations
• Our staff is trained to speak in low tones during sensitive discussions
• We utilize a separate consultation room for more sensitive discussions when needed

Proposed Enhancements:
• We will install a semi-private consultation barrier (privacy screen partition) within the next 30 days to enhance visual privacy
• The estimated cost for this improvement is $300-500 for a professional privacy screen
• This will provide additional visual privacy while maintaining the open, welcoming atmosphere of our pharmacy

${notes ? 'Additional Context: ' + notes + '\\n\\n' : ''}We recognize that while NAPRA Model Standards 6.3 are guidelines (not mandatory regulations), implementing these best practices demonstrates our commitment to patient confidentiality. The proposed privacy screen solution balances privacy needs with operational efficiency and represents a cost-effective enhancement to our existing privacy measures.`,
                
                'Digital Backup System Recommended': `We appreciate professional guidance that helps us optimize our operations.

Current System Status:
• Our current manual log system is fully compliant with all regulatory requirements
• We maintain meticulous paper records with proper documentation and secure storage
• Our existing system has served us reliably with zero compliance issues to date

Future Considerations:
${notes ? notes + '\\n\\n' : ''}We acknowledge that digital backup systems offer operational benefits including improved audit efficiency, disaster recovery capabilities, and trend analysis features. While we recognize these advantages, we currently prioritize addressing mandatory compliance requirements before implementing optional technology enhancements.

As this recommendation represents a professional best practice rather than a regulatory requirement, we will:
• Continue to maintain our compliant manual log system
• Evaluate digital backup solutions as part of our annual technology assessment
• Consider implementation when budget and resources permit`,
                
                'Narcotic Log Signature Missing': `We take controlled substance documentation with the utmost seriousness and have taken immediate corrective action.

Upon investigation, we identified that the entry on December 12th was completed by pharmacy technician J.D., but the supervising pharmacist's signature was inadvertently omitted from the physical log. The pharmacist was present during the transaction and the entry was properly documented in our electronic system with full credentials.

Corrective Actions Taken:
• Conducted comprehensive audit of all narcotic records for the past 90 days (completed February 7th)
• Implemented a dual-verification system requiring both physical and electronic signature verification
• Provided refresher training to all pharmacy staff on proper narcotic documentation procedures (completed February 9th)
• Updated our Standard Operating Procedure to include mandatory supervisor review before shift end

${notes ? 'Additional Context: ' + notes + '\\n\\n' : ''}As per Section 56(1) of the Narcotic Control Regulations, we have reinforced our commitment to maintaining accurate records with proper signatures for all controlled substances. Our new protocol includes daily supervisor sign-off on all narcotic transactions.`,
                
                'Temperature Log Gap': `We acknowledge the temperature log gap identified during your inspection and have implemented immediate measures to prevent future occurrences.

We acknowledge the temperature log gap identified during your inspection and have implemented immediate measures to prevent future occurrences.

The missing evening entry on January 14th occurred during a staff transition period. While the refrigerator maintained proper temperature throughout (verified by our continuous monitoring device showing 4.1°C evening reading), the manual log entry was inadvertently not completed during shift change.

Immediate Actions Implemented:
• Installed automated temperature monitoring system with digital timestamps and cloud backup (completed February 2nd)
• Set up automatic alerts for any temperature excursions and missing log entries
• Implemented shift-change checklist requiring outgoing staff to verify all log entries before departure
• Established backup procedures with automated SMS alerts to pharmacy manager for any gaps

${notes ? 'Additional Details: ' + notes + '\\n\\n' : ''}Our enhanced temperature monitoring now exceeds Standard 3.4 requirements and aligns with NAPRA Model Standards for Pharmacy Compounding and Health Canada's Good Manufacturing Practices. We have also established weekly audits to ensure continuous compliance.`,
                
                'Narcotic Reconciliation Discrepancy': `We take controlled substance management with the utmost seriousness and have taken immediate corrective action.

Thank you for bringing the narcotic reconciliation discrepancy to our attention. We take controlled substance management with the utmost seriousness and have taken immediate corrective action.

Upon investigation, we identified that the discrepancy on January 28th was due to a documentation error where a return-to-stock was recorded in our electronic system but not transferred to the physical log. The 2 tablets in question have been accounted for and remain in our secure storage.

Corrective Actions Taken:
• Conducted a comprehensive audit of all narcotic records for the past 90 days (completed February 5th)
• Implemented a dual-verification system requiring electronic and physical log reconciliation before end-of-shift
• Provided refresher training to all pharmacy staff on proper narcotic documentation procedures (completed February 8th)
• Updated our Standard Operating Procedure for narcotic handling to include mandatory cross-checks

${notes ? 'Additional Context: ' + notes + '\\n\\n' : ''}As per NAPRA Standards and the Controlled Drugs and Substances Act, we have reinforced our commitment to maintaining accurate records for all controlled substances. Our new protocol includes daily supervisor review of all narcotic transactions.`
            };
            
            return responses[issueTitle] || `Dear Inspector,\\n\\nThank you for your feedback regarding ${issueTitle}.\\n\\n${notes}\\n\\nWe have taken corrective action and remain committed to compliance.\\n\\nSincerely,\\nPharmacy Manager`;
        }
        
        // Step 5: Regenerate or Copy Response
        function regenerateResponse() {
            
            setTimeout(() => {
                const currentResponse = document.getElementById('generatedResponse').value;
                // Add slight variation
                const newResponse = currentResponse.replace('Thank you', 'We appreciate your feedback').replace('Dear Inspector', 'Dear Inspection Team');
                document.getElementById('generatedResponse').value = newResponse;
            }, 1500);
        }
        
        function copyResponse() {
            const response = document.getElementById('generatedResponse').value;
            navigator.clipboard.writeText(response).then(() => {
                showToast('📋 Response copied to clipboard!');
            });
        }
        
        // Step 6: Confirm Response
        function confirmResponse() {
            const response = document.getElementById('generatedResponse').value;
            const issueTitle = document.getElementById('previewIssueTitle').textContent;
            const notes = document.getElementById('responseNotes').value;
            
            // Store confirmed response with issueId
            const existingIndex = confirmedResponses.findIndex(r => r.issueId === currentIssueData.issueId);
            if (existingIndex >= 0) {
                confirmedResponses[existingIndex] = { 
                    title: issueTitle, 
                    response: response, 
                    severity: currentIssueData.severity,
                    issueId: currentIssueData.issueId,
                    notes: notes
                };
            } else {
                confirmedResponses.push({ 
                    title: issueTitle, 
                    response: response, 
                    severity: currentIssueData.severity,
                    issueId: currentIssueData.issueId,
                    notes: notes
                });
            }
            
            // Update UI to show response is ready
            const statusDiv = document.getElementById(currentIssueData.issueId + '-status');
            if (statusDiv) {
                statusDiv.style.display = 'block';
            }
            
            // Update counter
            document.getElementById('responseCount').textContent = confirmedResponses.length;
            
            closeModal('responsePreviewModal');
            
        }
        
        // Step 7: Show All Confirmed Responses
        function showAllConfirmedResponses() {
            if (confirmedResponses.length === 0) {
                showToast('⚠️ Please draft at least one response first');
                return;
            }
            
            const container = document.getElementById('allResponsesContainer');
            
            let html = '';
            confirmedResponses.forEach((item, index) => {
                const severityColors = {
                    'high': { bg: '#FEE2E2', border: '#EF4444', text: '#991B1B' },
                    'medium': { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E' },
                    'low': { bg: '#D1FAE5', border: '#10B981', text: '#065F46' }
                };
                
                const colors = severityColors[item.severity] || severityColors['medium'];
                
                html += `
                    <div style="background: white; border: 1px solid var(--border-subtle); border-radius: 12px; padding: 24px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div>
                                <span style="background: ${colors.bg}; color: ${colors.text}; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">${item.severity} Severity</span>
                                <h3 style="margin-top: 8px; font-size: 1.1rem;">${item.title}</h3>
                            </div>
                            <button onclick="editResponseInReview(${index})" style="padding: 8px 16px; background: var(--bg-subtle); border: 1px solid var(--border-subtle); border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                        <div style="background: var(--bg-subtle); border-radius: 8px; padding: 16px; max-height: 200px; overflow-y: auto;">
                            <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.9rem; line-height: 1.6; margin: 0;">${item.response}</pre>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            openModal('allResponsesModal');
        }
        
        // Helper function to clean and reformat individual responses for consolidation
        function cleanResponseForConsolidation(responseText) {
            // Remove common greetings and closings
            let cleaned = responseText
                .replace(/Dear\s+Inspector\s+[^,\n]*,?\s*/gi, '')
                .replace(/Dear\s+Sir\/Madam,?\s*/gi, '')
                .replace(/To\s+Whom\s+It\s+May\s+Concern,?\s*/gi, '')
                .replace(/Sincerely,?\s*/gi, '')
                .replace(/Respectfully,?\s*/gi, '')
                .replace(/Best\s+regards,?\s*/gi, '')
                .replace(/Regards,?\s*/gi, '')
                .replace(/Thank\s+you,?\s*/gi, '')
                .replace(/Dr\.\s+\w+\s+\w+,?\s*PharmD\s*/gi, '')
                .replace(/Pharmacist\s+Manager\s*/gi, '')
                .replace(/Main\s+Street\s+Pharmacy\s*/gi, '')
                .replace(/Phone:.*$/gm, '')
                .replace(/Email:.*$/gm, '');
            
            // Convert newlines to <br> tags for proper HTML rendering
            cleaned = cleaned.trim()
                .replace(/\n\s*\n\s*\n/g, '</p><p style="margin-bottom: 12px;">')
                .replace(/\n\n/g, '</p><p style="margin-bottom: 12px;">')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraph tag if not already formatted
            if (!cleaned.startsWith('<p')) {
                cleaned = '<p style="margin-bottom: 12px;">' + cleaned + '</p>';
            }
            
            return cleaned;
        }
        
        function generateConsolidatedResponse() {
            if (confirmedResponses.length === 0) {
                showToast('⚠️ Please draft at least one response first');
                return;
            }
            
            
            // Simulate generation process
            setTimeout(() => {
                
                // Organize responses by severity
                const highResponses = confirmedResponses.filter(r => r.severity === 'high');
                const mediumResponses = confirmedResponses.filter(r => r.severity === 'medium');
                const lowResponses = confirmedResponses.filter(r => r.severity === 'low');
                
                const totalIssues = confirmedResponses.length;
                const highCount = highResponses.length;
                const mediumCount = mediumResponses.length;
                const lowCount = lowResponses.length;
                
                // Build sections dynamically
                let sectionsHTML = '';
                let sectionNumber = 1;
                
                // Section 1: Critical Laws (if any)
                if (highCount > 0) {
                    sectionsHTML += `
                        <div style="margin-bottom: 32px;">
                            <div style="background: #FEE2E2; padding: 12px 20px; border-left: 4px solid #EF4444; margin-bottom: 20px;">
                                <h2 style="font-size: 1.3rem; color: #991B1B; margin: 0;">Section ${sectionNumber}: Critical Legal Violations (${highCount} Issue${highCount > 1 ? 's' : ''})</h2>
                            </div>
                    `;
                    
                    highResponses.forEach((item, index) => {
                        const cleanedResponse = cleanResponseForConsolidation(item.response);
                        sectionsHTML += `
                            <div style="margin-bottom: 40px; padding-left: 16px;">
                                <h3 style="font-size: 1.1rem; margin-bottom: 16px; color: #991B1B; font-weight: 700; border-bottom: 1px solid #FEE2E2; padding-bottom: 8px;">Issue ${sectionNumber}.${index + 1}: ${item.title}</h3>
                                <div style="font-size: 0.95rem; line-height: 1.8; color: #374151;">${cleanedResponse}</div>
                            </div>
                        `;
                    });
                    
                    sectionsHTML += `</div>`;
                    sectionNumber++;
                }
                
                // Section 2: Guidelines (if any)
                if (mediumCount > 0) {
                    sectionsHTML += `
                        <div style="margin-bottom: 32px;">
                            <div style="background: #FEF9E7; padding: 12px 20px; border-left: 4px solid #F59E0B; margin-bottom: 20px;">
                                <h2 style="font-size: 1.3rem; color: #92400E; margin: 0;">Section ${sectionNumber}: Professional Guidelines (${mediumCount} Issue${mediumCount > 1 ? 's' : ''})</h2>
                            </div>
                    `;
                    
                    mediumResponses.forEach((item, index) => {
                        const cleanedResponse = cleanResponseForConsolidation(item.response);
                        sectionsHTML += `
                            <div style="margin-bottom: 40px; padding-left: 16px;">
                                <h3 style="font-size: 1.1rem; margin-bottom: 16px; color: #92400E; font-weight: 700; border-bottom: 1px solid #FEF9E7; padding-bottom: 8px;">Issue ${sectionNumber}.${index + 1}: ${item.title}</h3>
                                <div style="font-size: 0.95rem; line-height: 1.8; color: #374151;">${cleanedResponse}</div>
                            </div>
                        `;
                    });
                    
                    sectionsHTML += `</div>`;
                    sectionNumber++;
                }
                
                // Section 3: Best Practices (if any)
                if (lowCount > 0) {
                    sectionsHTML += `
                        <div style="margin-bottom: 32px;">
                            <div style="background: #F0F9FF; padding: 12px 20px; border-left: 4px solid #0EA5E9; margin-bottom: 20px;">
                                <h2 style="font-size: 1.3rem; color: #0369A1; margin: 0;">Section ${sectionNumber}: Best Practice Recommendations (${lowCount} Issue${lowCount > 1 ? 's' : ''})</h2>
                            </div>
                    `;
                    
                    lowResponses.forEach((item, index) => {
                        const cleanedResponse = cleanResponseForConsolidation(item.response);
                        sectionsHTML += `
                            <div style="margin-bottom: 40px; padding-left: 16px;">
                                <h3 style="font-size: 1.1rem; margin-bottom: 16px; color: #0369A1; font-weight: 700; border-bottom: 1px solid #F0F9FF; padding-bottom: 8px;">Issue ${sectionNumber}.${index + 1}: ${item.title}</h3>
                                <div style="font-size: 0.95rem; line-height: 1.8; color: #374151;">${cleanedResponse}</div>
                            </div>
                        `;
                    });
                    
                    sectionsHTML += `</div>`;
                }
                
                // Get current date for submission
                const today = new Date();
                const submissionDate = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const refNumber = 'MSP-IR-' + today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + String(today.getDate()).padStart(2, '0');
                
                // Get pharmacist and inspector names from the page
                const pharmacistName = 'Peter Sloan, PharmD'; // From login user-pill
                const pharmacistTitle = 'Pharmacist Manager';
                const inspectorName = 'Inspector J. Smith'; // From pre-inspection intelligence
                const inspectorTitle = 'Lead Inspector • Calgary North';
                
                // Show preview of consolidated document
                const container = document.getElementById('allResponsesContainer');
                container.innerHTML = `
                    <div style="background: white; border: 2px solid var(--primary); border-radius: 12px; padding: 48px; font-family: Georgia, 'Times New Roman', serif; line-height: 1.6;">
                        <!-- Letterhead -->
                        <div style="text-align: right; margin-bottom: 32px; padding-bottom: 16px; border-bottom: 1px solid #E5E7EB; font-size: 0.9rem;">
                            <div style="font-weight: 600; color: var(--primary);">Main Street Pharmacy</div>
                            <div>123 Main Street, City, Province, A1B 2C3</div>
                            <div>License Number: 12345 • Phone: (555) 123-4567</div>
                            <div>Email: admin@mainstreetpharmacy.com</div>
                        </div>

                        <!-- Document Info -->
                        <div style="margin-bottom: 32px; font-size: 0.9rem;">
                            <div style="margin-bottom: 8px;"><strong>Date:</strong> ${submissionDate}</div>
                            <div style="margin-bottom: 8px;"><strong>Reference:</strong> ${refNumber}</div>
                            <div style="margin-bottom: 8px;"><strong>Re:</strong> Response to Inspection Report dated February 5, 2026</div>
                        </div>

                        <!-- Recipient -->
                        <div style="margin-bottom: 24px;">
                            <div style="font-weight: 600;">${inspectorName}</div>
                            <div>Alberta College of Pharmacy</div>
                            <div>${inspectorTitle}</div>
                            <div>j.smith@abpharmacy.ca</div>
                        </div>

                        <!-- Opening -->
                        <div style="margin-bottom: 32px; line-height: 1.8;">
                            <p style="margin-bottom: 16px;">Dear ${inspectorName},</p>
                            <p style="margin-bottom: 16px;">Thank you for conducting the inspection of Main Street Pharmacy on February 5, 2026. We appreciate the thoroughness of your review and the opportunity to address the findings outlined in your report.</p>
                            <p style="margin-bottom: 16px;">This formal response addresses ${totalIssues} finding${totalIssues > 1 ? 's' : ''} identified during the inspection${highCount > 0 ? ', including ' + highCount + ' critical legal violation' + (highCount > 1 ? 's' : '') : ''}${mediumCount > 0 ? ', ' + mediumCount + ' professional guideline' + (mediumCount > 1 ? 's' : '') : ''}${lowCount > 0 ? ', and ' + lowCount + ' best practice recommendation' + (lowCount > 1 ? 's' : '') : ''}. Each response includes specific corrective actions, timelines, and supporting documentation references.</p>
                        </div>

                        ${sectionsHTML}

                        <!-- Compliance Statement -->
                        <div style="margin-top: 40px; padding: 20px; background: #F0FDF4; border-left: 4px solid #22C55E; border-radius: 8px; margin-bottom: 32px;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: #166534;">Compliance Commitment Statement</h3>
                            <p style="line-height: 1.7; margin: 0;">Main Street Pharmacy is committed to full compliance with all applicable pharmacy regulations, standards, and best practices. We have taken immediate steps to address the critical findings and established a clear timeline for all remaining items. We will provide progress updates as requested and remain available for any follow-up inspections or clarifications.</p>
                        </div>

                        <!-- Action Summary Table -->
                        <div style="margin-bottom: 32px;">
                            <h3 style="font-size: 1.2rem; margin-bottom: 16px; border-bottom: 2px solid #E5E7EB; padding-bottom: 8px;">Summary of Corrective Actions</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: #F9FAFB; border-bottom: 2px solid #E5E7EB;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Category</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600;">Count</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${highCount > 0 ? `<tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 12px;">Critical Legal Violations</td>
                                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #EF4444;">${highCount}</td>
                                        <td style="padding: 12px;">Immediate corrective actions implemented</td>
                                    </tr>` : ''}
                                    ${mediumCount > 0 ? `<tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 12px;">Professional Guidelines</td>
                                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #F59E0B;">${mediumCount}</td>
                                        <td style="padding: 12px;">Implementation plan with defined timeline</td>
                                    </tr>` : ''}
                                    ${lowCount > 0 ? `<tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 12px;">Best Practice Recommendations</td>
                                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #0EA5E9;">${lowCount}</td>
                                        <td style="padding: 12px;">Acknowledged for future consideration</td>
                                    </tr>` : ''}
                                </tbody>
                            </table>
                        </div>

                        <!-- Supporting Documentation -->
                        <div style="margin-bottom: 32px;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 12px;">Attached Supporting Documentation:</h3>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li>Training records and certificates</li>
                                <li>Policy documents and procedural updates</li>
                                <li>Purchase orders and implementation receipts</li>
                                <li>Photographic evidence where applicable</li>
                                <li>Staff acknowledgment forms</li>
                            </ul>
                        </div>

                        <!-- Closing -->
                        <div style="margin-top: 40px; padding-top: 24px; border-top: 2px solid #E5E7EB;">
                            <p style="margin-bottom: 24px; line-height: 1.8;">Should you require any additional information, clarification, or follow-up documentation, please do not hesitate to contact me directly. We appreciate your guidance and look forward to demonstrating our continued commitment to excellence in pharmacy practice.</p>
                            
                            <p style="margin-bottom: 8px;">Respectfully submitted,</p>
                            
                            <div style="margin-top: 40px; margin-bottom: 8px;">
                                <div style="border-bottom: 1px solid #000; width: 200px; margin-bottom: 4px;"></div>
                                <div style="font-weight: 600;">${pharmacistName}</div>
                                <div>${pharmacistTitle}</div>
                                <div style="margin-top: 8px; font-size: 0.9rem;">
                                    <div>Direct: (555) 123-4567 ext. 101</div>
                                    <div>Email: peter.sloan@mainstreetpharmacy.com</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 24px; padding: 12px; background: #F9FAFB; border-radius: 6px; font-size: 0.85rem; color: #6B7280;">
                                <strong>Distribution:</strong> Original to Inspector; Copy to Pharmacy Owner; Copy retained in Inspection File
                            </div>
                        </div>
                    </div>
                `;
                
                // Show download section
                const downloadSection = document.getElementById('downloadSection');
                if (downloadSection) {
                    downloadSection.style.display = 'block';
                }
                
                // Scroll to top of container to show the document
                container.scrollTop = 0;
            }, 1500);
        }
        
        function editConsolidatedResponse() {
            const container = document.getElementById('allResponsesContainer');
            const contentDiv = container.querySelector('div');
            
            if (contentDiv) {
                // Make content editable
                contentDiv.contentEditable = 'true';
                contentDiv.style.outline = '2px dashed var(--primary)';
                contentDiv.style.padding = '32px';
                
                // Show save button, hide edit button
                document.getElementById('editConsolidatedBtn').style.display = 'none';
                document.getElementById('saveConsolidatedBtn').style.display = 'flex';
                
            }
        }
        
        function saveConsolidatedResponse() {
            const container = document.getElementById('allResponsesContainer');
            const contentDiv = container.querySelector('div');
            
            if (contentDiv) {
                // Make content non-editable
                contentDiv.contentEditable = 'false';
                contentDiv.style.outline = 'none';
                
                // Show edit button, hide save button
                document.getElementById('editConsolidatedBtn').style.display = 'flex';
                document.getElementById('saveConsolidatedBtn').style.display = 'none';
                
                showToast('✅ Changes saved successfully');
            }
        }
        
        function editResponseInReview(index) {
            const item = confirmedResponses[index];
            currentIssueData = { title: item.title, severity: item.severity };
            
            document.getElementById('previewIssueTitle').textContent = item.title;
            document.getElementById('generatedResponse').value = item.response;
            
            closeModal('allResponsesModal');
            openModal('responsePreviewModal');
        }
        
        // Step 8: Download Functions
        function downloadAsWord() {
            showToast('📄 Generating Word document...');
            
            setTimeout(() => {
                showToast('✅ Downloaded: Inspection_Response_Package.docx');
            }, 1500);
        }
        
        function downloadAsPDF() {
            showToast('📄 Generating PDF document...');
            
            setTimeout(() => {
                showToast('✅ Downloaded: Inspection_Response_Package.pdf');
                closeModal('allResponsesModal');
                
                // Show success message
                setTimeout(() => {
                    showToast('🎉 All responses completed! Your package is ready.');
                }, 500);
            }, 1500);
        }
        
        function downloadReport() {
            showToast('📄 Downloading full inspection report...');
            setTimeout(() => {
                showToast('✅ Report downloaded successfully!');
            }, 1000);
        }
        
        // Drag and drop support
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('reportDropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        // Simulate file input change
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        document.getElementById('reportFileInput').files = dataTransfer.files;
                        handleReportUpload({ target: { files: [file] } });
                    }
                });
            }
        });
    </script>
</body>
</html>